2025-08-16T21:34:50.1850489Z ##[group]Run pytest -q --cov=services
2025-08-16T21:34:50.1851073Z [36;1mpytest -q --cov=services[0m
2025-08-16T21:34:50.1900116Z shell: /usr/bin/bash -e {0}
2025-08-16T21:34:50.1900373Z env:
2025-08-16T21:34:50.1900554Z   PG_USER: postgres
2025-08-16T21:34:50.1900772Z   PG_PASSWORD: pass
2025-08-16T21:34:50.1900962Z   PG_DATABASE: awa
2025-08-16T21:34:50.1901167Z   PG_HOST: localhost
2025-08-16T21:34:50.1901368Z   PG_PORT: 5432
2025-08-16T21:34:50.1901816Z   PG_SYNC_DSN: ***localhost:5432/awa
2025-08-16T21:34:50.1902257Z   PG_ASYNC_DSN: ***localhost:5432/awa
2025-08-16T21:34:50.1902683Z   DATABASE_URL: ***localhost:5432/awa
2025-08-16T21:34:50.1902960Z   DATA_DIR: /home/runner/work/_temp/awa-data
2025-08-16T21:34:50.1903224Z   ENABLE_LIVE: 0
2025-08-16T21:34:50.1903404Z   TESTING: 1
2025-08-16T21:34:50.1903829Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-16T21:34:50.1904248Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib/pkgconfig
2025-08-16T21:34:50.1904655Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-16T21:34:50.1905060Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-16T21:34:50.1905423Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-16T21:34:50.1905795Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib
2025-08-16T21:34:50.1906112Z   POSTGRES_USER: postgres
2025-08-16T21:34:50.1906335Z   POSTGRES_PASSWORD: pass
2025-08-16T21:34:50.1906548Z   POSTGRES_DB: awa
2025-08-16T21:34:50.1906743Z   LLM_PROVIDER: lan
2025-08-16T21:34:50.1906957Z   LLM_BASE_URL: http://localhost:8000
2025-08-16T21:34:50.1907222Z ##[endgroup]
2025-08-16T21:34:59.8698925Z .....s.............................F.................................... [ 58%]
2025-08-16T21:35:31.2021143Z ...................................................                      [100%]
2025-08-16T21:35:31.2022425Z =================================== FAILURES ===================================
2025-08-16T21:35:31.2023324Z ____________________________ test_api_image_builds _____________________________
2025-08-16T21:35:31.2024412Z 
2025-08-16T21:35:31.2024904Z     @pytest.mark.skipif(shutil.which("docker") is None, reason="docker not available")
2025-08-16T21:35:31.2025638Z     def test_api_image_builds() -> None:
2025-08-16T21:35:31.2026150Z         env = {**os.environ, "DOCKER_BUILDKIT": "1"}
2025-08-16T21:35:31.2026571Z         try:
2025-08-16T21:35:31.2026955Z >           subprocess.check_call(
2025-08-16T21:35:31.2027385Z                 [
2025-08-16T21:35:31.2027757Z                     "docker",
2025-08-16T21:35:31.2028557Z                     "build",
2025-08-16T21:35:31.2029036Z                     "-q",
2025-08-16T21:35:31.2029387Z                     "-f",
2025-08-16T21:35:31.2029815Z                     "services/api/Dockerfile",
2025-08-16T21:35:31.2030290Z                     ".",
2025-08-16T21:35:31.2030672Z                     "-t",
2025-08-16T21:35:31.2031039Z                     IMAGE,
2025-08-16T21:35:31.2031432Z                 ],
2025-08-16T21:35:31.2031785Z                 cwd=ROOT,
2025-08-16T21:35:31.2032154Z                 env=env,
2025-08-16T21:35:31.2032517Z             )
2025-08-16T21:35:31.2032707Z 
2025-08-16T21:35:31.2032970Z tests/test_docker_build.py:20: 
2025-08-16T21:35:31.2033884Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-16T21:35:31.2034284Z 
2025-08-16T21:35:31.2034867Z popenargs = (['docker', 'build', '-q', '-f', 'services/api/Dockerfile', '.', ...],)
2025-08-16T21:35:31.2037176Z kwargs = {'cwd': PosixPath('/home/runner/work/AWA-App/AWA-App'), 'env': {'ACCEPT_EULA': 'Y', 'ACTIONS_RUNNER_ACTION_ARCHIVE_CAC...ctionarchivecache', 'AGENT_TOOLSDIRECTORY': '/opt/hostedtoolcache', 'ANDROID_HOME': '/usr/local/lib/android/sdk', ...}}
2025-08-16T21:35:31.2038865Z retcode = 1
2025-08-16T21:35:31.2039508Z cmd = ['docker', 'build', '-q', '-f', 'services/api/Dockerfile', '.', ...]
2025-08-16T21:35:31.2039983Z 
2025-08-16T21:35:31.2040234Z     def check_call(*popenargs, **kwargs):
2025-08-16T21:35:31.2041469Z         """Run command with arguments.  Wait for command to complete.  If
2025-08-16T21:35:31.2042254Z         the exit code was zero then return, otherwise raise
2025-08-16T21:35:31.2043162Z         CalledProcessError.  The CalledProcessError object will have the
2025-08-16T21:35:31.2044146Z         return code in the returncode attribute.
2025-08-16T21:35:31.2044652Z     
2025-08-16T21:35:31.2045205Z         The arguments are the same as for the call function.  Example:
2025-08-16T21:35:31.2045799Z     
2025-08-16T21:35:31.2046183Z         check_call(["ls", "-l"])
2025-08-16T21:35:31.2046641Z         """
2025-08-16T21:35:31.2047075Z         retcode = call(*popenargs, **kwargs)
2025-08-16T21:35:31.2047559Z         if retcode:
2025-08-16T21:35:31.2047986Z             cmd = kwargs.get("args")
2025-08-16T21:35:31.2048443Z             if cmd is None:
2025-08-16T21:35:31.2048918Z                 cmd = popenargs[0]
2025-08-16T21:35:31.2049526Z >           raise CalledProcessError(retcode, cmd)
2025-08-16T21:35:31.2051084Z E           subprocess.CalledProcessError: Command '['docker', 'build', '-q', '-f', 'services/api/Dockerfile', '.', '-t', 'awa-test:d037cdad']' returned non-zero exit status 1.
2025-08-16T21:35:31.2052057Z 
2025-08-16T21:35:31.2052776Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/subprocess.py:413: CalledProcessError
2025-08-16T21:35:31.2054094Z ----------------------------- Captured stderr call -----------------------------
2025-08-16T21:35:31.2056833Z ERROR: failed to build: failed to solve: process "/bin/sh -c sed -i 's|http://deb.debian.org|https://deb.debian.org|g' /etc/apt/sources.list     && apt-get update     && apt-get install -y --no-install-recommends tzdata postgresql-client curl     && rm -rf /var/lib/apt/lists/*" did not complete successfully: exit code: 2
2025-08-16T21:35:31.2059059Z Error response from daemon: No such image: awa-test:d037cdad
2025-08-16T21:35:31.2059902Z =============================== warnings summary ===============================
2025-08-16T21:35:31.2060624Z services/alert_bot/tests/test_smoke.py:5
2025-08-16T21:35:31.2063089Z   /home/runner/work/AWA-App/AWA-App/services/alert_bot/tests/test_smoke.py:5: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
2025-08-16T21:35:31.2065529Z     import pkg_resources  # noqa: F401
2025-08-16T21:35:31.2065872Z 
2025-08-16T21:35:31.2066261Z tests/test_api_fast.py::test_health_endpoint
2025-08-16T21:35:31.2068739Z   /home/runner/work/AWA-App/AWA-App/tests/test_api_fast.py:13: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-16T21:35:31.2070660Z     return datetime.datetime.utcnow()
2025-08-16T21:35:31.2071020Z 
2025-08-16T21:35:31.2071276Z tests/test_api_fast.py: 1 warning
2025-08-16T21:35:31.2071839Z tests/test_health.py: 5 warnings
2025-08-16T21:35:31.2072428Z tests/test_smoke.py: 5 warnings
2025-08-16T21:35:31.2073078Z services/api/tests/test_health.py: 1 warning
2025-08-16T21:35:31.2075436Z   /home/runner/work/AWA-App/AWA-App/services/api/routes/health.py:24: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-16T21:35:31.2077504Z     app_now = datetime.utcnow().replace(tzinfo=timezone.utc)
2025-08-16T21:35:31.2077950Z 
2025-08-16T21:35:31.2078245Z tests/test_health.py::test_health[0]
2025-08-16T21:35:31.2078831Z tests/test_health.py::test_health[1]
2025-08-16T21:35:31.2079422Z tests/test_health.py::test_health[2]
2025-08-16T21:35:31.2079991Z tests/test_health.py::test_health[3]
2025-08-16T21:35:31.2080650Z tests/test_health.py::test_health[4]
2025-08-16T21:35:31.2082778Z   /home/runner/work/AWA-App/AWA-App/tests/test_health.py:22: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-16T21:35:31.2085195Z     return datetime.datetime.utcnow()
2025-08-16T21:35:31.2085543Z 
2025-08-16T21:35:31.2085833Z tests/test_smoke.py::test_health[0]
2025-08-16T21:35:31.2086407Z tests/test_smoke.py::test_health[1]
2025-08-16T21:35:31.2086979Z tests/test_smoke.py::test_health[2]
2025-08-16T21:35:31.2087546Z tests/test_smoke.py::test_health[3]
2025-08-16T21:35:31.2088122Z tests/test_smoke.py::test_health[4]
2025-08-16T21:35:31.2090185Z   /home/runner/work/AWA-App/AWA-App/tests/test_smoke.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-16T21:35:31.2092075Z     return datetime.datetime.utcnow()
2025-08-16T21:35:31.2092441Z 
2025-08-16T21:35:31.2092820Z services/api/tests/test_health.py::test_health_route
2025-08-16T21:35:31.2095269Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_health.py:14: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-16T21:35:31.2097286Z     return datetime.datetime.utcnow()
2025-08-16T21:35:31.2097637Z 
2025-08-16T21:35:31.2098150Z -- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
2025-08-16T21:35:31.2099076Z ================================ tests coverage ================================
2025-08-16T21:35:31.2100167Z _______________ coverage: platform linux, python 3.12.11-final-0 _______________
2025-08-16T21:35:31.2100682Z 
2025-08-16T21:35:31.2100981Z Coverage XML written to file coverage.xml
2025-08-16T21:35:31.2101757Z Required test coverage of 45% reached. Total coverage: 58.64%
2025-08-16T21:35:31.2102633Z =========================== short test summary info ============================
2025-08-16T21:35:31.2104897Z FAILED tests/test_docker_build.py::test_api_image_builds - subprocess.CalledProcessError: Command '['docker', 'build', '-q', '-f', 'services/api/Dockerfile', '.', '-t', 'awa-test:d037cdad']' returned non-zero exit status 1.
2025-08-16T21:35:31.6893112Z ##[error]Process completed with exit code 1.
