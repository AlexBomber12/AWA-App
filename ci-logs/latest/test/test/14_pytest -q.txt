2025-08-18T17:27:38.8446189Z ##[group]Run pytest -q --cov=services
2025-08-18T17:27:38.8446785Z [36;1mpytest -q --cov=services[0m
2025-08-18T17:27:38.8499084Z shell: /usr/bin/bash -e {0}
2025-08-18T17:27:38.8499337Z env:
2025-08-18T17:27:38.8499544Z   REDIS_URL: redis://localhost:6379/0
2025-08-18T17:27:38.8499818Z   RATE_LIMIT_DEFAULT: 100/minute
2025-08-18T17:27:38.8500050Z   TRUST_X_FORWARDED: 1
2025-08-18T17:27:38.8500253Z   PG_USER: postgres
2025-08-18T17:27:38.8500448Z   PG_PASSWORD: pass
2025-08-18T17:27:38.8500639Z   PG_DATABASE: awa
2025-08-18T17:27:38.8500832Z   PG_HOST: localhost
2025-08-18T17:27:38.8501025Z   PG_PORT: 5432
2025-08-18T17:27:38.8501451Z   PG_SYNC_DSN: ***localhost:5432/awa
2025-08-18T17:27:38.8501867Z   PG_ASYNC_DSN: ***localhost:5432/awa
2025-08-18T17:27:38.8502253Z   DATABASE_URL: ***localhost:5432/awa
2025-08-18T17:27:38.8502512Z   DATA_DIR: /home/runner/work/_temp/awa-data
2025-08-18T17:27:38.8502765Z   ENABLE_LIVE: 0
2025-08-18T17:27:38.8502947Z   TESTING: 1
2025-08-18T17:27:38.8503190Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:38.8503627Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib/pkgconfig
2025-08-18T17:27:38.8504032Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:38.8504392Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:38.8504749Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:38.8505107Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib
2025-08-18T17:27:38.8505639Z   POSTGRES_USER: postgres
2025-08-18T17:27:38.8505876Z   POSTGRES_PASSWORD: pass
2025-08-18T17:27:38.8506089Z   POSTGRES_DB: awa
2025-08-18T17:27:38.8506277Z   LLM_PROVIDER: lan
2025-08-18T17:27:38.8506509Z   LLM_BASE_URL: http://localhost:8000
2025-08-18T17:27:38.8506760Z ##[endgroup]
2025-08-18T17:28:10.5510489Z .....FFFs.............................sssssss.....F..................... [ 47%]
2025-08-18T17:28:43.0669850Z ...............................F.F...................................... [ 94%]
2025-08-18T17:28:43.5241041Z ........                                                                 [100%]
2025-08-18T17:28:43.5241591Z =================================== FAILURES ===================================
2025-08-18T17:28:43.5242112Z ___________________________ test_ingest_file_upload ____________________________
2025-08-18T17:28:43.5242392Z 
2025-08-18T17:28:43.5242716Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f8a3103fb30>
2025-08-18T17:28:43.5243386Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_file_upload0')
2025-08-18T17:28:43.5244002Z 
2025-08-18T17:28:43.5244238Z     def test_ingest_file_upload(monkeypatch, tmp_path) -> None:
2025-08-18T17:28:43.5244819Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T17:28:43.5245713Z             return {"rows": 2, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T17:28:43.5246117Z     
2025-08-18T17:28:43.5246648Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T17:28:43.5247232Z         client = _get_client(monkeypatch)
2025-08-18T17:28:43.5247506Z     
2025-08-18T17:28:43.5247915Z >       resp = client.post("/ingest", files={"file": ("test.csv", b"a,b\n1,2\n")})
2025-08-18T17:28:43.5248385Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5248599Z 
2025-08-18T17:28:43.5248769Z tests/api/test_ingest_endpoints.py:33: 
2025-08-18T17:28:43.5249194Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5249916Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T17:28:43.5250469Z     return super().post(
2025-08-18T17:28:43.5251072Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T17:28:43.5251593Z     return self.request(
2025-08-18T17:28:43.5252554Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:43.5253382Z     return super().request(
2025-08-18T17:28:43.5254011Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:43.5254705Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:43.5255166Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5255935Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:43.5256498Z     response = self._send_handling_auth(
2025-08-18T17:28:43.5257209Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:43.5258141Z     response = self._send_handling_redirects(
2025-08-18T17:28:43.5258907Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:43.5259514Z     response = self._send_single_request(request)
2025-08-18T17:28:43.5259889Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5260516Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:43.5261085Z     response = transport.handle_request(request)
2025-08-18T17:28:43.5261391Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5262003Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:43.5262505Z     raise exc
2025-08-18T17:28:43.5263051Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:43.5263823Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:43.5264542Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:43.5265120Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:43.5265601Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5266140Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:43.5266601Z     return self.__get_result()
2025-08-18T17:28:43.5278859Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5279967Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:43.5280714Z     raise self._exception
2025-08-18T17:28:43.5281316Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:43.5281847Z     retval = await retval_or_awaitable
2025-08-18T17:28:43.5282128Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5282733Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:43.5283298Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:43.5283944Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:43.5284513Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5285194Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:43.5285957Z     raise exc
2025-08-18T17:28:43.5286557Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:43.5287119Z     await self.app(scope, receive, _send)
2025-08-18T17:28:43.5287765Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:43.5288369Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:43.5289070Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:43.5289910Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:43.5290650Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5291159Z     raise exc
2025-08-18T17:28:43.5291724Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5292280Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5292858Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:43.5293401Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5293999Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:43.5294503Z     await route.handle(scope, receive, send)
2025-08-18T17:28:43.5295088Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:43.5295710Z     await self.app(scope, receive, send)
2025-08-18T17:28:43.5296271Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:43.5296858Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:43.5297585Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5298097Z     raise exc
2025-08-18T17:28:43.5298655Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5299200Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5299750Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:43.5300225Z     response = await f(request)
2025-08-18T17:28:43.5300485Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5301007Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:43.5301514Z     solved_result = await solve_dependencies(
2025-08-18T17:28:43.5302211Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:43.5302821Z     solved = await call(**solved_result.values)
2025-08-18T17:28:43.5303257Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5303617Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5303827Z 
2025-08-18T17:28:43.5304090Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f8a30cb0590>
2025-08-18T17:28:43.5304582Z request = <starlette.requests.Request object at 0x7f8a2eb3f5f0>
2025-08-18T17:28:43.5305071Z response = <starlette.responses.Response object at 0x7f8a2eb3f980>
2025-08-18T17:28:43.5305441Z 
2025-08-18T17:28:43.5305657Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:43.5306036Z         if not FastAPILimiter.redis:
2025-08-18T17:28:43.5306533Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:43.5307140Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.5307438Z 
2025-08-18T17:28:43.5307880Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:43.5308563Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:43.5355208Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "60f24335ccfe4bd5ad7deb3efb958afb", "level": "error", "timestamp": "2025-08-18T17:27:44.519766Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f8a31033530>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f8a30d7bba0>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2ec672e0>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f8a310334a0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2ec672e0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+226", "header_value": "None", "validation_failed": "False", "id_value": "60f24335ccfe4bd5ad7deb3efb958afb", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f8a30cb0aa0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f8a2eb3f440>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a311748c0>", "conn": "<starlette.requests.Request object at 0x7f8a2eb3f440>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a311748c0>", "conn": "<starlette.requests.Request object at 0x7f8a2eb3f440>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a311748c0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a311748c0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f8a30d79260>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e6fa020>", "request": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>", "f": "<function get_request_handler.<locals>.app at 0x7f8a30d7a0c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e6fa020>", "conn": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e6fa020>", "conn": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a30d7bb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f8a30d7a0c0>", "request": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f8a2eb3f740>", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2eb3f8f0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31997230>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f8a2eb3f980>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31997230>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2eb3f8f0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a30cb0590>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f8a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a30cb0590>", "request": "<starlette.requests.Request object at 0x7f8a2eb3f5f0>", "response": "<starlette.responses.Response object at 0x7f8a2eb3f980>"}}]}]}
2025-08-18T17:28:43.5390895Z _____________________________ test_ingest_json_uri _____________________________
2025-08-18T17:28:43.5391154Z 
2025-08-18T17:28:43.5391432Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f8a2e7336e0>
2025-08-18T17:28:43.5392011Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_json_uri0')
2025-08-18T17:28:43.5392442Z 
2025-08-18T17:28:43.5392641Z     def test_ingest_json_uri(monkeypatch, tmp_path) -> None:
2025-08-18T17:28:43.5393141Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T17:28:43.5393680Z             return {"rows": 1, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T17:28:43.5394029Z     
2025-08-18T17:28:43.5394350Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T17:28:43.5394752Z         client = _get_client(monkeypatch)
2025-08-18T17:28:43.5394995Z     
2025-08-18T17:28:43.5395203Z         f = tmp_path / "sample.csv"
2025-08-18T17:28:43.5395582Z         f.write_text("a,b\n1,2\n")
2025-08-18T17:28:43.5395818Z     
2025-08-18T17:28:43.5396129Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T17:28:43.5396490Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5396674Z 
2025-08-18T17:28:43.5396828Z tests/api/test_ingest_endpoints.py:55: 
2025-08-18T17:28:43.5397216Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5397847Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T17:28:43.5398340Z     return super().post(
2025-08-18T17:28:43.5398870Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T17:28:43.5399343Z     return self.request(
2025-08-18T17:28:43.5399907Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:43.5400403Z     return super().request(
2025-08-18T17:28:43.5400940Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:43.5401548Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:43.5401956Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5402517Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:43.5403010Z     response = self._send_handling_auth(
2025-08-18T17:28:43.5403639Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:43.5404197Z     response = self._send_handling_redirects(
2025-08-18T17:28:43.5404858Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:43.5405860Z     response = self._send_single_request(request)
2025-08-18T17:28:43.5406204Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5406832Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:43.5407402Z     response = transport.handle_request(request)
2025-08-18T17:28:43.5407718Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5408345Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:43.5408852Z     raise exc
2025-08-18T17:28:43.5409415Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:43.5409981Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:43.5410575Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:43.5411167Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:43.5413331Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5414291Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:449: in result
2025-08-18T17:28:43.5415099Z     return self.__get_result()
2025-08-18T17:28:43.5416040Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5416891Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:43.5417384Z     raise self._exception
2025-08-18T17:28:43.5417964Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:43.5418486Z     retval = await retval_or_awaitable
2025-08-18T17:28:43.5418759Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5419354Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:43.5419903Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:43.5420521Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:43.5421074Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5421725Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:43.5422230Z     raise exc
2025-08-18T17:28:43.5422782Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:43.5423315Z     await self.app(scope, receive, _send)
2025-08-18T17:28:43.5423942Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:43.5424535Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:43.5425220Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:43.5426112Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:43.5426853Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5427352Z     raise exc
2025-08-18T17:28:43.5427910Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5428444Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5429012Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:43.5429541Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5430126Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:43.5430816Z     await route.handle(scope, receive, send)
2025-08-18T17:28:43.5431405Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:43.5431905Z     await self.app(scope, receive, send)
2025-08-18T17:28:43.5432461Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:43.5433042Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:43.5433766Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5434266Z     raise exc
2025-08-18T17:28:43.5434850Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5435574Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5436136Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:43.5436612Z     response = await f(request)
2025-08-18T17:28:43.5436862Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5437375Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:43.5437870Z     solved_result = await solve_dependencies(
2025-08-18T17:28:43.5438562Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:43.5439299Z     solved = await call(**solved_result.values)
2025-08-18T17:28:43.5439601Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5439957Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5440169Z 
2025-08-18T17:28:43.5440436Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f8a2e774a70>
2025-08-18T17:28:43.5440934Z request = <starlette.requests.Request object at 0x7f8a2e50ef30>
2025-08-18T17:28:43.5441437Z response = <starlette.responses.Response object at 0x7f8a2e50f1d0>
2025-08-18T17:28:43.5441705Z 
2025-08-18T17:28:43.5441910Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:43.5442275Z         if not FastAPILimiter.redis:
2025-08-18T17:28:43.5442765Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:43.5443360Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.5443653Z 
2025-08-18T17:28:43.5444095Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:43.5444744Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:43.5490699Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "3dd489a0a3b642c9a74eca413dad349e", "level": "error", "timestamp": "2025-08-18T17:27:45.093576Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f8a2e50ed20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f8a30d7b560>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e781c60>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f8a2e50eed0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e781c60>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "3dd489a0a3b642c9a74eca413dad349e", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f8a2e50eb40>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f8a2e50ede0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a30cefc50>", "conn": "<starlette.requests.Request object at 0x7f8a2e50ede0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a30cefc50>", "conn": "<starlette.requests.Request object at 0x7f8a2e50ede0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a30cefc50>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a30cefc50>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f8a2e4b6980>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e782200>", "request": "<starlette.requests.Request object at 0x7f8a2e50ef30>", "f": "<function get_request_handler.<locals>.app at 0x7f8a2e4b7ce0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e782200>", "conn": "<starlette.requests.Request object at 0x7f8a2e50ef30>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e782200>", "conn": "<starlette.requests.Request object at 0x7f8a2e50ef30>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e75f2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f8a2e4b7ce0>", "request": "<starlette.requests.Request object at 0x7f8a2e50ef30>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e50ef30>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e50f080>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e50f1a0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a30e8cb30>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e50ef30>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f8a2e50f1d0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a30e8cb30>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e50f1a0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a2e774a70>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f8a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a2e774a70>", "request": "<starlette.requests.Request object at 0x7f8a2e50ef30>", "response": "<starlette.responses.Response object at 0x7f8a2e50f1d0>"}}]}]}
2025-08-18T17:28:43.5524861Z _____________________________ test_ingest_failure ______________________________
2025-08-18T17:28:43.5525107Z 
2025-08-18T17:28:43.5525550Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f8a2ebef0b0>
2025-08-18T17:28:43.5526121Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_failure0')
2025-08-18T17:28:43.5526415Z 
2025-08-18T17:28:43.5526595Z     def test_ingest_failure(monkeypatch, tmp_path) -> None:
2025-08-18T17:28:43.5527081Z         def bad_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T17:28:43.5527491Z             raise RuntimeError("boom")
2025-08-18T17:28:43.5527728Z     
2025-08-18T17:28:43.5528037Z         monkeypatch.setattr("etl.load_csv.import_file", bad_import_file)
2025-08-18T17:28:43.5528427Z         client = _get_client(monkeypatch)
2025-08-18T17:28:43.5528779Z         from services.ingest.celery_app import celery_app
2025-08-18T17:28:43.5529051Z     
2025-08-18T17:28:43.5529290Z         celery_app.conf.task_eager_propagates = False
2025-08-18T17:28:43.5529556Z     
2025-08-18T17:28:43.5529746Z         f = tmp_path / "bad.csv"
2025-08-18T17:28:43.5530010Z         f.write_text("a,b\n1,2\n")
2025-08-18T17:28:43.5530241Z     
2025-08-18T17:28:43.5530546Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T17:28:43.5530903Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5531215Z 
2025-08-18T17:28:43.5531371Z tests/api/test_ingest_endpoints.py:77: 
2025-08-18T17:28:43.5531747Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5532362Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T17:28:43.5532847Z     return super().post(
2025-08-18T17:28:43.5533367Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T17:28:43.5533819Z     return self.request(
2025-08-18T17:28:43.5534364Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:43.5534842Z     return super().request(
2025-08-18T17:28:43.5535470Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:43.5536072Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:43.5536481Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5537029Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:43.5537507Z     response = self._send_handling_auth(
2025-08-18T17:28:43.5538110Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:43.5538779Z     response = self._send_handling_redirects(
2025-08-18T17:28:43.5539417Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:43.5539979Z     response = self._send_single_request(request)
2025-08-18T17:28:43.5540285Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5540892Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:43.5541448Z     response = transport.handle_request(request)
2025-08-18T17:28:43.5541750Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5542357Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:43.5542851Z     raise exc
2025-08-18T17:28:43.5543394Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:43.5543949Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:43.5544533Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:43.5545110Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:43.5545590Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5546133Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:43.5546595Z     return self.__get_result()
2025-08-18T17:28:43.5546838Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5547360Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:43.5547814Z     raise self._exception
2025-08-18T17:28:43.5548378Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:43.5548891Z     retval = await retval_or_awaitable
2025-08-18T17:28:43.5549170Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5549745Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:43.5550280Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:43.5550896Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:43.5551452Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5552242Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:43.5552742Z     raise exc
2025-08-18T17:28:43.5553296Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:43.5553837Z     await self.app(scope, receive, _send)
2025-08-18T17:28:43.5554476Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:43.5555076Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:43.5555866Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:43.5556533Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:43.5557271Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5557789Z     raise exc
2025-08-18T17:28:43.5558355Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5558900Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5559472Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:43.5560010Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5560740Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:43.5561244Z     await route.handle(scope, receive, send)
2025-08-18T17:28:43.5561821Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:43.5562313Z     await self.app(scope, receive, send)
2025-08-18T17:28:43.5562868Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:43.5563456Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:43.5564192Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5564693Z     raise exc
2025-08-18T17:28:43.5565259Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5566014Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5566565Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:43.5567035Z     response = await f(request)
2025-08-18T17:28:43.5567283Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5567799Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:43.5568295Z     solved_result = await solve_dependencies(
2025-08-18T17:28:43.5568979Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:43.5569590Z     solved = await call(**solved_result.values)
2025-08-18T17:28:43.5569888Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5570242Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5570449Z 
2025-08-18T17:28:43.5570708Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f8a30d0e3c0>
2025-08-18T17:28:43.5571203Z request = <starlette.requests.Request object at 0x7f8a2e778b00>
2025-08-18T17:28:43.5571694Z response = <starlette.responses.Response object at 0x7f8a2e778da0>
2025-08-18T17:28:43.5571952Z 
2025-08-18T17:28:43.5572149Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:43.5572505Z         if not FastAPILimiter.redis:
2025-08-18T17:28:43.5572988Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:43.5573702Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.5573994Z 
2025-08-18T17:28:43.5574421Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:43.5575057Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:43.5620392Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "7e9521135af849fa94474465afcbaf4f", "level": "error", "timestamp": "2025-08-18T17:27:45.608809Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f8a2e7788f0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f8a2e6d3560>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a30d1d620>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f8a2e778aa0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a30d1d620>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "7e9521135af849fa94474465afcbaf4f", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f8a2e778590>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f8a2e7789b0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a2e774350>", "conn": "<starlette.requests.Request object at 0x7f8a2e7789b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a2e774350>", "conn": "<starlette.requests.Request object at 0x7f8a2e7789b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a2e774350>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a2e774350>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f8a2e6fa020>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a30deb420>", "request": "<starlette.requests.Request object at 0x7f8a2e778b00>", "f": "<function get_request_handler.<locals>.app at 0x7f8a30d7b060>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a30deb420>", "conn": "<starlette.requests.Request object at 0x7f8a2e778b00>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a30deb420>", "conn": "<starlette.requests.Request object at 0x7f8a2e778b00>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e6f9f80'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f8a30d7b060>", "request": "<starlette.requests.Request object at 0x7f8a2e778b00>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e778b00>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e778c50>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e778d70>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a2e731fa0>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e778b00>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f8a2e778da0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a2e731fa0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e778d70>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a30d0e3c0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f8a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a30d0e3c0>", "request": "<starlette.requests.Request object at 0x7f8a2e778b00>", "response": "<starlette.responses.Response object at 0x7f8a2e778da0>"}}]}]}
2025-08-18T17:28:43.5654929Z _____________________________ test_health_endpoint _____________________________
2025-08-18T17:28:43.5655182Z 
2025-08-18T17:28:43.5655537Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f8a2e85a5a0>
2025-08-18T17:28:43.5655836Z 
2025-08-18T17:28:43.5655966Z     def test_health_endpoint(monkeypatch):
2025-08-18T17:28:43.5656345Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T17:28:43.5656694Z         client = TestClient(app)
2025-08-18T17:28:43.5656972Z >       r = client.get("/health")
2025-08-18T17:28:43.5657223Z             ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5657368Z 
2025-08-18T17:28:43.5657479Z tests/test_api_fast.py:25: 
2025-08-18T17:28:43.5657820Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5658428Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T17:28:43.5658902Z     return super().get(
2025-08-18T17:28:43.5659410Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T17:28:43.5659865Z     return self.request(
2025-08-18T17:28:43.5660418Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:43.5661042Z     return super().request(
2025-08-18T17:28:43.5661564Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:43.5662158Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:43.5662560Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5663106Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:43.5663592Z     response = self._send_handling_auth(
2025-08-18T17:28:43.5664198Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:43.5664736Z     response = self._send_handling_redirects(
2025-08-18T17:28:43.5665470Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:43.5666060Z     response = self._send_single_request(request)
2025-08-18T17:28:43.5666370Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5666972Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:43.5667524Z     response = transport.handle_request(request)
2025-08-18T17:28:43.5667826Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5668432Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:43.5668927Z     raise exc
2025-08-18T17:28:43.5669475Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:43.5670021Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:43.5670593Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:43.5671168Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:43.5671541Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5672082Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:449: in result
2025-08-18T17:28:43.5672543Z     return self.__get_result()
2025-08-18T17:28:43.5672786Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5673309Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:43.5673898Z     raise self._exception
2025-08-18T17:28:43.5674444Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:43.5674958Z     retval = await retval_or_awaitable
2025-08-18T17:28:43.5675228Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5675896Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:43.5676435Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:43.5677044Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:43.5677594Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5678254Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:43.5678751Z     raise exc
2025-08-18T17:28:43.5679303Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:43.5679848Z     await self.app(scope, receive, _send)
2025-08-18T17:28:43.5680479Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:43.5681080Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:43.5681770Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:43.5682560Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:43.5683291Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5683788Z     raise exc
2025-08-18T17:28:43.5684346Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5684891Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5685662Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:43.5686208Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5686794Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:43.5687293Z     await route.handle(scope, receive, send)
2025-08-18T17:28:43.5687872Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:43.5688365Z     await self.app(scope, receive, send)
2025-08-18T17:28:43.5688921Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:43.5689503Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:43.5690227Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5690734Z     raise exc
2025-08-18T17:28:43.5691291Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5691828Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5692364Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:43.5692834Z     response = await f(request)
2025-08-18T17:28:43.5693085Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5693597Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:43.5694091Z     solved_result = await solve_dependencies(
2025-08-18T17:28:43.5694785Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:43.5695478Z     solved = await call(**solved_result.values)
2025-08-18T17:28:43.5695782Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5696270Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5696483Z 
2025-08-18T17:28:43.5696734Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>
2025-08-18T17:28:43.5697222Z request = <starlette.requests.Request object at 0x7f8a2e7e6870>
2025-08-18T17:28:43.5697707Z response = <starlette.responses.Response object at 0x7f8a2e7e6c90>
2025-08-18T17:28:43.5697976Z 
2025-08-18T17:28:43.5698168Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:43.5698520Z         if not FastAPILimiter.redis:
2025-08-18T17:28:43.5698997Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:43.5699580Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.5699861Z 
2025-08-18T17:28:43.5700290Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:43.5700937Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:43.5746560Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "33a6f27a9c68420fae251ae703d9aa22", "level": "error", "timestamp": "2025-08-18T17:27:46.373418Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f8a2e7e6c30>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f8a2e7f8680>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e85d940>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f8a2e7e6810>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e85d940>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "33a6f27a9c68420fae251ae703d9aa22", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f8a2e7e6f00>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f8a2e7e6960>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "conn": "<starlette.requests.Request object at 0x7f8a2e7e6960>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "conn": "<starlette.requests.Request object at 0x7f8a2e7e6960>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f8a422aac00>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e85dee0>", "request": "<starlette.requests.Request object at 0x7f8a2e7e6870>", "f": "<function get_request_handler.<locals>.app at 0x7f8a30fa4ea0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e85dee0>", "conn": "<starlette.requests.Request object at 0x7f8a2e7e6870>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e85dee0>", "conn": "<starlette.requests.Request object at 0x7f8a2e7e6870>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a32497ba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f8a30fa4ea0>", "request": "<starlette.requests.Request object at 0x7f8a2e7e6870>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e7e6870>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e7e6bd0>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e7e4050>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31174e90>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e7e6870>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f8a2e7e6c90>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31174e90>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e7e4050>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f8a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "request": "<starlette.requests.Request object at 0x7f8a2e7e6870>", "response": "<starlette.responses.Response object at 0x7f8a2e7e6c90>"}}]}]}
2025-08-18T17:28:43.5780627Z __________________________ test_validation_error_json __________________________
2025-08-18T17:28:43.5780896Z 
2025-08-18T17:28:43.5781183Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T17:28:43.5781627Z disable_decoding = False, timeout = None
2025-08-18T17:28:43.5781817Z 
2025-08-18T17:28:43.5781911Z     async def read_response(
2025-08-18T17:28:43.5782134Z         self,
2025-08-18T17:28:43.5782355Z         disable_decoding: bool = False,
2025-08-18T17:28:43.5782793Z         timeout: Optional[float] = None,
2025-08-18T17:28:43.5783035Z         *,
2025-08-18T17:28:43.5783255Z         disconnect_on_error: bool = True,
2025-08-18T17:28:43.5783556Z         push_request: Optional[bool] = False,
2025-08-18T17:28:43.5783807Z     ):
2025-08-18T17:28:43.5784069Z         """Read the response from a previously sent command"""
2025-08-18T17:28:43.5784506Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T17:28:43.5784880Z         host_error = self._host_error()
2025-08-18T17:28:43.5785127Z         try:
2025-08-18T17:28:43.5785399Z             if (
2025-08-18T17:28:43.5785627Z                 read_timeout is not None
2025-08-18T17:28:43.5785914Z                 and self.protocol in ["3", 3]
2025-08-18T17:28:43.5786199Z                 and not HIREDIS_AVAILABLE
2025-08-18T17:28:43.5786438Z             ):
2025-08-18T17:28:43.5786686Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:43.5787040Z                     response = await self._parser.read_response(
2025-08-18T17:28:43.5787463Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:43.5787793Z                     )
2025-08-18T17:28:43.5788027Z             elif read_timeout is not None:
2025-08-18T17:28:43.5788343Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:43.5788685Z                     response = await self._parser.read_response(
2025-08-18T17:28:43.5789026Z                         disable_decoding=disable_decoding
2025-08-18T17:28:43.5789294Z                     )
2025-08-18T17:28:43.5789597Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T17:28:43.5789977Z                 response = await self._parser.read_response(
2025-08-18T17:28:43.5790379Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:43.5790700Z                 )
2025-08-18T17:28:43.5790883Z             else:
2025-08-18T17:28:43.5791172Z >               response = await self._parser.read_response(
2025-08-18T17:28:43.5791502Z                     disable_decoding=disable_decoding
2025-08-18T17:28:43.5791758Z                 )
2025-08-18T17:28:43.5791865Z 
2025-08-18T17:28:43.5792276Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:542: 
2025-08-18T17:28:43.5792860Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5793503Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T17:28:43.5794321Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T17:28:43.5794724Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5795441Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T17:28:43.5795979Z     raw = await self._readline()
2025-08-18T17:28:43.5796239Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5796819Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T17:28:43.5797347Z     data = await self._stream.readline()
2025-08-18T17:28:43.5797625Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5798125Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T17:28:43.5798576Z     line = await self.readuntil(sep)
2025-08-18T17:28:43.5798849Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5799341Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T17:28:43.5799800Z     await self._wait_for_data('readuntil')
2025-08-18T17:28:43.5800174Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5800386Z 
2025-08-18T17:28:43.5800651Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=22>>
2025-08-18T17:28:43.5801150Z func_name = 'readuntil'
2025-08-18T17:28:43.5801286Z 
2025-08-18T17:28:43.5801420Z     async def _wait_for_data(self, func_name):
2025-08-18T17:28:43.5801753Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T17:28:43.5802021Z     
2025-08-18T17:28:43.5802260Z         If stream was paused, automatically resume it.
2025-08-18T17:28:43.5802533Z         """
2025-08-18T17:28:43.5802849Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T17:28:43.5803318Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T17:28:43.5803764Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T17:28:43.5804149Z         # which coroutine would get the next data.
2025-08-18T17:28:43.5804445Z         if self._waiter is not None:
2025-08-18T17:28:43.5804708Z             raise RuntimeError(
2025-08-18T17:28:43.5805024Z                 f'{func_name}() called while another coroutine is '
2025-08-18T17:28:43.5805641Z                 f'already waiting for incoming data')
2025-08-18T17:28:43.5806069Z     
2025-08-18T17:28:43.5806397Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T17:28:43.5806670Z     
2025-08-18T17:28:43.5806960Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T17:28:43.5807422Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T17:28:43.5807764Z         if self._paused:
2025-08-18T17:28:43.5808006Z             self._paused = False
2025-08-18T17:28:43.5808279Z             self._transport.resume_reading()
2025-08-18T17:28:43.5808526Z     
2025-08-18T17:28:43.5808747Z         self._waiter = self._loop.create_future()
2025-08-18T17:28:43.5809012Z         try:
2025-08-18T17:28:43.5809229Z >           await self._waiter
2025-08-18T17:28:43.5811131Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T17:28:43.5812538Z 
2025-08-18T17:28:43.5812885Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T17:28:43.5813233Z 
2025-08-18T17:28:43.5813478Z During handling of the above exception, another exception occurred:
2025-08-18T17:28:43.5813893Z 
2025-08-18T17:28:43.5814030Z     def test_validation_error_json() -> None:
2025-08-18T17:28:43.5814355Z         prev_user = os.environ.get("BASIC_USER")
2025-08-18T17:28:43.5814672Z         prev_pass = os.environ.get("BASIC_PASS")
2025-08-18T17:28:43.5814989Z         os.environ["ROI_BASIC_AUTH_USER"] = "u"
2025-08-18T17:28:43.5815558Z         os.environ["ROI_BASIC_AUTH_PASSWORD"] = "p"
2025-08-18T17:28:43.5815898Z         os.environ["BASIC_USER"] = "u"
2025-08-18T17:28:43.5816180Z         os.environ["BASIC_PASS"] = "p"
2025-08-18T17:28:43.5816416Z         try:
2025-08-18T17:28:43.5816632Z             client = TestClient(app)
2025-08-18T17:28:43.5816927Z             auth = base64.b64encode(b"u:p").decode()
2025-08-18T17:28:43.5817234Z >           resp = client.get(
2025-08-18T17:28:43.5817604Z                 "/roi-review?vendor=abc", headers={"Authorization": f"Basic {auth}"}
2025-08-18T17:28:43.5817941Z             )
2025-08-18T17:28:43.5818057Z 
2025-08-18T17:28:43.5818211Z services/api/tests/test_errors_json.py:21: 
2025-08-18T17:28:43.5818589Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5819200Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T17:28:43.5819678Z     return super().get(
2025-08-18T17:28:43.5820187Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T17:28:43.5820779Z     return self.request(
2025-08-18T17:28:43.5821330Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:43.5821816Z     return super().request(
2025-08-18T17:28:43.5822340Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:43.5822934Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:43.5823340Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5823918Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:43.5824411Z     response = self._send_handling_auth(
2025-08-18T17:28:43.5825028Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:43.5825683Z     response = self._send_handling_redirects(
2025-08-18T17:28:43.5826333Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:43.5826909Z     response = self._send_single_request(request)
2025-08-18T17:28:43.5827214Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5827829Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:43.5828389Z     response = transport.handle_request(request)
2025-08-18T17:28:43.5828698Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5829309Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:43.5829804Z     raise exc
2025-08-18T17:28:43.5830354Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:43.5830913Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:43.5831497Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:43.5832074Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:43.5832452Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5832995Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:43.5833456Z     return self.__get_result()
2025-08-18T17:28:43.5833860Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5834400Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:43.5834866Z     raise self._exception
2025-08-18T17:28:43.5835520Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:43.5836039Z     retval = await retval_or_awaitable
2025-08-18T17:28:43.5836316Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5836907Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:43.5837450Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:43.5838074Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:43.5838638Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5839298Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:43.5839804Z     raise exc
2025-08-18T17:28:43.5840379Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:43.5840931Z     await self.app(scope, receive, _send)
2025-08-18T17:28:43.5841574Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:43.5842308Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:43.5843009Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:43.5843680Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:43.5844424Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5844932Z     raise exc
2025-08-18T17:28:43.5845701Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5846263Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5846841Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:43.5847381Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.5847981Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:43.5848491Z     await route.handle(scope, receive, send)
2025-08-18T17:28:43.5849071Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:43.5849572Z     await self.app(scope, receive, send)
2025-08-18T17:28:43.5850140Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:43.5850733Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:43.5851469Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.5851979Z     raise exc
2025-08-18T17:28:43.5852545Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.5853091Z     await app(scope, receive, sender)
2025-08-18T17:28:43.5853643Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:43.5854123Z     response = await f(request)
2025-08-18T17:28:43.5854369Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5854884Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:43.5855567Z     solved_result = await solve_dependencies(
2025-08-18T17:28:43.5856266Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:43.5857005Z     solved = await call(**solved_result.values)
2025-08-18T17:28:43.5857302Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5857895Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T17:28:43.5858416Z     pexpire = await self._check(key)
2025-08-18T17:28:43.5858683Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5859257Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T17:28:43.5859771Z     pexpire = await redis.evalsha(
2025-08-18T17:28:43.5860391Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:615: in execute_command
2025-08-18T17:28:43.5860944Z     return await conn.retry.call_with_retry(
2025-08-18T17:28:43.5861567Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T17:28:43.5862069Z     return await do()
2025-08-18T17:28:43.5862269Z            ^^^^^^^^^^
2025-08-18T17:28:43.5862899Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:589: in _send_command_parse_response
2025-08-18T17:28:43.5863577Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T17:28:43.5863952Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5864936Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:636: in parse_response
2025-08-18T17:28:43.5865609Z     response = await connection.read_response()
2025-08-18T17:28:43.5865917Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5866543Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: in read_response
2025-08-18T17:28:43.5867096Z     await self.disconnect(nowait=True)
2025-08-18T17:28:43.5867718Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:418: in disconnect
2025-08-18T17:28:43.5868296Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T17:28:43.5868578Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5869028Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T17:28:43.5869464Z     return self._transport.close()
2025-08-18T17:28:43.5869724Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.5870242Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T17:28:43.5870673Z     super().close()
2025-08-18T17:28:43.5871143Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T17:28:43.5871661Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T17:28:43.5872230Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T17:28:43.5872665Z     self._check_closed()
2025-08-18T17:28:43.5872995Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.5873207Z 
2025-08-18T17:28:43.5873460Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T17:28:43.5873730Z 
2025-08-18T17:28:43.5873821Z     def _check_closed(self):
2025-08-18T17:28:43.5874049Z         if self._closed:
2025-08-18T17:28:43.5874344Z >           raise RuntimeError('Event loop is closed')
2025-08-18T17:28:43.5874697Z E           RuntimeError: Event loop is closed
2025-08-18T17:28:43.5874880Z 
2025-08-18T17:28:43.5875246Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T17:28:43.5876210Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:43.5949633Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "8f0a2bf9feca432eba97e2fcb2f8fb66", "level": "error", "timestamp": "2025-08-18T17:28:41.104624Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f8a2e7e6c30>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f8a2e64bf60>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e5c8ae0>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f8a2e5b5b50>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e5c8ae0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+150", "header_value": "None", "validation_failed": "False", "id_value": "8f0a2bf9feca432eba97e2fcb2f8fb66", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f8a2e7e6f00>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f8a2e618c20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "conn": "<starlette.requests.Request object at 0x7f8a2e618c20>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "conn": "<starlette.requests.Request object at 0x7f8a2e618c20>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function roi_review at 0x7f8a422ab880>, 'path_params': {}, 'route'\"+67"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e5c8540>", "request": "<starlette.requests.Request object at 0x7f8a2e618d70>", "f": "<function get_request_handler.<locals>.app at 0x7f8a30fa42c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e5c8540>", "conn": "<starlette.requests.Request object at 0x7f8a2e618d70>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e5c8540>", "conn": "<starlette.requests.Request object at 0x7f8a2e618d70>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e64bec0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f8a30fa42c0>", "request": "<starlette.requests.Request object at 0x7f8a2e618d70>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e618d70>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e618ec0>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e23e660>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31174e90>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "False", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e618d70>", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f8a2e5b5c10>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31174e90>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e23e660>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "use_path": "/roi-review", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f8a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "request": "<starlette.requests.Request object at 0x7f8a2e618d70>", "response": "<starlette.responses.Response object at 0x7f8a2e5b5c10>", "route_index": "8", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f8a3116ab60>", "callback": "<function http_default_callback at 0x7f8a31a1f6a0>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:8:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "key": "fastapi-limiter:testclient:8:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 615, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f8a2dcb7600>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f8a2e64bd80>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f8a2e64bc40>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 589, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 636, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 418, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=22> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=22>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=22>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 542, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f8a2e265710>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f8a2e265710>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f8a2e265710>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=22>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=22>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=22>>", "func_name": "readuntil"}}]}]}
2025-08-18T17:28:43.6004238Z ______________________________ test_health_route _______________________________
2025-08-18T17:28:43.6004486Z 
2025-08-18T17:28:43.6004772Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T17:28:43.6005208Z disable_decoding = False, timeout = None
2025-08-18T17:28:43.6005574Z 
2025-08-18T17:28:43.6005674Z     async def read_response(
2025-08-18T17:28:43.6005902Z         self,
2025-08-18T17:28:43.6006129Z         disable_decoding: bool = False,
2025-08-18T17:28:43.6006429Z         timeout: Optional[float] = None,
2025-08-18T17:28:43.6006673Z         *,
2025-08-18T17:28:43.6006886Z         disconnect_on_error: bool = True,
2025-08-18T17:28:43.6007185Z         push_request: Optional[bool] = False,
2025-08-18T17:28:43.6007430Z     ):
2025-08-18T17:28:43.6007694Z         """Read the response from a previously sent command"""
2025-08-18T17:28:43.6008128Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T17:28:43.6008505Z         host_error = self._host_error()
2025-08-18T17:28:43.6008745Z         try:
2025-08-18T17:28:43.6008920Z             if (
2025-08-18T17:28:43.6009144Z                 read_timeout is not None
2025-08-18T17:28:43.6009434Z                 and self.protocol in ["3", 3]
2025-08-18T17:28:43.6009720Z                 and not HIREDIS_AVAILABLE
2025-08-18T17:28:43.6010108Z             ):
2025-08-18T17:28:43.6010356Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:43.6010703Z                     response = await self._parser.read_response(
2025-08-18T17:28:43.6011114Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:43.6011443Z                     )
2025-08-18T17:28:43.6011685Z             elif read_timeout is not None:
2025-08-18T17:28:43.6012001Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:43.6012344Z                     response = await self._parser.read_response(
2025-08-18T17:28:43.6012683Z                         disable_decoding=disable_decoding
2025-08-18T17:28:43.6012944Z                     )
2025-08-18T17:28:43.6013245Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T17:28:43.6013624Z                 response = await self._parser.read_response(
2025-08-18T17:28:43.6014025Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:43.6014351Z                 )
2025-08-18T17:28:43.6014536Z             else:
2025-08-18T17:28:43.6014824Z >               response = await self._parser.read_response(
2025-08-18T17:28:43.6015156Z                     disable_decoding=disable_decoding
2025-08-18T17:28:43.6015611Z                 )
2025-08-18T17:28:43.6015728Z 
2025-08-18T17:28:43.6016136Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:542: 
2025-08-18T17:28:43.6016854Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.6017497Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T17:28:43.6018133Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T17:28:43.6018535Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6019165Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T17:28:43.6019694Z     raw = await self._readline()
2025-08-18T17:28:43.6019946Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6020502Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T17:28:43.6021018Z     data = await self._stream.readline()
2025-08-18T17:28:43.6021303Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6021794Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T17:28:43.6022233Z     line = await self.readuntil(sep)
2025-08-18T17:28:43.6022497Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6022984Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T17:28:43.6023439Z     await self._wait_for_data('readuntil')
2025-08-18T17:28:43.6023811Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.6024023Z 
2025-08-18T17:28:43.6024284Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=18>>
2025-08-18T17:28:43.6024653Z func_name = 'readuntil'
2025-08-18T17:28:43.6024789Z 
2025-08-18T17:28:43.6024921Z     async def _wait_for_data(self, func_name):
2025-08-18T17:28:43.6025251Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T17:28:43.6025624Z     
2025-08-18T17:28:43.6025864Z         If stream was paused, automatically resume it.
2025-08-18T17:28:43.6026131Z         """
2025-08-18T17:28:43.6026441Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T17:28:43.6026893Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T17:28:43.6027337Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T17:28:43.6027718Z         # which coroutine would get the next data.
2025-08-18T17:28:43.6028139Z         if self._waiter is not None:
2025-08-18T17:28:43.6028408Z             raise RuntimeError(
2025-08-18T17:28:43.6028725Z                 f'{func_name}() called while another coroutine is '
2025-08-18T17:28:43.6029070Z                 f'already waiting for incoming data')
2025-08-18T17:28:43.6029323Z     
2025-08-18T17:28:43.6029563Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T17:28:43.6029827Z     
2025-08-18T17:28:43.6030116Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T17:28:43.6030578Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T17:28:43.6030909Z         if self._paused:
2025-08-18T17:28:43.6031144Z             self._paused = False
2025-08-18T17:28:43.6031419Z             self._transport.resume_reading()
2025-08-18T17:28:43.6031664Z     
2025-08-18T17:28:43.6031884Z         self._waiter = self._loop.create_future()
2025-08-18T17:28:43.6032142Z         try:
2025-08-18T17:28:43.6032356Z >           await self._waiter
2025-08-18T17:28:43.6034242Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T17:28:43.6035842Z 
2025-08-18T17:28:43.6036198Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T17:28:43.6036536Z 
2025-08-18T17:28:43.6036784Z During handling of the above exception, another exception occurred:
2025-08-18T17:28:43.6037043Z 
2025-08-18T17:28:43.6037161Z     def test_health_route() -> None:
2025-08-18T17:28:43.6037412Z         class FakeSession:
2025-08-18T17:28:43.6037668Z             async def execute(self, query):
2025-08-18T17:28:43.6037928Z                 class R:
2025-08-18T17:28:43.6038161Z                     def scalar(self):
2025-08-18T17:28:43.6038427Z                         import datetime
2025-08-18T17:28:43.6038657Z     
2025-08-18T17:28:43.6038887Z                         return datetime.datetime.utcnow()
2025-08-18T17:28:43.6039148Z     
2025-08-18T17:28:43.6039314Z                 return R()
2025-08-18T17:28:43.6039510Z     
2025-08-18T17:28:43.6039704Z         async def fake_get_session():
2025-08-18T17:28:43.6039986Z             yield FakeSession()
2025-08-18T17:28:43.6040199Z     
2025-08-18T17:28:43.6040480Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T17:28:43.6040829Z         client = TestClient(app)
2025-08-18T17:28:43.6041115Z >       resp = client.get("/health")
2025-08-18T17:28:43.6041375Z                ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6041527Z 
2025-08-18T17:28:43.6041672Z services/api/tests/test_health.py:23: 
2025-08-18T17:28:43.6042040Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.6042659Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T17:28:43.6043138Z     return super().get(
2025-08-18T17:28:43.6043648Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T17:28:43.6044102Z     return self.request(
2025-08-18T17:28:43.6044659Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:43.6045150Z     return super().request(
2025-08-18T17:28:43.6045765Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:43.6046371Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:43.6046769Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6047336Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:43.6055020Z     response = self._send_handling_auth(
2025-08-18T17:28:43.6055928Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:43.6056493Z     response = self._send_handling_redirects(
2025-08-18T17:28:43.6057142Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:43.6057723Z     response = self._send_single_request(request)
2025-08-18T17:28:43.6058029Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6058639Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:43.6059193Z     response = transport.handle_request(request)
2025-08-18T17:28:43.6059498Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6060110Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:43.6060611Z     raise exc
2025-08-18T17:28:43.6061161Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:43.6061716Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:43.6062300Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:43.6063035Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:43.6063414Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6063965Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:43.6064434Z     return self.__get_result()
2025-08-18T17:28:43.6064680Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6065214Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:43.6065801Z     raise self._exception
2025-08-18T17:28:43.6066360Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:43.6066873Z     retval = await retval_or_awaitable
2025-08-18T17:28:43.6067152Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6067739Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:43.6068304Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:43.6068934Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:43.6069500Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.6070185Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:43.6070693Z     raise exc
2025-08-18T17:28:43.6071249Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:43.6071801Z     await self.app(scope, receive, _send)
2025-08-18T17:28:43.6072444Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:43.6073046Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:43.6073739Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:43.6074409Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:43.6075151Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.6075752Z     raise exc
2025-08-18T17:28:43.6076320Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.6077002Z     await app(scope, receive, sender)
2025-08-18T17:28:43.6077587Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:43.6078126Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:43.6078720Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:43.6079221Z     await route.handle(scope, receive, send)
2025-08-18T17:28:43.6079811Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:43.6080302Z     await self.app(scope, receive, send)
2025-08-18T17:28:43.6080851Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:43.6081434Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:43.6082169Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:43.6082681Z     raise exc
2025-08-18T17:28:43.6083243Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:43.6083780Z     await app(scope, receive, sender)
2025-08-18T17:28:43.6084333Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:43.6084807Z     response = await f(request)
2025-08-18T17:28:43.6085186Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6085929Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:43.6086440Z     solved_result = await solve_dependencies(
2025-08-18T17:28:43.6087144Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:43.6087742Z     solved = await call(**solved_result.values)
2025-08-18T17:28:43.6088044Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6088640Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T17:28:43.6089158Z     pexpire = await self._check(key)
2025-08-18T17:28:43.6089418Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6089986Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T17:28:43.6090500Z     pexpire = await redis.evalsha(
2025-08-18T17:28:43.6091131Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:615: in execute_command
2025-08-18T17:28:43.6091689Z     return await conn.retry.call_with_retry(
2025-08-18T17:28:43.6092317Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T17:28:43.6092817Z     return await do()
2025-08-18T17:28:43.6093026Z            ^^^^^^^^^^
2025-08-18T17:28:43.6093658Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:589: in _send_command_parse_response
2025-08-18T17:28:43.6094340Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T17:28:43.6094722Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6095522Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:636: in parse_response
2025-08-18T17:28:43.6096117Z     response = await connection.read_response()
2025-08-18T17:28:43.6096430Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6097052Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: in read_response
2025-08-18T17:28:43.6097601Z     await self.disconnect(nowait=True)
2025-08-18T17:28:43.6098232Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:418: in disconnect
2025-08-18T17:28:43.6098807Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T17:28:43.6099267Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6099731Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T17:28:43.6100171Z     return self._transport.close()
2025-08-18T17:28:43.6100432Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.6100945Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T17:28:43.6101373Z     super().close()
2025-08-18T17:28:43.6101851Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T17:28:43.6102365Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T17:28:43.6102936Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T17:28:43.6103366Z     self._check_closed()
2025-08-18T17:28:43.6103693Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:43.6103914Z 
2025-08-18T17:28:43.6104165Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T17:28:43.6104437Z 
2025-08-18T17:28:43.6104526Z     def _check_closed(self):
2025-08-18T17:28:43.6104760Z         if self._closed:
2025-08-18T17:28:43.6105059Z >           raise RuntimeError('Event loop is closed')
2025-08-18T17:28:43.6105512Z E           RuntimeError: Event loop is closed
2025-08-18T17:28:43.6105699Z 
2025-08-18T17:28:43.6106060Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T17:28:43.6106774Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:43.9064314Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "d2938605ef2940558accc375401d5630", "level": "error", "timestamp": "2025-08-18T17:28:41.792742Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f8a2e7e6c30>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f8a2e648d60>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e649760>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f8a2e171bb0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f8a2e649760>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "d2938605ef2940558accc375401d5630", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f8a2e7e6f00>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f8a2e1705c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "conn": "<starlette.requests.Request object at 0x7f8a2e1705c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "conn": "<starlette.requests.Request object at 0x7f8a2e1705c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f8a31175670>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f8a422aac00>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e0907c0>", "request": "<starlette.requests.Request object at 0x7f8a2e59a510>", "f": "<function get_request_handler.<locals>.app at 0x7f8a30fa4ea0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e0907c0>", "conn": "<starlette.requests.Request object at 0x7f8a2e59a510>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f8a2e0907c0>", "conn": "<starlette.requests.Request object at 0x7f8a2e59a510>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f8a2e648680'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f8a30fa4ea0>", "request": "<starlette.requests.Request object at 0x7f8a2e59a510>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e59a510>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e598950>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e598800>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31174e90>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f8a2e59a510>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f8a2e599e80>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f8a31174e90>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f8a2e598800>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f8a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "request": "<starlette.requests.Request object at 0x7f8a2e59a510>", "response": "<starlette.responses.Response object at 0x7f8a2e599e80>", "route_index": "13", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f8a3116ab60>", "callback": "<function http_default_callback at 0x7f8a31a1f6a0>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:13:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f8a31176960>", "key": "fastapi-limiter:testclient:13:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 615, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f8a2dcb7600>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f8a2e093920>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f8a2e0939c0>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 589, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 636, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 418, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=18> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 542, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f8a2e265710>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f8a2e265710>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f8a2e265710>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "func_name": "readuntil"}}]}]}
2025-08-18T17:28:43.9118576Z =============================== warnings summary ===============================
2025-08-18T17:28:43.9118954Z services/alert_bot/tests/test_smoke.py:5
2025-08-18T17:28:43.9120274Z   /home/runner/work/AWA-App/AWA-App/services/alert_bot/tests/test_smoke.py:5: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
2025-08-18T17:28:43.9121431Z     import pkg_resources  # noqa: F401
2025-08-18T17:28:43.9121610Z 
2025-08-18T17:28:43.9121792Z tests/api/test_ingest_endpoints.py: 3 warnings
2025-08-18T17:28:43.9122142Z tests/ingest/test_tasks_eager.py: 3 warnings
2025-08-18T17:28:43.9122455Z tests/test_api_fast.py: 1 warning
2025-08-18T17:28:43.9122741Z tests/test_health.py: 5 warnings
2025-08-18T17:28:43.9123015Z tests/test_smoke.py: 5 warnings
2025-08-18T17:28:43.9123311Z services/api/tests/test_cors.py: 1 warning
2025-08-18T17:28:43.9123819Z services/api/tests/test_errors_json.py: 2 warnings
2025-08-18T17:28:43.9124176Z services/api/tests/test_health.py: 1 warning
2025-08-18T17:28:43.9124530Z services/api/tests/test_rate_limit.py: 122 warnings
2025-08-18T17:28:43.9126178Z   /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/extensions/sentry.py:27: DeprecationWarning: sentry_sdk.configure_scope is deprecated and will be removed in the next major version. Please consult our migration guide to learn how to migrate to the new API: https://docs.sentry.io/platforms/python/migration/1.x-to-2.x#scope-configuring
2025-08-18T17:28:43.9127532Z     with configure_scope() as scope:
2025-08-18T17:28:43.9127704Z 
2025-08-18T17:28:43.9127878Z tests/test_health.py::test_health[0]
2025-08-18T17:28:43.9128176Z tests/test_health.py::test_health[1]
2025-08-18T17:28:43.9128461Z tests/test_health.py::test_health[2]
2025-08-18T17:28:43.9128749Z tests/test_health.py::test_health[3]
2025-08-18T17:28:43.9129033Z tests/test_health.py::test_health[4]
2025-08-18T17:28:43.9130124Z   /home/runner/work/AWA-App/AWA-App/tests/test_health.py:22: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:43.9131128Z     return datetime.datetime.utcnow()
2025-08-18T17:28:43.9131303Z 
2025-08-18T17:28:43.9131428Z tests/test_health.py: 5 warnings
2025-08-18T17:28:43.9131708Z tests/test_smoke.py: 5 warnings
2025-08-18T17:28:43.9132003Z services/api/tests/test_cors.py: 1 warning
2025-08-18T17:28:43.9132354Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T17:28:43.9133522Z   /home/runner/work/AWA-App/AWA-App/services/api/routes/health.py:24: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:43.9134613Z     app_now = datetime.utcnow().replace(tzinfo=timezone.utc)
2025-08-18T17:28:43.9134841Z 
2025-08-18T17:28:43.9134965Z tests/test_health.py: 4 warnings
2025-08-18T17:28:43.9135240Z tests/test_smoke.py: 5 warnings
2025-08-18T17:28:43.9135633Z services/api/tests/test_cors.py: 3 warnings
2025-08-18T17:28:43.9135981Z services/api/tests/test_rate_limit.py: 1 warning
2025-08-18T17:28:43.9136975Z   /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/_pytest/unraisableexception.py:67: PytestUnraisableExceptionWarning: Exception ignored in: <function AbstractConnection.__del__ at 0x7f8a318a4720>
2025-08-18T17:28:43.9137940Z   
2025-08-18T17:28:43.9138147Z   Traceback (most recent call last):
2025-08-18T17:28:43.9138788Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", line 218, in __del__
2025-08-18T17:28:43.9139338Z       self._close()
2025-08-18T17:28:43.9139914Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", line 225, in _close
2025-08-18T17:28:43.9140468Z       self._writer.close()
2025-08-18T17:28:43.9140959Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", line 358, in close
2025-08-18T17:28:43.9141444Z       return self._transport.close()
2025-08-18T17:28:43.9141708Z              ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:43.9142233Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", line 1213, in close
2025-08-18T17:28:43.9142715Z       super().close()
2025-08-18T17:28:43.9143209Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", line 875, in close
2025-08-18T17:28:43.9143766Z       self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T17:28:43.9144361Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", line 799, in call_soon
2025-08-18T17:28:43.9144834Z       self._check_closed()
2025-08-18T17:28:43.9145622Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", line 545, in _check_closed
2025-08-18T17:28:43.9168650Z ##[error]      raise RuntimeError('Event loop is closed')
2025-08-18T17:28:43.9175705Z   RuntimeError: Event loop is closed
2025-08-18T17:28:43.9175988Z   
2025-08-18T17:28:43.9176315Z   Enable tracemalloc to get traceback where the object was allocated.
2025-08-18T17:28:43.9176948Z   See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
2025-08-18T17:28:43.9177565Z     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
2025-08-18T17:28:43.9177840Z 
2025-08-18T17:28:43.9177996Z tests/test_smoke.py::test_health[0]
2025-08-18T17:28:43.9178304Z tests/test_smoke.py::test_health[1]
2025-08-18T17:28:43.9178590Z tests/test_smoke.py::test_health[2]
2025-08-18T17:28:43.9178876Z tests/test_smoke.py::test_health[3]
2025-08-18T17:28:43.9179157Z tests/test_smoke.py::test_health[4]
2025-08-18T17:28:43.9180258Z   /home/runner/work/AWA-App/AWA-App/tests/test_smoke.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:43.9181262Z     return datetime.datetime.utcnow()
2025-08-18T17:28:43.9181444Z 
2025-08-18T17:28:43.9181682Z services/api/tests/test_cors.py::test_cors_simple_get_allowed
2025-08-18T17:28:43.9182933Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_cors.py:27: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:43.9184005Z     return datetime.datetime.utcnow()
2025-08-18T17:28:43.9184182Z 
2025-08-18T17:28:43.9184372Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T17:28:43.9185681Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_rate_limit.py:33: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:43.9186751Z     return datetime.datetime.utcnow()
2025-08-18T17:28:43.9186926Z 
2025-08-18T17:28:43.9187198Z -- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
2025-08-18T17:28:43.9187681Z ================================ tests coverage ================================
2025-08-18T17:28:43.9188342Z _______________ coverage: platform linux, python 3.12.11-final-0 _______________
2025-08-18T17:28:43.9188603Z 
2025-08-18T17:28:43.9188761Z Coverage XML written to file coverage.xml
2025-08-18T17:28:43.9189171Z Required test coverage of 45% reached. Total coverage: 62.43%
2025-08-18T17:28:43.9189618Z =========================== short test summary info ============================
2025-08-18T17:28:43.9190375Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_file_upload - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.9191389Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_json_uri - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.9192375Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_failure - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.9193734Z FAILED tests/test_api_fast.py::test_health_endpoint - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:43.9195476Z FAILED services/api/tests/test_errors_json.py::test_validation_error_json - RuntimeError: Event loop is closed
2025-08-18T17:28:43.9196876Z FAILED services/api/tests/test_health.py::test_health_route - RuntimeError: Event loop is closed
2025-08-18T17:28:44.2644053Z ##[error]Process completed with exit code 1.
