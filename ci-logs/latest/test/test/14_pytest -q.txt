2025-08-18T15:45:42.8861349Z ##[group]Run pytest -q --cov=services
2025-08-18T15:45:42.8861704Z [36;1mpytest -q --cov=services[0m
2025-08-18T15:45:42.8904128Z shell: /usr/bin/bash -e {0}
2025-08-18T15:45:42.8904492Z env:
2025-08-18T15:45:42.8904794Z   REDIS_URL: redis://localhost:6379/0
2025-08-18T15:45:42.8905237Z   RATE_LIMIT_DEFAULT: 100/minute
2025-08-18T15:45:42.8905690Z   TRUST_X_FORWARDED: 1
2025-08-18T15:45:42.8906068Z   PG_USER: postgres
2025-08-18T15:45:42.8906369Z   PG_PASSWORD: pass
2025-08-18T15:45:42.8906686Z   PG_DATABASE: awa
2025-08-18T15:45:42.8906986Z   PG_HOST: localhost
2025-08-18T15:45:42.8907292Z   PG_PORT: 5432
2025-08-18T15:45:42.8907916Z   PG_SYNC_DSN: ***localhost:5432/awa
2025-08-18T15:45:42.8908579Z   PG_ASYNC_DSN: ***localhost:5432/awa
2025-08-18T15:45:42.8909081Z   DATABASE_URL: ***localhost:5432/awa
2025-08-18T15:45:42.8909350Z   DATA_DIR: /home/runner/work/_temp/awa-data
2025-08-18T15:45:42.8909619Z   ENABLE_LIVE: 0
2025-08-18T15:45:42.8909810Z   TESTING: 1
2025-08-18T15:45:42.8910065Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:42.8910541Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib/pkgconfig
2025-08-18T15:45:42.8910952Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:42.8911327Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:42.8911803Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:42.8924058Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib
2025-08-18T15:45:42.8924642Z   POSTGRES_USER: postgres
2025-08-18T15:45:42.8924887Z   POSTGRES_PASSWORD: pass
2025-08-18T15:45:42.8925099Z   POSTGRES_DB: awa
2025-08-18T15:45:42.8925287Z   LLM_PROVIDER: lan
2025-08-18T15:45:42.8925504Z   LLM_BASE_URL: http://localhost:8000
2025-08-18T15:45:42.8925755Z ##[endgroup]
2025-08-18T15:46:13.7543803Z .....FFFs.............................sssssss.....F..................... [ 47%]
2025-08-18T15:46:46.3197438Z ...............................F.F...................................... [ 94%]
2025-08-18T15:46:46.7779611Z ........                                                                 [100%]
2025-08-18T15:46:46.7780650Z =================================== FAILURES ===================================
2025-08-18T15:46:46.7781689Z ___________________________ test_ingest_file_upload ____________________________
2025-08-18T15:46:46.7782508Z 
2025-08-18T15:46:46.7783153Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f2a2d166390>
2025-08-18T15:46:46.7784483Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_file_upload0')
2025-08-18T15:46:46.7785083Z 
2025-08-18T15:46:46.7785376Z     def test_ingest_file_upload(monkeypatch, tmp_path) -> None:
2025-08-18T15:46:46.7786033Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T15:46:46.7786928Z             return {"rows": 2, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T15:46:46.7787617Z     
2025-08-18T15:46:46.7788246Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T15:46:46.7789032Z         client = _get_client(monkeypatch)
2025-08-18T15:46:46.7789515Z     
2025-08-18T15:46:46.7790197Z >       resp = client.post("/ingest", files={"file": ("test.csv", b"a,b\n1,2\n")})
2025-08-18T15:46:46.7790730Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7790972Z 
2025-08-18T15:46:46.7791175Z tests/api/test_ingest_endpoints.py:33: 
2025-08-18T15:46:46.7791671Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.7792899Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T15:46:46.7793888Z     return super().post(
2025-08-18T15:46:46.7794802Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T15:46:46.7795538Z     return self.request(
2025-08-18T15:46:46.7796222Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:46.7797040Z     return super().request(
2025-08-18T15:46:46.7797578Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:46.7798466Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:46.7799134Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7800082Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:46.7800881Z     response = self._send_handling_auth(
2025-08-18T15:46:46.7801591Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:46.7802246Z     response = self._send_handling_redirects(
2025-08-18T15:46:46.7802903Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:46.7803491Z     response = self._send_single_request(request)
2025-08-18T15:46:46.7803800Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7804749Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:46.7805678Z     response = transport.handle_request(request)
2025-08-18T15:46:46.7806181Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7807446Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:46.7808286Z     raise exc
2025-08-18T15:46:46.7809211Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:46.7810125Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:46.7810904Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:46.7811481Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:46.7811855Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7812697Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:46.7813170Z     return self.__get_result()
2025-08-18T15:46:46.7813416Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7814103Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:46.7814872Z     raise self._exception
2025-08-18T15:46:46.7815790Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:46.7816623Z     retval = await retval_or_awaitable
2025-08-18T15:46:46.7817042Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7818016Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:46.7819065Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:46.7820098Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:46.7820768Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.7821423Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:46.7822091Z     raise exc
2025-08-18T15:46:46.7822699Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:46.7823239Z     await self.app(scope, receive, _send)
2025-08-18T15:46:46.7823864Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:46.7824453Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:46.7825146Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:46.7826010Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:46.7826761Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.7827269Z     raise exc
2025-08-18T15:46:46.7827830Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.7828461Z     await app(scope, receive, sender)
2025-08-18T15:46:46.7829072Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:46.7829644Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.7830230Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:46.7830724Z     await route.handle(scope, receive, send)
2025-08-18T15:46:46.7831322Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:46.7831812Z     await self.app(scope, receive, send)
2025-08-18T15:46:46.7832479Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:46.7833062Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:46.7833792Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.7834431Z     raise exc
2025-08-18T15:46:46.7834991Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.7835530Z     await app(scope, receive, sender)
2025-08-18T15:46:46.7836068Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:46.7836538Z     response = await f(request)
2025-08-18T15:46:46.7838819Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7839669Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:46.7840472Z     solved_result = await solve_dependencies(
2025-08-18T15:46:46.7841579Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:46.7842772Z     solved = await call(**solved_result.values)
2025-08-18T15:46:46.7843259Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7843682Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.7843903Z 
2025-08-18T15:46:46.7844160Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f2a2d19f320>
2025-08-18T15:46:46.7844665Z request = <starlette.requests.Request object at 0x7f2a2b01b830>
2025-08-18T15:46:46.7845158Z response = <starlette.responses.Response object at 0x7f2a2b01be60>
2025-08-18T15:46:46.7845432Z 
2025-08-18T15:46:46.7845631Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:46.7845992Z         if not FastAPILimiter.redis:
2025-08-18T15:46:46.7846481Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:46.7847066Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:46.7847354Z 
2025-08-18T15:46:46.7847786Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:46.7848428Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:46.7893578Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "7a506ba794c04ed68b7cdba400b4d20f", "level": "error", "timestamp": "2025-08-18T15:45:48.919676Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f2a2b01b470>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f2a2d24fba0>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2d1332e0>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f2a2b01b7d0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2d1332e0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+226", "header_value": "None", "validation_failed": "False", "id_value": "7a506ba794c04ed68b7cdba400b4d20f", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f2a2d0cd1c0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f2a2b01b680>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d651010>", "conn": "<starlette.requests.Request object at 0x7f2a2b01b680>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d651010>", "conn": "<starlette.requests.Request object at 0x7f2a2b01b680>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d651010>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d651010>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f2a2d24d260>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2abe6020>", "request": "<starlette.requests.Request object at 0x7f2a2b01b830>", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d24e0c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2abe6020>", "conn": "<starlette.requests.Request object at 0x7f2a2b01b830>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2abe6020>", "conn": "<starlette.requests.Request object at 0x7f2a2b01b830>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2d24fb00'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d24e0c0>", "request": "<starlette.requests.Request object at 0x7f2a2b01b830>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2b01b830>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f2a2b01b980>", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2b01bbf0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2de1b410>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2b01b830>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f2a2b01be60>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2de1b410>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2b01bbf0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d19f320>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f2a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d19f320>", "request": "<starlette.requests.Request object at 0x7f2a2b01b830>", "response": "<starlette.responses.Response object at 0x7f2a2b01be60>"}}]}]}
2025-08-18T15:46:46.7927474Z _____________________________ test_ingest_json_uri _____________________________
2025-08-18T15:46:46.7927727Z 
2025-08-18T15:46:46.7928002Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f2a2ac1db80>
2025-08-18T15:46:46.7928556Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_json_uri0')
2025-08-18T15:46:46.7928977Z 
2025-08-18T15:46:46.7929163Z     def test_ingest_json_uri(monkeypatch, tmp_path) -> None:
2025-08-18T15:46:46.7929687Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T15:46:46.7930216Z             return {"rows": 1, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T15:46:46.7930555Z     
2025-08-18T15:46:46.7930870Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T15:46:46.7931261Z         client = _get_client(monkeypatch)
2025-08-18T15:46:46.7931505Z     
2025-08-18T15:46:46.7931703Z         f = tmp_path / "sample.csv"
2025-08-18T15:46:46.7932082Z         f.write_text("a,b\n1,2\n")
2025-08-18T15:46:46.7932315Z     
2025-08-18T15:46:46.7932621Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T15:46:46.7932981Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7933173Z 
2025-08-18T15:46:46.7933319Z tests/api/test_ingest_endpoints.py:55: 
2025-08-18T15:46:46.7933698Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.7934317Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T15:46:46.7934803Z     return super().post(
2025-08-18T15:46:46.7935321Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T15:46:46.7935903Z     return self.request(
2025-08-18T15:46:46.7936461Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:46.7936949Z     return super().request(
2025-08-18T15:46:46.7937467Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:46.7938061Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:46.7938468Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7939019Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:46.7939499Z     response = self._send_handling_auth(
2025-08-18T15:46:46.7940107Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:46.7940648Z     response = self._send_handling_redirects(
2025-08-18T15:46:46.7941290Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:46.7941851Z     response = self._send_single_request(request)
2025-08-18T15:46:46.7942285Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7942896Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:46.7943443Z     response = transport.handle_request(request)
2025-08-18T15:46:46.7943756Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7944361Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:46.7944851Z     raise exc
2025-08-18T15:46:46.7945390Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:46.7945937Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:46.7946518Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:46.7947088Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:46.7947556Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7948100Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:46.7948557Z     return self.__get_result()
2025-08-18T15:46:46.7948928Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7949451Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:46.7949913Z     raise self._exception
2025-08-18T15:46:46.7950462Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:46.7950968Z     retval = await retval_or_awaitable
2025-08-18T15:46:46.7951241Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7952119Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:46.7952825Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:46.7953452Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:46.7954010Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.7954672Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:46.7955177Z     raise exc
2025-08-18T15:46:46.7955728Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:46.7956270Z     await self.app(scope, receive, _send)
2025-08-18T15:46:46.7956900Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:46.7957663Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:46.7958356Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:46.7959021Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:46.7959756Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.7960256Z     raise exc
2025-08-18T15:46:46.7960821Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.7961360Z     await app(scope, receive, sender)
2025-08-18T15:46:46.7962048Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:46.7962592Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.7963175Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:46.7963676Z     await route.handle(scope, receive, send)
2025-08-18T15:46:46.7964249Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:46.7964743Z     await self.app(scope, receive, send)
2025-08-18T15:46:46.7965296Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:46.7965873Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:46.7966599Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.7967102Z     raise exc
2025-08-18T15:46:46.7967662Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.7968203Z     await app(scope, receive, sender)
2025-08-18T15:46:46.7968749Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:46.7969222Z     response = await f(request)
2025-08-18T15:46:46.7969475Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7969988Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:46.7970481Z     solved_result = await solve_dependencies(
2025-08-18T15:46:46.7971156Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:46.7972028Z     solved = await call(**solved_result.values)
2025-08-18T15:46:46.7972333Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.7972695Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.7972911Z 
2025-08-18T15:46:46.7973161Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f2a2afe0c80>
2025-08-18T15:46:46.7973643Z request = <starlette.requests.Request object at 0x7f2a2b002ff0>
2025-08-18T15:46:46.7974129Z response = <starlette.responses.Response object at 0x7f2a2b003290>
2025-08-18T15:46:46.7974389Z 
2025-08-18T15:46:46.7974583Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:46.7974942Z         if not FastAPILimiter.redis:
2025-08-18T15:46:46.7975424Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:46.7976000Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:46.7976285Z 
2025-08-18T15:46:46.7976718Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:46.7977378Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:46.8021582Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "9f426b6e8ced41be9f83a2ce372ca008", "level": "error", "timestamp": "2025-08-18T15:45:49.491477Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f2a2b002e10>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f2a2d24f560>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2afd96c0>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f2a2b002fc0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2afd96c0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "9f426b6e8ced41be9f83a2ce372ca008", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f2a2b0029f0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f2a2b002ed0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d19e2a0>", "conn": "<starlette.requests.Request object at 0x7f2a2b002ed0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d19e2a0>", "conn": "<starlette.requests.Request object at 0x7f2a2b002ed0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d19e2a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d19e2a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f2a2a9ae980>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2afda0c0>", "request": "<starlette.requests.Request object at 0x7f2a2b002ff0>", "f": "<function get_request_handler.<locals>.app at 0x7f2a2a9afce0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2afda0c0>", "conn": "<starlette.requests.Request object at 0x7f2a2b002ff0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2afda0c0>", "conn": "<starlette.requests.Request object at 0x7f2a2b002ff0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac4b2e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f2a2a9afce0>", "request": "<starlette.requests.Request object at 0x7f2a2b002ff0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2b002ff0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f2a2b003140>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2b003260>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2dfda030>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2b002ff0>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f2a2b003290>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2dfda030>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2b003260>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2afe0c80>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f2a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2afe0c80>", "request": "<starlette.requests.Request object at 0x7f2a2b002ff0>", "response": "<starlette.responses.Response object at 0x7f2a2b003290>"}}]}]}
2025-08-18T15:46:46.8055150Z _____________________________ test_ingest_failure ______________________________
2025-08-18T15:46:46.8055395Z 
2025-08-18T15:46:46.8055663Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f2a2b01b6b0>
2025-08-18T15:46:46.8056213Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_failure0')
2025-08-18T15:46:46.8056618Z 
2025-08-18T15:46:46.8056801Z     def test_ingest_failure(monkeypatch, tmp_path) -> None:
2025-08-18T15:46:46.8057276Z         def bad_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T15:46:46.8057684Z             raise RuntimeError("boom")
2025-08-18T15:46:46.8057925Z     
2025-08-18T15:46:46.8058231Z         monkeypatch.setattr("etl.load_csv.import_file", bad_import_file)
2025-08-18T15:46:46.8058611Z         client = _get_client(monkeypatch)
2025-08-18T15:46:46.8058952Z         from services.ingest.celery_app import celery_app
2025-08-18T15:46:46.8059229Z     
2025-08-18T15:46:46.8059465Z         celery_app.conf.task_eager_propagates = False
2025-08-18T15:46:46.8059730Z     
2025-08-18T15:46:46.8059922Z         f = tmp_path / "bad.csv"
2025-08-18T15:46:46.8060191Z         f.write_text("a,b\n1,2\n")
2025-08-18T15:46:46.8060420Z     
2025-08-18T15:46:46.8060717Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T15:46:46.8061080Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8061263Z 
2025-08-18T15:46:46.8061411Z tests/api/test_ingest_endpoints.py:77: 
2025-08-18T15:46:46.8061787Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8062523Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T15:46:46.8062999Z     return super().post(
2025-08-18T15:46:46.8063514Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T15:46:46.8063962Z     return self.request(
2025-08-18T15:46:46.8064511Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:46.8064988Z     return super().request(
2025-08-18T15:46:46.8065507Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:46.8066097Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:46.8066499Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8067049Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:46.8067521Z     response = self._send_handling_auth(
2025-08-18T15:46:46.8068130Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:46.8068802Z     response = self._send_handling_redirects(
2025-08-18T15:46:46.8069430Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:46.8069989Z     response = self._send_single_request(request)
2025-08-18T15:46:46.8070304Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8070911Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:46.8071470Z     response = transport.handle_request(request)
2025-08-18T15:46:46.8071777Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8072486Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:46.8072992Z     raise exc
2025-08-18T15:46:46.8073536Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:46.8074091Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:46.8074666Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:46.8075234Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:46.8075612Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8076150Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:46.8076733Z     return self.__get_result()
2025-08-18T15:46:46.8076981Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8077506Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:46.8077967Z     raise self._exception
2025-08-18T15:46:46.8078512Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:46.8079016Z     retval = await retval_or_awaitable
2025-08-18T15:46:46.8079292Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8079871Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:46.8080398Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:46.8081011Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:46.8081565Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8082322Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:46.8082818Z     raise exc
2025-08-18T15:46:46.8083369Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:46.8083913Z     await self.app(scope, receive, _send)
2025-08-18T15:46:46.8084550Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:46.8085144Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:46.8085828Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:46.8086486Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:46.8087217Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8087723Z     raise exc
2025-08-18T15:46:46.8088280Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8088821Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8089389Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:46.8089927Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8090633Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:46.8091130Z     await route.handle(scope, receive, send)
2025-08-18T15:46:46.8091705Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:46.8092304Z     await self.app(scope, receive, send)
2025-08-18T15:46:46.8092859Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:46.8093446Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:46.8094173Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8094674Z     raise exc
2025-08-18T15:46:46.8095233Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8095776Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8096324Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:46.8096797Z     response = await f(request)
2025-08-18T15:46:46.8097043Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8097550Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:46.8098047Z     solved_result = await solve_dependencies(
2025-08-18T15:46:46.8098848Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:46.8099436Z     solved = await call(**solved_result.values)
2025-08-18T15:46:46.8099740Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8100101Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8100312Z 
2025-08-18T15:46:46.8100559Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f2a2d1cbd70>
2025-08-18T15:46:46.8101045Z request = <starlette.requests.Request object at 0x7f2a2af8c800>
2025-08-18T15:46:46.8101524Z response = <starlette.responses.Response object at 0x7f2a2af8c0e0>
2025-08-18T15:46:46.8101780Z 
2025-08-18T15:46:46.8102102Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:46.8102463Z         if not FastAPILimiter.redis:
2025-08-18T15:46:46.8102941Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:46.8103524Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:46.8103805Z 
2025-08-18T15:46:46.8104235Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:46.8104868Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:46.8149026Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "5093a023013841bfabe03a06584d9503", "level": "error", "timestamp": "2025-08-18T15:45:50.016602Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f2a2af8c5f0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f2a2abbf880>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2d1f1620>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f2a2d1cbbc0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2d1f1620>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "5093a023013841bfabe03a06584d9503", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f2a2af8f860>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f2a2af8c6b0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2afe0590>", "conn": "<starlette.requests.Request object at 0x7f2a2af8c6b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2afe0590>", "conn": "<starlette.requests.Request object at 0x7f2a2af8c6b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2afe0590>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2afe0590>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f2a2abe6160>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2d2c7420>", "request": "<starlette.requests.Request object at 0x7f2a2af8c800>", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d24f060>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2d2c7420>", "conn": "<starlette.requests.Request object at 0x7f2a2af8c800>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2d2c7420>", "conn": "<starlette.requests.Request object at 0x7f2a2af8c800>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2abe5ee0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d24f060>", "request": "<starlette.requests.Request object at 0x7f2a2af8c800>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2af8c800>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f2a2af8c950>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2af8c0b0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2ac1eb70>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2af8c800>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f2a2af8c0e0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2ac1eb70>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2af8c0b0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d1cbd70>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f2a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d1cbd70>", "request": "<starlette.requests.Request object at 0x7f2a2af8c800>", "response": "<starlette.responses.Response object at 0x7f2a2af8c0e0>"}}]}]}
2025-08-18T15:46:46.8182566Z _____________________________ test_health_endpoint _____________________________
2025-08-18T15:46:46.8182811Z 
2025-08-18T15:46:46.8183077Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f2a2a6deab0>
2025-08-18T15:46:46.8183365Z 
2025-08-18T15:46:46.8183494Z     def test_health_endpoint(monkeypatch):
2025-08-18T15:46:46.8183894Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T15:46:46.8184244Z         client = TestClient(app)
2025-08-18T15:46:46.8184527Z >       r = client.get("/health")
2025-08-18T15:46:46.8184782Z             ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8184923Z 
2025-08-18T15:46:46.8185041Z tests/test_api_fast.py:25: 
2025-08-18T15:46:46.8185393Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8185999Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T15:46:46.8186471Z     return super().get(
2025-08-18T15:46:46.8186981Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T15:46:46.8187424Z     return self.request(
2025-08-18T15:46:46.8187969Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:46.8188579Z     return super().request(
2025-08-18T15:46:46.8189101Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:46.8189689Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:46.8190092Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8190646Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:46.8191121Z     response = self._send_handling_auth(
2025-08-18T15:46:46.8191729Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:46.8192376Z     response = self._send_handling_redirects(
2025-08-18T15:46:46.8193014Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:46.8193584Z     response = self._send_single_request(request)
2025-08-18T15:46:46.8193891Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8194494Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:46.8195043Z     response = transport.handle_request(request)
2025-08-18T15:46:46.8195354Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8196083Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:46.8196567Z     raise exc
2025-08-18T15:46:46.8197110Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:46.8197658Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:46.8198234Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:46.8198803Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:46.8199181Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8199724Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:46.8200184Z     return self.__get_result()
2025-08-18T15:46:46.8200437Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8200965Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:46.8201430Z     raise self._exception
2025-08-18T15:46:46.8202080Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:46.8202588Z     retval = await retval_or_awaitable
2025-08-18T15:46:46.8202865Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8203430Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:46.8203966Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:46.8204586Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:46.8205137Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8205794Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:46.8206291Z     raise exc
2025-08-18T15:46:46.8206839Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:46.8207376Z     await self.app(scope, receive, _send)
2025-08-18T15:46:46.8208006Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:46.8208598Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:46.8209281Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:46.8210062Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:46.8210794Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8211293Z     raise exc
2025-08-18T15:46:46.8211855Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8212498Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8213058Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:46.8213594Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8214179Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:46.8214680Z     await route.handle(scope, receive, send)
2025-08-18T15:46:46.8215258Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:46.8215751Z     await self.app(scope, receive, send)
2025-08-18T15:46:46.8216299Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:46.8216887Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:46.8217609Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8218234Z     raise exc
2025-08-18T15:46:46.8218792Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8219327Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8219869Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:46.8220337Z     response = await f(request)
2025-08-18T15:46:46.8220588Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8221095Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:46.8221584Z     solved_result = await solve_dependencies(
2025-08-18T15:46:46.8222384Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:46.8222975Z     solved = await call(**solved_result.values)
2025-08-18T15:46:46.8223279Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8223640Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8223853Z 
2025-08-18T15:46:46.8224100Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>
2025-08-18T15:46:46.8224583Z request = <starlette.requests.Request object at 0x7f2a2a7382c0>
2025-08-18T15:46:46.8225063Z response = <starlette.responses.Response object at 0x7f2a2a739730>
2025-08-18T15:46:46.8225330Z 
2025-08-18T15:46:46.8225518Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:46.8225873Z         if not FastAPILimiter.redis:
2025-08-18T15:46:46.8226350Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:46.8226925Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:46.8227205Z 
2025-08-18T15:46:46.8227632Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:46.8228266Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:46.8275080Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "9c2c4f47684e46eeb52e370416a7b39d", "level": "error", "timestamp": "2025-08-18T15:45:50.844459Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f2a2a73b4d0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f2a2a6f8680>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2a7256c0>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f2a2a739b50>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2a7256c0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "9c2c4f47684e46eeb52e370416a7b39d", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f2a2a73acf0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f2a2a739760>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "conn": "<starlette.requests.Request object at 0x7f2a2a739760>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "conn": "<starlette.requests.Request object at 0x7f2a2a739760>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f2a3e8bac00>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a725e40>", "request": "<starlette.requests.Request object at 0x7f2a2a7382c0>", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d480ea0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a725e40>", "conn": "<starlette.requests.Request object at 0x7f2a2a7382c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a725e40>", "conn": "<starlette.requests.Request object at 0x7f2a2a7382c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2e9abba0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d480ea0>", "request": "<starlette.requests.Request object at 0x7f2a2a7382c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2a7382c0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a73b320>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a73b140>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2d6516d0>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2a7382c0>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f2a2a739730>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2d6516d0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a73b140>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f2a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "request": "<starlette.requests.Request object at 0x7f2a2a7382c0>", "response": "<starlette.responses.Response object at 0x7f2a2a739730>"}}]}]}
2025-08-18T15:46:46.8308483Z __________________________ test_validation_error_json __________________________
2025-08-18T15:46:46.8308749Z 
2025-08-18T15:46:46.8309036Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T15:46:46.8309477Z disable_decoding = False, timeout = None
2025-08-18T15:46:46.8309667Z 
2025-08-18T15:46:46.8309764Z     async def read_response(
2025-08-18T15:46:46.8309991Z         self,
2025-08-18T15:46:46.8310220Z         disable_decoding: bool = False,
2025-08-18T15:46:46.8310652Z         timeout: Optional[float] = None,
2025-08-18T15:46:46.8310902Z         *,
2025-08-18T15:46:46.8311118Z         disconnect_on_error: bool = True,
2025-08-18T15:46:46.8311417Z         push_request: Optional[bool] = False,
2025-08-18T15:46:46.8311670Z     ):
2025-08-18T15:46:46.8312060Z         """Read the response from a previously sent command"""
2025-08-18T15:46:46.8312492Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T15:46:46.8312879Z         host_error = self._host_error()
2025-08-18T15:46:46.8313120Z         try:
2025-08-18T15:46:46.8313298Z             if (
2025-08-18T15:46:46.8313539Z                 read_timeout is not None
2025-08-18T15:46:46.8313830Z                 and self.protocol in ["3", 3]
2025-08-18T15:46:46.8314120Z                 and not HIREDIS_AVAILABLE
2025-08-18T15:46:46.8314362Z             ):
2025-08-18T15:46:46.8314601Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:46.8314956Z                     response = await self._parser.read_response(
2025-08-18T15:46:46.8315378Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:46.8315710Z                     )
2025-08-18T15:46:46.8315947Z             elif read_timeout is not None:
2025-08-18T15:46:46.8316255Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:46.8316594Z                     response = await self._parser.read_response(
2025-08-18T15:46:46.8317069Z                         disable_decoding=disable_decoding
2025-08-18T15:46:46.8317335Z                     )
2025-08-18T15:46:46.8317632Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T15:46:46.8318010Z                 response = await self._parser.read_response(
2025-08-18T15:46:46.8318410Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:46.8318731Z                 )
2025-08-18T15:46:46.8318909Z             else:
2025-08-18T15:46:46.8319208Z >               response = await self._parser.read_response(
2025-08-18T15:46:46.8319545Z                     disable_decoding=disable_decoding
2025-08-18T15:46:46.8319803Z                 )
2025-08-18T15:46:46.8319917Z 
2025-08-18T15:46:46.8320321Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:542: 
2025-08-18T15:46:46.8320895Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8321563Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T15:46:46.8322306Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T15:46:46.8322708Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8323327Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T15:46:46.8323851Z     raw = await self._readline()
2025-08-18T15:46:46.8324106Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8324664Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T15:46:46.8325180Z     data = await self._stream.readline()
2025-08-18T15:46:46.8325460Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8325946Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T15:46:46.8326396Z     line = await self.readuntil(sep)
2025-08-18T15:46:46.8326661Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8327151Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T15:46:46.8327607Z     await self._wait_for_data('readuntil')
2025-08-18T15:46:46.8327980Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8328189Z 
2025-08-18T15:46:46.8328446Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=22>>
2025-08-18T15:46:46.8328939Z func_name = 'readuntil'
2025-08-18T15:46:46.8329070Z 
2025-08-18T15:46:46.8329210Z     async def _wait_for_data(self, func_name):
2025-08-18T15:46:46.8329578Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T15:46:46.8329845Z     
2025-08-18T15:46:46.8330082Z         If stream was paused, automatically resume it.
2025-08-18T15:46:46.8330352Z         """
2025-08-18T15:46:46.8330659Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T15:46:46.8331119Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T15:46:46.8331605Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T15:46:46.8332078Z         # which coroutine would get the next data.
2025-08-18T15:46:46.8332378Z         if self._waiter is not None:
2025-08-18T15:46:46.8332644Z             raise RuntimeError(
2025-08-18T15:46:46.8332958Z                 f'{func_name}() called while another coroutine is '
2025-08-18T15:46:46.8333308Z                 f'already waiting for incoming data')
2025-08-18T15:46:46.8333563Z     
2025-08-18T15:46:46.8333806Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T15:46:46.8334074Z     
2025-08-18T15:46:46.8334357Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T15:46:46.8334815Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T15:46:46.8335330Z         if self._paused:
2025-08-18T15:46:46.8335565Z             self._paused = False
2025-08-18T15:46:46.8335840Z             self._transport.resume_reading()
2025-08-18T15:46:46.8336082Z     
2025-08-18T15:46:46.8336303Z         self._waiter = self._loop.create_future()
2025-08-18T15:46:46.8336568Z         try:
2025-08-18T15:46:46.8336786Z >           await self._waiter
2025-08-18T15:46:46.8338657Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T15:46:46.8340038Z 
2025-08-18T15:46:46.8340380Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T15:46:46.8340724Z 
2025-08-18T15:46:46.8340965Z During handling of the above exception, another exception occurred:
2025-08-18T15:46:46.8341225Z 
2025-08-18T15:46:46.8341357Z     def test_validation_error_json() -> None:
2025-08-18T15:46:46.8341677Z         prev_user = os.environ.get("BASIC_USER")
2025-08-18T15:46:46.8342095Z         prev_pass = os.environ.get("BASIC_PASS")
2025-08-18T15:46:46.8342416Z         os.environ["ROI_BASIC_AUTH_USER"] = "u"
2025-08-18T15:46:46.8342742Z         os.environ["ROI_BASIC_AUTH_PASSWORD"] = "p"
2025-08-18T15:46:46.8343054Z         os.environ["BASIC_USER"] = "u"
2025-08-18T15:46:46.8343336Z         os.environ["BASIC_PASS"] = "p"
2025-08-18T15:46:46.8343569Z         try:
2025-08-18T15:46:46.8343783Z             client = TestClient(app)
2025-08-18T15:46:46.8344091Z             auth = base64.b64encode(b"u:p").decode()
2025-08-18T15:46:46.8344398Z >           resp = client.get(
2025-08-18T15:46:46.8344770Z                 "/roi-review?vendor=abc", headers={"Authorization": f"Basic {auth}"}
2025-08-18T15:46:46.8345111Z             )
2025-08-18T15:46:46.8345216Z 
2025-08-18T15:46:46.8345374Z services/api/tests/test_errors_json.py:21: 
2025-08-18T15:46:46.8345762Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8346400Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T15:46:46.8346876Z     return super().get(
2025-08-18T15:46:46.8347380Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T15:46:46.8347961Z     return self.request(
2025-08-18T15:46:46.8348510Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:46.8348995Z     return super().request(
2025-08-18T15:46:46.8349520Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:46.8350115Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:46.8350528Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8351079Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:46.8351555Z     response = self._send_handling_auth(
2025-08-18T15:46:46.8352283Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:46.8352824Z     response = self._send_handling_redirects(
2025-08-18T15:46:46.8353464Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:46.8354025Z     response = self._send_single_request(request)
2025-08-18T15:46:46.8354332Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8354939Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:46.8355645Z     response = transport.handle_request(request)
2025-08-18T15:46:46.8355948Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8356554Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:46.8357046Z     raise exc
2025-08-18T15:46:46.8357582Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:46.8358130Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:46.8358712Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:46.8359280Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:46.8359654Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8360203Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:46.8360669Z     return self.__get_result()
2025-08-18T15:46:46.8360912Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8361435Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:46.8361896Z     raise self._exception
2025-08-18T15:46:46.8362550Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:46.8363053Z     retval = await retval_or_awaitable
2025-08-18T15:46:46.8363322Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8363900Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:46.8364434Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:46.8365050Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:46.8365606Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8366269Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:46.8366766Z     raise exc
2025-08-18T15:46:46.8367317Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:46.8367858Z     await self.app(scope, receive, _send)
2025-08-18T15:46:46.8368502Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:46.8369230Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:46.8369922Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:46.8370592Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:46.8371327Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8371835Z     raise exc
2025-08-18T15:46:46.8372499Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8373043Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8373612Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:46.8374145Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8374743Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:46.8375248Z     await route.handle(scope, receive, send)
2025-08-18T15:46:46.8375826Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:46.8376325Z     await self.app(scope, receive, send)
2025-08-18T15:46:46.8376880Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:46.8377590Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:46.8378317Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8378817Z     raise exc
2025-08-18T15:46:46.8379391Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8379941Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8380495Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:46.8380980Z     response = await f(request)
2025-08-18T15:46:46.8381236Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8381748Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:46.8382376Z     solved_result = await solve_dependencies(
2025-08-18T15:46:46.8383065Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:46.8383666Z     solved = await call(**solved_result.values)
2025-08-18T15:46:46.8383973Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8384565Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T15:46:46.8385079Z     pexpire = await self._check(key)
2025-08-18T15:46:46.8385353Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8385928Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T15:46:46.8386441Z     pexpire = await redis.evalsha(
2025-08-18T15:46:46.8387063Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:615: in execute_command
2025-08-18T15:46:46.8387618Z     return await conn.retry.call_with_retry(
2025-08-18T15:46:46.8388242Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T15:46:46.8388739Z     return await do()
2025-08-18T15:46:46.8388949Z            ^^^^^^^^^^
2025-08-18T15:46:46.8389574Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:589: in _send_command_parse_response
2025-08-18T15:46:46.8390246Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T15:46:46.8390627Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8391382Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:636: in parse_response
2025-08-18T15:46:46.8392053Z     response = await connection.read_response()
2025-08-18T15:46:46.8392366Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8392992Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: in read_response
2025-08-18T15:46:46.8393538Z     await self.disconnect(nowait=True)
2025-08-18T15:46:46.8394159Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:418: in disconnect
2025-08-18T15:46:46.8394726Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T15:46:46.8395019Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8395474Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T15:46:46.8395910Z     return self._transport.close()
2025-08-18T15:46:46.8396180Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8396693Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T15:46:46.8397132Z     super().close()
2025-08-18T15:46:46.8397599Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T15:46:46.8398117Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T15:46:46.8398685Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T15:46:46.8399238Z     self._check_closed()
2025-08-18T15:46:46.8399679Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8399954Z 
2025-08-18T15:46:46.8400426Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T15:46:46.8400894Z 
2025-08-18T15:46:46.8401057Z     def _check_closed(self):
2025-08-18T15:46:46.8401426Z         if self._closed:
2025-08-18T15:46:46.8401885Z >           raise RuntimeError('Event loop is closed')
2025-08-18T15:46:46.8402859Z E           RuntimeError: Event loop is closed
2025-08-18T15:46:46.8415798Z 
2025-08-18T15:46:46.8416360Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T15:46:46.8417001Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:46.8494104Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "e4c0ace3e12e4027985e2e39e3d533b6", "level": "error", "timestamp": "2025-08-18T15:46:44.317799Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f2a2a73b4d0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f2a2a5e7f60>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2a560b80>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f2a2a55e630>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2a560b80>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+150", "header_value": "None", "validation_failed": "False", "id_value": "e4c0ace3e12e4027985e2e39e3d533b6", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f2a2a73acf0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f2a2a571310>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "conn": "<starlette.requests.Request object at 0x7f2a2a571310>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "conn": "<starlette.requests.Request object at 0x7f2a2a571310>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function roi_review at 0x7f2a3e8bb880>, 'path_params': {}, 'route'\"+67"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a560540>", "request": "<starlette.requests.Request object at 0x7f2a2a571460>", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d4802c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a560540>", "conn": "<starlette.requests.Request object at 0x7f2a2a571460>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a560540>", "conn": "<starlette.requests.Request object at 0x7f2a2a571460>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2a5e5080'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d4802c0>", "request": "<starlette.requests.Request object at 0x7f2a2a571460>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2a571460>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a5715b0>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a5715e0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2d6516d0>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "False", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2a571460>", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f2a2a571610>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2d6516d0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a5715e0>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "use_path": "/roi-review", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f2a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "request": "<starlette.requests.Request object at 0x7f2a2a571460>", "response": "<starlette.responses.Response object at 0x7f2a2a571610>", "route_index": "8", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f2a2d64ab60>", "callback": "<function http_default_callback at 0x7f2a2dea76a0>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:8:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "key": "fastapi-limiter:testclient:8:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 615, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f2a2a78dd40>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f2a2a5e7d80>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f2a2a5e7c40>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 589, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 636, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 418, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=22> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=22>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=22>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 542, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f2a2a5a1860>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f2a2a5a1860>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f2a2a5a1860>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=22>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=22>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=22>>", "func_name": "readuntil"}}]}]}
2025-08-18T15:46:46.8547302Z ______________________________ test_health_route _______________________________
2025-08-18T15:46:46.8547554Z 
2025-08-18T15:46:46.8547845Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T15:46:46.8548283Z disable_decoding = False, timeout = None
2025-08-18T15:46:46.8548597Z 
2025-08-18T15:46:46.8548694Z     async def read_response(
2025-08-18T15:46:46.8548919Z         self,
2025-08-18T15:46:46.8549143Z         disable_decoding: bool = False,
2025-08-18T15:46:46.8549432Z         timeout: Optional[float] = None,
2025-08-18T15:46:46.8549677Z         *,
2025-08-18T15:46:46.8549896Z         disconnect_on_error: bool = True,
2025-08-18T15:46:46.8550201Z         push_request: Optional[bool] = False,
2025-08-18T15:46:46.8550448Z     ):
2025-08-18T15:46:46.8550714Z         """Read the response from a previously sent command"""
2025-08-18T15:46:46.8551145Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T15:46:46.8551520Z         host_error = self._host_error()
2025-08-18T15:46:46.8551765Z         try:
2025-08-18T15:46:46.8552039Z             if (
2025-08-18T15:46:46.8552266Z                 read_timeout is not None
2025-08-18T15:46:46.8552559Z                 and self.protocol in ["3", 3]
2025-08-18T15:46:46.8552852Z                 and not HIREDIS_AVAILABLE
2025-08-18T15:46:46.8553097Z             ):
2025-08-18T15:46:46.8553339Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:46.8553687Z                     response = await self._parser.read_response(
2025-08-18T15:46:46.8554103Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:46.8554444Z                     )
2025-08-18T15:46:46.8554704Z             elif read_timeout is not None:
2025-08-18T15:46:46.8555013Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:46.8555347Z                     response = await self._parser.read_response(
2025-08-18T15:46:46.8555689Z                         disable_decoding=disable_decoding
2025-08-18T15:46:46.8555958Z                     )
2025-08-18T15:46:46.8556260Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T15:46:46.8556637Z                 response = await self._parser.read_response(
2025-08-18T15:46:46.8557043Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:46.8557360Z                 )
2025-08-18T15:46:46.8557545Z             else:
2025-08-18T15:46:46.8557832Z >               response = await self._parser.read_response(
2025-08-18T15:46:46.8558173Z                     disable_decoding=disable_decoding
2025-08-18T15:46:46.8558434Z                 )
2025-08-18T15:46:46.8558547Z 
2025-08-18T15:46:46.8558952Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:542: 
2025-08-18T15:46:46.8559670Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8560320Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T15:46:46.8560955Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T15:46:46.8561359Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8562094Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T15:46:46.8562620Z     raw = await self._readline()
2025-08-18T15:46:46.8562873Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8563428Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T15:46:46.8563944Z     data = await self._stream.readline()
2025-08-18T15:46:46.8564237Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8564734Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T15:46:46.8565176Z     line = await self.readuntil(sep)
2025-08-18T15:46:46.8565451Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8565935Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T15:46:46.8566388Z     await self._wait_for_data('readuntil')
2025-08-18T15:46:46.8566893Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8567109Z 
2025-08-18T15:46:46.8567371Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=18>>
2025-08-18T15:46:46.8567741Z func_name = 'readuntil'
2025-08-18T15:46:46.8567877Z 
2025-08-18T15:46:46.8568012Z     async def _wait_for_data(self, func_name):
2025-08-18T15:46:46.8568354Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T15:46:46.8568625Z     
2025-08-18T15:46:46.8568868Z         If stream was paused, automatically resume it.
2025-08-18T15:46:46.8569141Z         """
2025-08-18T15:46:46.8569459Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T15:46:46.8569918Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T15:46:46.8570361Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T15:46:46.8570739Z         # which coroutine would get the next data.
2025-08-18T15:46:46.8571036Z         if self._waiter is not None:
2025-08-18T15:46:46.8571308Z             raise RuntimeError(
2025-08-18T15:46:46.8571622Z                 f'{func_name}() called while another coroutine is '
2025-08-18T15:46:46.8572084Z                 f'already waiting for incoming data')
2025-08-18T15:46:46.8572343Z     
2025-08-18T15:46:46.8572584Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T15:46:46.8572849Z     
2025-08-18T15:46:46.8573139Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T15:46:46.8573597Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T15:46:46.8573930Z         if self._paused:
2025-08-18T15:46:46.8574166Z             self._paused = False
2025-08-18T15:46:46.8574447Z             self._transport.resume_reading()
2025-08-18T15:46:46.8574693Z     
2025-08-18T15:46:46.8574913Z         self._waiter = self._loop.create_future()
2025-08-18T15:46:46.8575181Z         try:
2025-08-18T15:46:46.8575401Z >           await self._waiter
2025-08-18T15:46:46.8577241Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T15:46:46.8578721Z 
2025-08-18T15:46:46.8579065Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T15:46:46.8579401Z 
2025-08-18T15:46:46.8579639Z During handling of the above exception, another exception occurred:
2025-08-18T15:46:46.8579897Z 
2025-08-18T15:46:46.8580011Z     def test_health_route() -> None:
2025-08-18T15:46:46.8580264Z         class FakeSession:
2025-08-18T15:46:46.8580525Z             async def execute(self, query):
2025-08-18T15:46:46.8580784Z                 class R:
2025-08-18T15:46:46.8581022Z                     def scalar(self):
2025-08-18T15:46:46.8581291Z                         import datetime
2025-08-18T15:46:46.8581519Z     
2025-08-18T15:46:46.8581753Z                         return datetime.datetime.utcnow()
2025-08-18T15:46:46.8582112Z     
2025-08-18T15:46:46.8582282Z                 return R()
2025-08-18T15:46:46.8582482Z     
2025-08-18T15:46:46.8582680Z         async def fake_get_session():
2025-08-18T15:46:46.8582957Z             yield FakeSession()
2025-08-18T15:46:46.8583172Z     
2025-08-18T15:46:46.8583454Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T15:46:46.8583801Z         client = TestClient(app)
2025-08-18T15:46:46.8584080Z >       resp = client.get("/health")
2025-08-18T15:46:46.8584337Z                ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8584494Z 
2025-08-18T15:46:46.8584638Z services/api/tests/test_health.py:23: 
2025-08-18T15:46:46.8585133Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8585739Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T15:46:46.8586209Z     return super().get(
2025-08-18T15:46:46.8586711Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T15:46:46.8587156Z     return self.request(
2025-08-18T15:46:46.8587704Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:46.8588187Z     return super().request(
2025-08-18T15:46:46.8588704Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:46.8589293Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:46.8589705Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8590257Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:46.8590734Z     response = self._send_handling_auth(
2025-08-18T15:46:46.8591339Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:46.8591877Z     response = self._send_handling_redirects(
2025-08-18T15:46:46.8592616Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:46.8593183Z     response = self._send_single_request(request)
2025-08-18T15:46:46.8593491Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8594100Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:46.8594651Z     response = transport.handle_request(request)
2025-08-18T15:46:46.8594955Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8595567Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:46.8596054Z     raise exc
2025-08-18T15:46:46.8596595Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:46.8597148Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:46.8597721Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:46.8598407Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:46.8598783Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8599327Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:46.8599787Z     return self.__get_result()
2025-08-18T15:46:46.8600030Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8600555Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:46.8601021Z     raise self._exception
2025-08-18T15:46:46.8601577Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:46.8602206Z     retval = await retval_or_awaitable
2025-08-18T15:46:46.8602475Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8603047Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:46.8603585Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:46.8604199Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:46.8604751Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8605407Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:46.8606017Z     raise exc
2025-08-18T15:46:46.8606569Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:46.8607321Z     await self.app(scope, receive, _send)
2025-08-18T15:46:46.8607954Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:46.8608545Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:46.8609227Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:46.8609889Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:46.8610617Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8611115Z     raise exc
2025-08-18T15:46:46.8611673Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8612589Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8613461Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:46.8614002Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:46.8614587Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:46.8615084Z     await route.handle(scope, receive, send)
2025-08-18T15:46:46.8615660Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:46.8616152Z     await self.app(scope, receive, send)
2025-08-18T15:46:46.8616701Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:46.8617281Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:46.8618269Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:46.8618789Z     raise exc
2025-08-18T15:46:46.8619354Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:46.8619889Z     await app(scope, receive, sender)
2025-08-18T15:46:46.8620429Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:46.8620899Z     response = await f(request)
2025-08-18T15:46:46.8621306Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8621834Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:46.8622471Z     solved_result = await solve_dependencies(
2025-08-18T15:46:46.8623156Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:46.8623752Z     solved = await call(**solved_result.values)
2025-08-18T15:46:46.8624061Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8624656Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T15:46:46.8625170Z     pexpire = await self._check(key)
2025-08-18T15:46:46.8625439Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8626008Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T15:46:46.8626513Z     pexpire = await redis.evalsha(
2025-08-18T15:46:46.8627128Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:615: in execute_command
2025-08-18T15:46:46.8627672Z     return await conn.retry.call_with_retry(
2025-08-18T15:46:46.8628289Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T15:46:46.8628777Z     return await do()
2025-08-18T15:46:46.8628978Z            ^^^^^^^^^^
2025-08-18T15:46:46.8629760Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:589: in _send_command_parse_response
2025-08-18T15:46:46.8630430Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T15:46:46.8630805Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8631424Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:636: in parse_response
2025-08-18T15:46:46.8632065Z     response = await connection.read_response()
2025-08-18T15:46:46.8632373Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8632995Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: in read_response
2025-08-18T15:46:46.8633543Z     await self.disconnect(nowait=True)
2025-08-18T15:46:46.8634162Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:418: in disconnect
2025-08-18T15:46:46.8634732Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T15:46:46.8635012Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8635459Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T15:46:46.8635897Z     return self._transport.close()
2025-08-18T15:46:46.8636165Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:46.8636667Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T15:46:46.8637101Z     super().close()
2025-08-18T15:46:46.8637577Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T15:46:46.8638085Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T15:46:46.8638653Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T15:46:46.8639079Z     self._check_closed()
2025-08-18T15:46:46.8639416Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:46.8639631Z 
2025-08-18T15:46:46.8639884Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T15:46:46.8640144Z 
2025-08-18T15:46:46.8640239Z     def _check_closed(self):
2025-08-18T15:46:46.8640474Z         if self._closed:
2025-08-18T15:46:46.8640770Z >           raise RuntimeError('Event loop is closed')
2025-08-18T15:46:46.8641117Z E           RuntimeError: Event loop is closed
2025-08-18T15:46:46.8641301Z 
2025-08-18T15:46:46.8641662Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T15:46:46.8642476Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:47.2391011Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "3d02cf6e134e4975a0b98c6651b06512", "level": "error", "timestamp": "2025-08-18T15:46:45.014720Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f2a2a73b4d0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f2a2ac95d00>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2a5e49a0>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f2a2a55caa0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f2a2a5e49a0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "3d02cf6e134e4975a0b98c6651b06512", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f2a2a73acf0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f2a2a5c40e0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "conn": "<starlette.requests.Request object at 0x7f2a2a5c40e0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "conn": "<starlette.requests.Request object at 0x7f2a2a5c40e0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f2a2d6516a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f2a3e8bac00>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a5e4680>", "request": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d480ea0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a5e4680>", "conn": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f2a2a5e4680>", "conn": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f2a2ac96200'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f2a2d480ea0>", "request": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a5c6150>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a5c6090>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2d6516d0>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f2a2a5c60f0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f2a2d6516d0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f2a2a5c6090>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f2a\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "request": "<starlette.requests.Request object at 0x7f2a2a5c5fd0>", "response": "<starlette.responses.Response object at 0x7f2a2a5c60f0>", "route_index": "13", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f2a2d64ab60>", "callback": "<function http_default_callback at 0x7f2a2dea76a0>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:13:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f2a2d6529f0>", "key": "fastapi-limiter:testclient:13:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 615, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f2a2a78dd40>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f2a2accfce0>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f2a2accfb00>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 589, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 636, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 418, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=18> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 542, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f2a2a5a1860>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f2a2a5a1860>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f2a2a5a1860>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "func_name": "readuntil"}}]}]}
2025-08-18T15:46:47.2444586Z =============================== warnings summary ===============================
2025-08-18T15:46:47.2444966Z services/alert_bot/tests/test_smoke.py:5
2025-08-18T15:46:47.2446271Z   /home/runner/work/AWA-App/AWA-App/services/alert_bot/tests/test_smoke.py:5: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
2025-08-18T15:46:47.2447412Z     import pkg_resources  # noqa: F401
2025-08-18T15:46:47.2447593Z 
2025-08-18T15:46:47.2447771Z tests/api/test_ingest_endpoints.py: 3 warnings
2025-08-18T15:46:47.2448125Z tests/ingest/test_tasks_eager.py: 3 warnings
2025-08-18T15:46:47.2448433Z tests/test_api_fast.py: 1 warning
2025-08-18T15:46:47.2448725Z tests/test_health.py: 5 warnings
2025-08-18T15:46:47.2449019Z tests/test_smoke.py: 5 warnings
2025-08-18T15:46:47.2449319Z services/api/tests/test_cors.py: 1 warning
2025-08-18T15:46:47.2449847Z services/api/tests/test_errors_json.py: 2 warnings
2025-08-18T15:46:47.2450209Z services/api/tests/test_health.py: 1 warning
2025-08-18T15:46:47.2450570Z services/api/tests/test_rate_limit.py: 122 warnings
2025-08-18T15:46:47.2452196Z   /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/extensions/sentry.py:27: DeprecationWarning: sentry_sdk.configure_scope is deprecated and will be removed in the next major version. Please consult our migration guide to learn how to migrate to the new API: https://docs.sentry.io/platforms/python/migration/1.x-to-2.x#scope-configuring
2025-08-18T15:46:47.2453519Z     with configure_scope() as scope:
2025-08-18T15:46:47.2453700Z 
2025-08-18T15:46:47.2453874Z tests/test_health.py::test_health[0]
2025-08-18T15:46:47.2454179Z tests/test_health.py::test_health[1]
2025-08-18T15:46:47.2454472Z tests/test_health.py::test_health[2]
2025-08-18T15:46:47.2454756Z tests/test_health.py::test_health[3]
2025-08-18T15:46:47.2455045Z tests/test_health.py::test_health[4]
2025-08-18T15:46:47.2456117Z   /home/runner/work/AWA-App/AWA-App/tests/test_health.py:22: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:47.2457097Z     return datetime.datetime.utcnow()
2025-08-18T15:46:47.2457273Z 
2025-08-18T15:46:47.2457545Z tests/test_health.py: 5 warnings
2025-08-18T15:46:47.2457827Z tests/test_smoke.py: 5 warnings
2025-08-18T15:46:47.2458129Z services/api/tests/test_cors.py: 1 warning
2025-08-18T15:46:47.2458484Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T15:46:47.2459640Z   /home/runner/work/AWA-App/AWA-App/services/api/routes/health.py:24: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:47.2460719Z     app_now = datetime.utcnow().replace(tzinfo=timezone.utc)
2025-08-18T15:46:47.2460955Z 
2025-08-18T15:46:47.2461080Z tests/test_health.py: 4 warnings
2025-08-18T15:46:47.2461354Z tests/test_smoke.py: 5 warnings
2025-08-18T15:46:47.2461655Z services/api/tests/test_cors.py: 3 warnings
2025-08-18T15:46:47.2462114Z services/api/tests/test_rate_limit.py: 1 warning
2025-08-18T15:46:47.2463112Z   /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/_pytest/unraisableexception.py:67: PytestUnraisableExceptionWarning: Exception ignored in: <function AbstractConnection.__del__ at 0x7f2a2dd28720>
2025-08-18T15:46:47.2463948Z   
2025-08-18T15:46:47.2464156Z   Traceback (most recent call last):
2025-08-18T15:46:47.2464788Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", line 218, in __del__
2025-08-18T15:46:47.2465325Z       self._close()
2025-08-18T15:46:47.2465893Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", line 225, in _close
2025-08-18T15:46:47.2466431Z       self._writer.close()
2025-08-18T15:46:47.2466911Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", line 358, in close
2025-08-18T15:46:47.2467387Z       return self._transport.close()
2025-08-18T15:46:47.2467649Z              ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:47.2468167Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", line 1213, in close
2025-08-18T15:46:47.2468642Z       super().close()
2025-08-18T15:46:47.2469135Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", line 875, in close
2025-08-18T15:46:47.2469684Z       self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T15:46:47.2470269Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", line 799, in call_soon
2025-08-18T15:46:47.2470768Z       self._check_closed()
2025-08-18T15:46:47.2471417Z     File "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", line 545, in _check_closed
2025-08-18T15:46:47.2493247Z ##[error]      raise RuntimeError('Event loop is closed')
2025-08-18T15:46:47.2500291Z   RuntimeError: Event loop is closed
2025-08-18T15:46:47.2500586Z   
2025-08-18T15:46:47.2500919Z   Enable tracemalloc to get traceback where the object was allocated.
2025-08-18T15:46:47.2501556Z   See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
2025-08-18T15:46:47.2502319Z     warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
2025-08-18T15:46:47.2502596Z 
2025-08-18T15:46:47.2502751Z tests/test_smoke.py::test_health[0]
2025-08-18T15:46:47.2503069Z tests/test_smoke.py::test_health[1]
2025-08-18T15:46:47.2503360Z tests/test_smoke.py::test_health[2]
2025-08-18T15:46:47.2503646Z tests/test_smoke.py::test_health[3]
2025-08-18T15:46:47.2503938Z tests/test_smoke.py::test_health[4]
2025-08-18T15:46:47.2505033Z   /home/runner/work/AWA-App/AWA-App/tests/test_smoke.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:47.2506027Z     return datetime.datetime.utcnow()
2025-08-18T15:46:47.2506207Z 
2025-08-18T15:46:47.2506439Z services/api/tests/test_cors.py::test_cors_simple_get_allowed
2025-08-18T15:46:47.2507855Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_cors.py:27: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:47.2508877Z     return datetime.datetime.utcnow()
2025-08-18T15:46:47.2509050Z 
2025-08-18T15:46:47.2509233Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T15:46:47.2510402Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_rate_limit.py:33: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:47.2511432Z     return datetime.datetime.utcnow()
2025-08-18T15:46:47.2511604Z 
2025-08-18T15:46:47.2511870Z -- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
2025-08-18T15:46:47.2512499Z ================================ tests coverage ================================
2025-08-18T15:46:47.2512963Z _______________ coverage: platform linux, python 3.12.11-final-0 _______________
2025-08-18T15:46:47.2513230Z 
2025-08-18T15:46:47.2513378Z Coverage XML written to file coverage.xml
2025-08-18T15:46:47.2513776Z Required test coverage of 45% reached. Total coverage: 62.43%
2025-08-18T15:46:47.2514211Z =========================== short test summary info ============================
2025-08-18T15:46:47.2514960Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_file_upload - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:47.2515983Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_json_uri - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:47.2516960Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_failure - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:47.2517889Z FAILED tests/test_api_fast.py::test_health_endpoint - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:47.2518728Z FAILED services/api/tests/test_errors_json.py::test_validation_error_json - RuntimeError: Event loop is closed
2025-08-18T15:46:47.2519468Z FAILED services/api/tests/test_health.py::test_health_route - RuntimeError: Event loop is closed
2025-08-18T15:46:47.6309958Z ##[error]Process completed with exit code 1.
