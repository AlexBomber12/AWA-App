2025-08-18T15:45:33.7744072Z ##[group]Run pytest -q --cov=services
2025-08-18T15:45:33.7744598Z [36;1mpytest -q --cov=services[0m
2025-08-18T15:45:33.7803905Z shell: /usr/bin/bash -e {0}
2025-08-18T15:45:33.7804303Z env:
2025-08-18T15:45:33.7804670Z   REDIS_URL: redis://localhost:6379/0
2025-08-18T15:45:33.7805128Z   RATE_LIMIT_DEFAULT: 100/minute
2025-08-18T15:45:33.7805534Z   TRUST_X_FORWARDED: 1
2025-08-18T15:45:33.7805880Z   PG_USER: postgres
2025-08-18T15:45:33.7806213Z   PG_PASSWORD: pass
2025-08-18T15:45:33.7806551Z   PG_DATABASE: awa
2025-08-18T15:45:33.7806883Z   PG_HOST: localhost
2025-08-18T15:45:33.7807233Z   PG_PORT: 5432
2025-08-18T15:45:33.7807921Z   PG_SYNC_DSN: ***localhost:5432/awa
2025-08-18T15:45:33.7808659Z   PG_ASYNC_DSN: ***localhost:5432/awa
2025-08-18T15:45:33.7809357Z   DATABASE_URL: ***localhost:5432/awa
2025-08-18T15:45:33.7810012Z   DATA_DIR: /tmp/awa-data
2025-08-18T15:45:33.7810386Z   ENABLE_LIVE: 0
2025-08-18T15:45:33.7810691Z   TESTING: 1
2025-08-18T15:45:33.7811106Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:33.7811844Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib/pkgconfig
2025-08-18T15:45:33.7812541Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:33.7813160Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:33.7813789Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T15:45:33.7814417Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib
2025-08-18T15:45:33.7814941Z ##[endgroup]
2025-08-18T15:46:04.6154461Z .....FFFs.............................sssssss.....F..................... [ 47%]
2025-08-18T15:46:37.1605594Z ...............................F.F...................................... [ 94%]
2025-08-18T15:46:37.6067227Z ........                                                                 [100%]
2025-08-18T15:46:37.6067862Z =================================== FAILURES ===================================
2025-08-18T15:46:37.6068366Z ___________________________ test_ingest_file_upload ____________________________
2025-08-18T15:46:37.6068939Z 
2025-08-18T15:46:37.6069358Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f6840001e50>
2025-08-18T15:46:37.6070560Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_file_upload0')
2025-08-18T15:46:37.6071247Z 
2025-08-18T15:46:37.6071546Z     def test_ingest_file_upload(monkeypatch, tmp_path) -> None:
2025-08-18T15:46:37.6072236Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T15:46:37.6072989Z             return {"rows": 2, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T15:46:37.6073512Z     
2025-08-18T15:46:37.6073929Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T15:46:37.6074642Z         client = _get_client(monkeypatch)
2025-08-18T15:46:37.6075476Z     
2025-08-18T15:46:37.6076113Z >       resp = client.post("/ingest", files={"file": ("test.csv", b"a,b\n1,2\n")})
2025-08-18T15:46:37.6077027Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6077589Z 
2025-08-18T15:46:37.6077828Z tests/api/test_ingest_endpoints.py:33: 
2025-08-18T15:46:37.6078566Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6080086Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T15:46:37.6080862Z     return super().post(
2025-08-18T15:46:37.6081497Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T15:46:37.6081937Z     return self.request(
2025-08-18T15:46:37.6082392Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:37.6082880Z     return super().request(
2025-08-18T15:46:37.6083471Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:37.6084386Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:37.6084744Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6085209Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:37.6085668Z     response = self._send_handling_auth(
2025-08-18T15:46:37.6086163Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:37.6086672Z     response = self._send_handling_redirects(
2025-08-18T15:46:37.6087192Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:37.6087726Z     response = self._send_single_request(request)
2025-08-18T15:46:37.6088050Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6088551Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:37.6089097Z     response = transport.handle_request(request)
2025-08-18T15:46:37.6089367Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6090298Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:37.6091000Z     raise exc
2025-08-18T15:46:37.6091427Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:37.6092188Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:37.6092984Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:37.6093879Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:37.6094427Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6095171Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:37.6095721Z     return self.__get_result()
2025-08-18T15:46:37.6095942Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6096344Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:37.6096783Z     raise self._exception
2025-08-18T15:46:37.6097210Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:37.6097679Z     retval = await retval_or_awaitable
2025-08-18T15:46:37.6097907Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6098441Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:37.6099301Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:37.6100297Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:37.6101380Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6102041Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:37.6102727Z     raise exc
2025-08-18T15:46:37.6103449Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:37.6104321Z     await self.app(scope, receive, _send)
2025-08-18T15:46:37.6105179Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:37.6105878Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:37.6106444Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:37.6107058Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:37.6107669Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6108406Z     raise exc
2025-08-18T15:46:37.6109152Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6110163Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6110940Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:37.6111643Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6112390Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:37.6113176Z     await route.handle(scope, receive, send)
2025-08-18T15:46:37.6113958Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:37.6114747Z     await self.app(scope, receive, send)
2025-08-18T15:46:37.6115279Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:37.6115816Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:37.6116403Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6116884Z     raise exc
2025-08-18T15:46:37.6117314Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6117817Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6118243Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:37.6118679Z     response = await f(request)
2025-08-18T15:46:37.6118893Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6119288Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:37.6119945Z     solved_result = await solve_dependencies(
2025-08-18T15:46:37.6120498Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:37.6121055Z     solved = await call(**solved_result.values)
2025-08-18T15:46:37.6121316Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6121577Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6121796Z 
2025-08-18T15:46:37.6121969Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f682ee41400>
2025-08-18T15:46:37.6122373Z request = <starlette.requests.Request object at 0x7f682cc8d9d0>
2025-08-18T15:46:37.6122767Z response = <starlette.responses.Response object at 0x7f682cc8e060>
2025-08-18T15:46:37.6123017Z 
2025-08-18T15:46:37.6123161Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:37.6123625Z         if not FastAPILimiter.redis:
2025-08-18T15:46:37.6123992Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:37.6124472Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:37.6124751Z 
2025-08-18T15:46:37.6125059Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:37.6125600Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:37.6159229Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "1190e55824914d55a64f554c6d18f672", "level": "error", "timestamp": "2025-08-18T15:45:39.642764Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f682ee33620>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f682ee70900>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682cdbb880>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f682ee33bc0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682cdbb880>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+226", "header_value": "None", "validation_failed": "False", "id_value": "1190e55824914d55a64f554c6d18f672", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f682cd5df40>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f682cc8d820>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f35ce90>", "conn": "<starlette.requests.Request object at 0x7f682cc8d820>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f35ce90>", "conn": "<starlette.requests.Request object at 0x7f682cc8d820>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f35ce90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f35ce90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f682eebcfe0>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c84e520>", "request": "<starlette.requests.Request object at 0x7f682cc8d9d0>", "f": "<function get_request_handler.<locals>.app at 0x7f682eebe840>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c84e520>", "conn": "<starlette.requests.Request object at 0x7f682cc8d9d0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c84e520>", "conn": "<starlette.requests.Request object at 0x7f682cc8d9d0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ee73e20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f682eebe840>", "request": "<starlette.requests.Request object at 0x7f682cc8d9d0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682cc8d9d0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f682cc8db20>", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682cc8dd60>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682fbf2840>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682cc8d9d0>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f682cc8e060>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682fbf2840>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682cc8dd60>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682ee41400>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f68\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682ee41400>", "request": "<starlette.requests.Request object at 0x7f682cc8d9d0>", "response": "<starlette.responses.Response object at 0x7f682cc8e060>"}}]}]}
2025-08-18T15:46:37.6193428Z _____________________________ test_ingest_json_uri _____________________________
2025-08-18T15:46:37.6193660Z 
2025-08-18T15:46:37.6193855Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f682cc8f1d0>
2025-08-18T15:46:37.6194307Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_json_uri0')
2025-08-18T15:46:37.6194589Z 
2025-08-18T15:46:37.6194727Z     def test_ingest_json_uri(monkeypatch, tmp_path) -> None:
2025-08-18T15:46:37.6195147Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T15:46:37.6195743Z             return {"rows": 1, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T15:46:37.6196061Z     
2025-08-18T15:46:37.6196320Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T15:46:37.6196663Z         client = _get_client(monkeypatch)
2025-08-18T15:46:37.6196886Z     
2025-08-18T15:46:37.6197060Z         f = tmp_path / "sample.csv"
2025-08-18T15:46:37.6197298Z         f.write_text("a,b\n1,2\n")
2025-08-18T15:46:37.6197507Z     
2025-08-18T15:46:37.6197736Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T15:46:37.6198044Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6198216Z 
2025-08-18T15:46:37.6198316Z tests/api/test_ingest_endpoints.py:55: 
2025-08-18T15:46:37.6198592Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6199090Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T15:46:37.6199665Z     return super().post(
2025-08-18T15:46:37.6200067Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T15:46:37.6200507Z     return self.request(
2025-08-18T15:46:37.6200931Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:37.6201402Z     return super().request(
2025-08-18T15:46:37.6201802Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:37.6202336Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:37.6202680Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6203115Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:37.6203551Z     response = self._send_handling_auth(
2025-08-18T15:46:37.6204039Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:37.6204540Z     response = self._send_handling_redirects(
2025-08-18T15:46:37.6205042Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:37.6205564Z     response = self._send_single_request(request)
2025-08-18T15:46:37.6205844Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6206326Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:37.6206841Z     response = transport.handle_request(request)
2025-08-18T15:46:37.6207112Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6207595Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:37.6208198Z     raise exc
2025-08-18T15:46:37.6208619Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:37.6209133Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:37.6209785Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:37.6210343Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:37.6210668Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6211095Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:37.6211525Z     return self.__get_result()
2025-08-18T15:46:37.6211741Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6212142Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:37.6212595Z     raise self._exception
2025-08-18T15:46:37.6213025Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:37.6213624Z     retval = await retval_or_awaitable
2025-08-18T15:46:37.6213854Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6214304Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:37.6214797Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:37.6215280Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:37.6215788Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6216315Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:37.6216796Z     raise exc
2025-08-18T15:46:37.6217214Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:37.6217720Z     await self.app(scope, receive, _send)
2025-08-18T15:46:37.6218227Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:37.6218771Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:37.6219321Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:37.6220031Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:37.6220625Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6221103Z     raise exc
2025-08-18T15:46:37.6221530Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6222039Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6222487Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:37.6222979Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6223449Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:37.6223907Z     await route.handle(scope, receive, send)
2025-08-18T15:46:37.6224358Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:37.6224814Z     await self.app(scope, receive, send)
2025-08-18T15:46:37.6225248Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:37.6225773Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:37.6226358Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6226961Z     raise exc
2025-08-18T15:46:37.6227386Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6227893Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6228317Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:37.6228755Z     response = await f(request)
2025-08-18T15:46:37.6228971Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6229359Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:37.6230023Z     solved_result = await solve_dependencies(
2025-08-18T15:46:37.6230597Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:37.6231157Z     solved = await call(**solved_result.values)
2025-08-18T15:46:37.6231427Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6231691Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6232015Z 
2025-08-18T15:46:37.6232192Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f682c8b5be0>
2025-08-18T15:46:37.6232593Z request = <starlette.requests.Request object at 0x7f682c670590>
2025-08-18T15:46:37.6232996Z response = <starlette.responses.Response object at 0x7f682c670800>
2025-08-18T15:46:37.6233247Z 
2025-08-18T15:46:37.6233394Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:37.6233712Z         if not FastAPILimiter.redis:
2025-08-18T15:46:37.6234077Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:37.6234555Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:37.6234836Z 
2025-08-18T15:46:37.6235146Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:37.6235694Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:37.6268789Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "957b61ee998a41f4a0420920bcc7651d", "level": "error", "timestamp": "2025-08-18T15:45:40.300234Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f682c670380>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f682eebfce0>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682c8c0cc0>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f682c8ba840>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682c8c0cc0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "957b61ee998a41f4a0420920bcc7651d", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f682c6700b0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f682c670440>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682ee40b60>", "conn": "<starlette.requests.Request object at 0x7f682c670440>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682ee40b60>", "conn": "<starlette.requests.Request object at 0x7f682c670440>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682ee40b60>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682ee40b60>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f682ef55760>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c8c1620>", "request": "<starlette.requests.Request object at 0x7f682c670590>", "f": "<function get_request_handler.<locals>.app at 0x7f682cca1940>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c8c1620>", "conn": "<starlette.requests.Request object at 0x7f682c670590>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c8c1620>", "conn": "<starlette.requests.Request object at 0x7f682c670590>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c89f880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f682cca1940>", "request": "<starlette.requests.Request object at 0x7f682c670590>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c670590>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f682c6706e0>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c6707d0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25cb30>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c670590>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f682c670800>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25cb30>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c6707d0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682c8b5be0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f68\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682c8b5be0>", "request": "<starlette.requests.Request object at 0x7f682c670590>", "response": "<starlette.responses.Response object at 0x7f682c670800>"}}]}]}
2025-08-18T15:46:37.6302268Z _____________________________ test_ingest_failure ______________________________
2025-08-18T15:46:37.6302506Z 
2025-08-18T15:46:37.6302699Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f682c672b40>
2025-08-18T15:46:37.6303154Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_failure0')
2025-08-18T15:46:37.6303433Z 
2025-08-18T15:46:37.6303567Z     def test_ingest_failure(monkeypatch, tmp_path) -> None:
2025-08-18T15:46:37.6303977Z         def bad_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T15:46:37.6304347Z             raise RuntimeError("boom")
2025-08-18T15:46:37.6304571Z     
2025-08-18T15:46:37.6304827Z         monkeypatch.setattr("etl.load_csv.import_file", bad_import_file)
2025-08-18T15:46:37.6305168Z         client = _get_client(monkeypatch)
2025-08-18T15:46:37.6305454Z         from services.ingest.celery_app import celery_app
2025-08-18T15:46:37.6305719Z     
2025-08-18T15:46:37.6305924Z         celery_app.conf.task_eager_propagates = False
2025-08-18T15:46:37.6306170Z     
2025-08-18T15:46:37.6306341Z         f = tmp_path / "bad.csv"
2025-08-18T15:46:37.6306577Z         f.write_text("a,b\n1,2\n")
2025-08-18T15:46:37.6306782Z     
2025-08-18T15:46:37.6307000Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T15:46:37.6307306Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6307475Z 
2025-08-18T15:46:37.6307577Z tests/api/test_ingest_endpoints.py:77: 
2025-08-18T15:46:37.6307854Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6308350Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T15:46:37.6308812Z     return super().post(
2025-08-18T15:46:37.6309206Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T15:46:37.6309860Z     return self.request(
2025-08-18T15:46:37.6310429Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:37.6310900Z     return super().request(
2025-08-18T15:46:37.6311299Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:37.6311837Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:37.6312185Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6312618Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:37.6313062Z     response = self._send_handling_auth(
2025-08-18T15:46:37.6313542Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:37.6314038Z     response = self._send_handling_redirects(
2025-08-18T15:46:37.6314543Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:37.6315073Z     response = self._send_single_request(request)
2025-08-18T15:46:37.6315504Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6315985Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:37.6316489Z     response = transport.handle_request(request)
2025-08-18T15:46:37.6316751Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6317232Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:37.6317703Z     raise exc
2025-08-18T15:46:37.6318122Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:37.6318629Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:37.6319090Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:37.6319712Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:37.6320046Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6320474Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:37.6320897Z     return self.__get_result()
2025-08-18T15:46:37.6321110Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6321515Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:37.6321956Z     raise self._exception
2025-08-18T15:46:37.6322374Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:37.6322841Z     retval = await retval_or_awaitable
2025-08-18T15:46:37.6323075Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6323516Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:37.6324010Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:37.6324499Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:37.6325007Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6325528Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:37.6326004Z     raise exc
2025-08-18T15:46:37.6326432Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:37.6326930Z     await self.app(scope, receive, _send)
2025-08-18T15:46:37.6327429Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:37.6327976Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:37.6328664Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:37.6329264Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:37.6330068Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6330562Z     raise exc
2025-08-18T15:46:37.6330988Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6331496Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6332088Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:37.6332679Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6333287Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:37.6334075Z     await route.handle(scope, receive, send)
2025-08-18T15:46:37.6334595Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:37.6335320Z     await self.app(scope, receive, send)
2025-08-18T15:46:37.6335932Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:37.6388780Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:37.6389727Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6390295Z     raise exc
2025-08-18T15:46:37.6390760Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6391284Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6391748Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:37.6392230Z     response = await f(request)
2025-08-18T15:46:37.6392449Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6392855Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:37.6393318Z     solved_result = await solve_dependencies(
2025-08-18T15:46:37.6393874Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:37.6394430Z     solved = await call(**solved_result.values)
2025-08-18T15:46:37.6394684Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6394947Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6395144Z 
2025-08-18T15:46:37.6395327Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f682c64cf20>
2025-08-18T15:46:37.6395725Z request = <starlette.requests.Request object at 0x7f682c65f200>
2025-08-18T15:46:37.6396129Z response = <starlette.responses.Response object at 0x7f682c65f4a0>
2025-08-18T15:46:37.6396380Z 
2025-08-18T15:46:37.6396529Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:37.6396850Z         if not FastAPILimiter.redis:
2025-08-18T15:46:37.6397215Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:37.6397699Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:37.6397975Z 
2025-08-18T15:46:37.6398290Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:37.6398833Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:37.6432061Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "bec406470d1a42a48efdf4ae13af7340", "level": "error", "timestamp": "2025-08-18T15:45:40.727900Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f682c65eff0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f682c89fb00>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682c6a5080>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f682c65f1a0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682c6a5080>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "bec406470d1a42a48efdf4ae13af7340", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f682c65ec90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f682c65f0b0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682c8b4f20>", "conn": "<starlette.requests.Request object at 0x7f682c65f0b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682c8b4f20>", "conn": "<starlette.requests.Request object at 0x7f682c65f0b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682c8b4f20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682c8b4f20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f682c8c23e0>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c6a5620>", "request": "<starlette.requests.Request object at 0x7f682c65f200>", "f": "<function get_request_handler.<locals>.app at 0x7f682c8c3420>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c6a5620>", "conn": "<starlette.requests.Request object at 0x7f682c65f200>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682c6a5620>", "conn": "<starlette.requests.Request object at 0x7f682c65f200>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c8c19e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f682c8c3420>", "request": "<starlette.requests.Request object at 0x7f682c65f200>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c65f200>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f682c65f350>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c65f470>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682ef741a0>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c65f200>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f682c65f4a0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682ef741a0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c65f470>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682c64cf20>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f68\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682c64cf20>", "request": "<starlette.requests.Request object at 0x7f682c65f200>", "response": "<starlette.responses.Response object at 0x7f682c65f4a0>"}}]}]}
2025-08-18T15:46:37.6465701Z _____________________________ test_health_endpoint _____________________________
2025-08-18T15:46:37.6465933Z 
2025-08-18T15:46:37.6466123Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f682cc726c0>
2025-08-18T15:46:37.6466388Z 
2025-08-18T15:46:37.6466486Z     def test_health_endpoint(monkeypatch):
2025-08-18T15:46:37.6466962Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T15:46:37.6467275Z         client = TestClient(app)
2025-08-18T15:46:37.6467507Z >       r = client.get("/health")
2025-08-18T15:46:37.6467726Z             ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6467858Z 
2025-08-18T15:46:37.6467943Z tests/test_api_fast.py:25: 
2025-08-18T15:46:37.6468190Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6468671Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T15:46:37.6469126Z     return super().get(
2025-08-18T15:46:37.6469510Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T15:46:37.6470039Z     return self.request(
2025-08-18T15:46:37.6470462Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:37.6470918Z     return super().request(
2025-08-18T15:46:37.6471331Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:37.6471857Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:37.6472328Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6472768Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:37.6473201Z     response = self._send_handling_auth(
2025-08-18T15:46:37.6473667Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:37.6474161Z     response = self._send_handling_redirects(
2025-08-18T15:46:37.6474666Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:37.6475180Z     response = self._send_single_request(request)
2025-08-18T15:46:37.6475443Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6475918Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:37.6476433Z     response = transport.handle_request(request)
2025-08-18T15:46:37.6476690Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6477162Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:37.6477634Z     raise exc
2025-08-18T15:46:37.6478042Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:37.6478545Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:37.6479001Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:37.6479514Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:37.6479936Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6480366Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:37.6480795Z     return self.__get_result()
2025-08-18T15:46:37.6481001Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6481404Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:37.6481841Z     raise self._exception
2025-08-18T15:46:37.6482261Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:37.6482724Z     retval = await retval_or_awaitable
2025-08-18T15:46:37.6482957Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6483405Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:37.6483893Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:37.6484379Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:37.6485008Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6485538Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:37.6486004Z     raise exc
2025-08-18T15:46:37.6486422Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:37.6486918Z     await self.app(scope, receive, _send)
2025-08-18T15:46:37.6487406Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:37.6487946Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:37.6488499Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:37.6489100Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:37.6489906Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6490539Z     raise exc
2025-08-18T15:46:37.6490974Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6491486Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6491940Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:37.6492433Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6492907Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:37.6493356Z     await route.handle(scope, receive, send)
2025-08-18T15:46:37.6493806Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:37.6494265Z     await self.app(scope, receive, send)
2025-08-18T15:46:37.6494696Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:37.6495221Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:37.6495811Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6496298Z     raise exc
2025-08-18T15:46:37.6496724Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6497311Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6498020Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:37.6498728Z     response = await f(request)
2025-08-18T15:46:37.6499120Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6499929Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:37.6500740Z     solved_result = await solve_dependencies(
2025-08-18T15:46:37.6501406Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:37.6501986Z     solved = await call(**solved_result.values)
2025-08-18T15:46:37.6502251Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6502517Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6502715Z 
2025-08-18T15:46:37.6502897Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>
2025-08-18T15:46:37.6503298Z request = <starlette.requests.Request object at 0x7f682cc8a900>
2025-08-18T15:46:37.6503696Z response = <starlette.responses.Response object at 0x7f682cc8ac90>
2025-08-18T15:46:37.6503941Z 
2025-08-18T15:46:37.6504095Z     async def __call__(self, request: Request, response: Response):
2025-08-18T15:46:37.6504566Z         if not FastAPILimiter.redis:
2025-08-18T15:46:37.6504940Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T15:46:37.6505426Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:37.6505698Z 
2025-08-18T15:46:37.6506018Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T15:46:37.6506557Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:37.6539474Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "7870addd1b1545f3855e0d610fc605b6", "level": "error", "timestamp": "2025-08-18T15:45:41.479702Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f682cc8af90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f682cc259e0>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682cc0aa20>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f682cc89700>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682cc0aa20>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "7870addd1b1545f3855e0d610fc605b6", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f682cc8ad50>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f682cc89c40>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "conn": "<starlette.requests.Request object at 0x7f682cc89c40>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "conn": "<starlette.requests.Request object at 0x7f682cc89c40>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f682f360cc0>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682cc0b1a0>", "request": "<starlette.requests.Request object at 0x7f682cc8a900>", "f": "<function get_request_handler.<locals>.app at 0x7f682f28ef20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682cc0b1a0>", "conn": "<starlette.requests.Request object at 0x7f682cc8a900>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682cc0b1a0>", "conn": "<starlette.requests.Request object at 0x7f682cc8a900>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c90bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f682f28ef20>", "request": "<starlette.requests.Request object at 0x7f682cc8a900>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682cc8a900>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f682cc8a990>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682cc8ae10>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25e000>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682cc8a900>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f682cc8ac90>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25e000>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682cc8ae10>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f68\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "request": "<starlette.requests.Request object at 0x7f682cc8a900>", "response": "<starlette.responses.Response object at 0x7f682cc8ac90>"}}]}]}
2025-08-18T15:46:37.6572733Z __________________________ test_validation_error_json __________________________
2025-08-18T15:46:37.6572975Z 
2025-08-18T15:46:37.6573172Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T15:46:37.6573544Z disable_decoding = False, timeout = None
2025-08-18T15:46:37.6573721Z 
2025-08-18T15:46:37.6573804Z     async def read_response(
2025-08-18T15:46:37.6574019Z         self,
2025-08-18T15:46:37.6574199Z         disable_decoding: bool = False,
2025-08-18T15:46:37.6574450Z         timeout: Optional[float] = None,
2025-08-18T15:46:37.6574677Z         *,
2025-08-18T15:46:37.6574850Z         disconnect_on_error: bool = True,
2025-08-18T15:46:37.6575114Z         push_request: Optional[bool] = False,
2025-08-18T15:46:37.6575354Z     ):
2025-08-18T15:46:37.6575709Z         """Read the response from a previously sent command"""
2025-08-18T15:46:37.6576087Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T15:46:37.6576433Z         host_error = self._host_error()
2025-08-18T15:46:37.6576660Z         try:
2025-08-18T15:46:37.6576817Z             if (
2025-08-18T15:46:37.6577001Z                 read_timeout is not None
2025-08-18T15:46:37.6577249Z                 and self.protocol in ["3", 3]
2025-08-18T15:46:37.6577494Z                 and not HIREDIS_AVAILABLE
2025-08-18T15:46:37.6577718Z             ):
2025-08-18T15:46:37.6577919Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:37.6578217Z                     response = await self._parser.read_response(
2025-08-18T15:46:37.6578568Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:37.6578885Z                     )
2025-08-18T15:46:37.6579080Z             elif read_timeout is not None:
2025-08-18T15:46:37.6579349Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:37.6579749Z                     response = await self._parser.read_response(
2025-08-18T15:46:37.6580044Z                         disable_decoding=disable_decoding
2025-08-18T15:46:37.6580285Z                     )
2025-08-18T15:46:37.6580532Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T15:46:37.6580862Z                 response = await self._parser.read_response(
2025-08-18T15:46:37.6581197Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:37.6581494Z                 )
2025-08-18T15:46:37.6581664Z             else:
2025-08-18T15:46:37.6581865Z >               response = await self._parser.read_response(
2025-08-18T15:46:37.6582156Z                     disable_decoding=disable_decoding
2025-08-18T15:46:37.6582399Z                 )
2025-08-18T15:46:37.6582500Z 
2025-08-18T15:46:37.6582796Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: 
2025-08-18T15:46:37.6583279Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6583792Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T15:46:37.6584367Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T15:46:37.6584716Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6585207Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T15:46:37.6585695Z     raw = await self._readline()
2025-08-18T15:46:37.6585916Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6586346Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T15:46:37.6586941Z     data = await self._stream.readline()
2025-08-18T15:46:37.6587186Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6587570Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T15:46:37.6587972Z     line = await self.readuntil(sep)
2025-08-18T15:46:37.6588202Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6588580Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T15:46:37.6588987Z     await self._wait_for_data('readuntil')
2025-08-18T15:46:37.6589270Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6589469Z 
2025-08-18T15:46:37.6589746Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=18>>
2025-08-18T15:46:37.6590088Z func_name = 'readuntil'
2025-08-18T15:46:37.6590211Z 
2025-08-18T15:46:37.6590309Z     async def _wait_for_data(self, func_name):
2025-08-18T15:46:37.6590604Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T15:46:37.6590856Z     
2025-08-18T15:46:37.6591167Z         If stream was paused, automatically resume it.
2025-08-18T15:46:37.6591425Z         """
2025-08-18T15:46:37.6591684Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T15:46:37.6592090Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T15:46:37.6592473Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T15:46:37.6592806Z         # which coroutine would get the next data.
2025-08-18T15:46:37.6593067Z         if self._waiter is not None:
2025-08-18T15:46:37.6593297Z             raise RuntimeError(
2025-08-18T15:46:37.6593560Z                 f'{func_name}() called while another coroutine is '
2025-08-18T15:46:37.6593856Z                 f'already waiting for incoming data')
2025-08-18T15:46:37.6594090Z     
2025-08-18T15:46:37.6594295Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T15:46:37.6594554Z     
2025-08-18T15:46:37.6594792Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T15:46:37.6595191Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T15:46:37.6595505Z         if self._paused:
2025-08-18T15:46:37.6595708Z             self._paused = False
2025-08-18T15:46:37.6595942Z             self._transport.resume_reading()
2025-08-18T15:46:37.6596173Z     
2025-08-18T15:46:37.6596355Z         self._waiter = self._loop.create_future()
2025-08-18T15:46:37.6596593Z         try:
2025-08-18T15:46:37.6596767Z >           await self._waiter
2025-08-18T15:46:37.6598193Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T15:46:37.6599654Z 
2025-08-18T15:46:37.6599900Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T15:46:37.6600228Z 
2025-08-18T15:46:37.6600399Z During handling of the above exception, another exception occurred:
2025-08-18T15:46:37.6600642Z 
2025-08-18T15:46:37.6600738Z     def test_validation_error_json() -> None:
2025-08-18T15:46:37.6601015Z         prev_user = os.environ.get("BASIC_USER")
2025-08-18T15:46:37.6601285Z         prev_pass = os.environ.get("BASIC_PASS")
2025-08-18T15:46:37.6601553Z         os.environ["ROI_BASIC_AUTH_USER"] = "u"
2025-08-18T15:46:37.6601829Z         os.environ["ROI_BASIC_AUTH_PASSWORD"] = "p"
2025-08-18T15:46:37.6602102Z         os.environ["BASIC_USER"] = "u"
2025-08-18T15:46:37.6602345Z         os.environ["BASIC_PASS"] = "p"
2025-08-18T15:46:37.6602681Z         try:
2025-08-18T15:46:37.6602858Z             client = TestClient(app)
2025-08-18T15:46:37.6603113Z             auth = base64.b64encode(b"u:p").decode()
2025-08-18T15:46:37.6603371Z >           resp = client.get(
2025-08-18T15:46:37.6603675Z                 "/roi-review?vendor=abc", headers={"Authorization": f"Basic {auth}"}
2025-08-18T15:46:37.6603994Z             )
2025-08-18T15:46:37.6604094Z 
2025-08-18T15:46:37.6604196Z services/api/tests/test_errors_json.py:21: 
2025-08-18T15:46:37.6604475Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6604962Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T15:46:37.6605414Z     return super().get(
2025-08-18T15:46:37.6605800Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T15:46:37.6606234Z     return self.request(
2025-08-18T15:46:37.6606672Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:37.6607146Z     return super().request(
2025-08-18T15:46:37.6607673Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:37.6608209Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:37.6608560Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6608998Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:37.6609441Z     response = self._send_handling_auth(
2025-08-18T15:46:37.6610140Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:37.6610642Z     response = self._send_handling_redirects(
2025-08-18T15:46:37.6611148Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:37.6611677Z     response = self._send_single_request(request)
2025-08-18T15:46:37.6611945Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6612432Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:37.6612947Z     response = transport.handle_request(request)
2025-08-18T15:46:37.6613210Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6613687Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:37.6614160Z     raise exc
2025-08-18T15:46:37.6614579Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:37.6615089Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:37.6615541Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:37.6616061Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:37.6616385Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6616824Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:37.6617245Z     return self.__get_result()
2025-08-18T15:46:37.6617461Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6617871Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:37.6618311Z     raise self._exception
2025-08-18T15:46:37.6618729Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:37.6619200Z     retval = await retval_or_awaitable
2025-08-18T15:46:37.6619435Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6619977Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:37.6620602Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:37.6621093Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:37.6621609Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6622129Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:37.6622608Z     raise exc
2025-08-18T15:46:37.6623026Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:37.6623520Z     await self.app(scope, receive, _send)
2025-08-18T15:46:37.6624016Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:37.6624562Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:37.6625115Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:37.6625720Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:37.6626430Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6626918Z     raise exc
2025-08-18T15:46:37.6627345Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6627845Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6628295Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:37.6628786Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6629254Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:37.6629813Z     await route.handle(scope, receive, send)
2025-08-18T15:46:37.6630279Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:37.6630741Z     await self.app(scope, receive, send)
2025-08-18T15:46:37.6631173Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:37.6631704Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:37.6632301Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6632781Z     raise exc
2025-08-18T15:46:37.6633207Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6633707Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6634133Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:37.6634564Z     response = await f(request)
2025-08-18T15:46:37.6634784Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6635183Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:37.6635639Z     solved_result = await solve_dependencies(
2025-08-18T15:46:37.6636187Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:37.6636740Z     solved = await call(**solved_result.values)
2025-08-18T15:46:37.6637000Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6637462Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T15:46:37.6637940Z     pexpire = await self._check(key)
2025-08-18T15:46:37.6638174Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6638608Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T15:46:37.6639208Z     pexpire = await redis.evalsha(
2025-08-18T15:46:37.6639797Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:646: in execute_command
2025-08-18T15:46:37.6640312Z     return await conn.retry.call_with_retry(
2025-08-18T15:46:37.6640801Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T15:46:37.6641283Z     return await do()
2025-08-18T15:46:37.6641468Z            ^^^^^^^^^^
2025-08-18T15:46:37.6641949Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:620: in _send_command_parse_response
2025-08-18T15:46:37.6642574Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T15:46:37.6642899Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6643390Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:667: in parse_response
2025-08-18T15:46:37.6643908Z     response = await connection.read_response()
2025-08-18T15:46:37.6644168Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6644778Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:582: in read_response
2025-08-18T15:46:37.6645285Z     await self.disconnect(nowait=True)
2025-08-18T15:46:37.6645762Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:438: in disconnect
2025-08-18T15:46:37.6646287Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T15:46:37.6646553Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6646891Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T15:46:37.6647288Z     return self._transport.close()
2025-08-18T15:46:37.6647515Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6647912Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T15:46:37.6648320Z     super().close()
2025-08-18T15:46:37.6648681Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T15:46:37.6649153Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T15:46:37.6649809Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T15:46:37.6650246Z     self._check_closed()
2025-08-18T15:46:37.6650487Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6650681Z 
2025-08-18T15:46:37.6650858Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T15:46:37.6651110Z 
2025-08-18T15:46:37.6651189Z     def _check_closed(self):
2025-08-18T15:46:37.6651402Z         if self._closed:
2025-08-18T15:46:37.6651632Z >           raise RuntimeError('Event loop is closed')
2025-08-18T15:46:37.6651906Z E           RuntimeError: Event loop is closed
2025-08-18T15:46:37.6652084Z 
2025-08-18T15:46:37.6652341Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T15:46:37.6652828Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:37.6705958Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "ccb5d55d5d4942d4b91a652d6d3ec13c", "level": "error", "timestamp": "2025-08-18T15:46:35.173952Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f682cc8af90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f682c3bb380>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682c2ebf60>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f682cacef30>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682c2ebf60>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+150", "header_value": "None", "validation_failed": "False", "id_value": "ccb5d55d5d4942d4b91a652d6d3ec13c", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f682cc8ad50>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f682c220980>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "conn": "<starlette.requests.Request object at 0x7f682c220980>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "conn": "<starlette.requests.Request object at 0x7f682c220980>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function roi_review at 0x7f682f361940>, 'path_params': {}, 'route'\"+67"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682ca02de0>", "request": "<starlette.requests.Request object at 0x7f682c220920>", "f": "<function get_request_handler.<locals>.app at 0x7f682f28e340>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682ca02de0>", "conn": "<starlette.requests.Request object at 0x7f682c220920>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682ca02de0>", "conn": "<starlette.requests.Request object at 0x7f682c220920>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682c3bb600'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f682f28e340>", "request": "<starlette.requests.Request object at 0x7f682c220920>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c220920>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f682c220350>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c220110>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25e000>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "False", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c220920>", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f682c2200b0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25e000>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c220110>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "use_path": "/roi-review", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f68\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "request": "<starlette.requests.Request object at 0x7f682c220920>", "response": "<starlette.responses.Response object at 0x7f682c2200b0>", "route_index": "8", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f682f28cc20>", "callback": "<function http_default_callback at 0x7f682fc45b20>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:8:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "key": "fastapi-limiter:testclient:8:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 646, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f682ca7eac0>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f682ca74a40>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f682c3baf20>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 620, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 667, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 582, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 438, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=18> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f682cab3cb0>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f682cab3cb0>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f682cab3cb0>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "func_name": "readuntil"}}]}]}
2025-08-18T15:46:37.6759426Z ______________________________ test_health_route _______________________________
2025-08-18T15:46:37.6759745Z 
2025-08-18T15:46:37.6759950Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T15:46:37.6760321Z disable_decoding = False, timeout = None
2025-08-18T15:46:37.6760499Z 
2025-08-18T15:46:37.6760581Z     async def read_response(
2025-08-18T15:46:37.6760810Z         self,
2025-08-18T15:46:37.6760998Z         disable_decoding: bool = False,
2025-08-18T15:46:37.6761247Z         timeout: Optional[float] = None,
2025-08-18T15:46:37.6761474Z         *,
2025-08-18T15:46:37.6761653Z         disconnect_on_error: bool = True,
2025-08-18T15:46:37.6761905Z         push_request: Optional[bool] = False,
2025-08-18T15:46:37.6762142Z     ):
2025-08-18T15:46:37.6762360Z         """Read the response from a previously sent command"""
2025-08-18T15:46:37.6762731Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T15:46:37.6763080Z         host_error = self._host_error()
2025-08-18T15:46:37.6763304Z         try:
2025-08-18T15:46:37.6763467Z             if (
2025-08-18T15:46:37.6763656Z                 read_timeout is not None
2025-08-18T15:46:37.6763904Z                 and self.protocol in ["3", 3]
2025-08-18T15:46:37.6764155Z                 and not HIREDIS_AVAILABLE
2025-08-18T15:46:37.6764377Z             ):
2025-08-18T15:46:37.6764579Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:37.6764882Z                     response = await self._parser.read_response(
2025-08-18T15:46:37.6765229Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:37.6765536Z                     )
2025-08-18T15:46:37.6765736Z             elif read_timeout is not None:
2025-08-18T15:46:37.6765995Z                 async with async_timeout(read_timeout):
2025-08-18T15:46:37.6766290Z                     response = await self._parser.read_response(
2025-08-18T15:46:37.6766719Z                         disable_decoding=disable_decoding
2025-08-18T15:46:37.6766965Z                     )
2025-08-18T15:46:37.6767215Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T15:46:37.6767549Z                 response = await self._parser.read_response(
2025-08-18T15:46:37.6767894Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T15:46:37.6768188Z                 )
2025-08-18T15:46:37.6768372Z             else:
2025-08-18T15:46:37.6768583Z >               response = await self._parser.read_response(
2025-08-18T15:46:37.6768865Z                     disable_decoding=disable_decoding
2025-08-18T15:46:37.6769101Z                 )
2025-08-18T15:46:37.6769206Z 
2025-08-18T15:46:37.6769494Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: 
2025-08-18T15:46:37.6770226Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6770739Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T15:46:37.6771447Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T15:46:37.6771794Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6772283Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T15:46:37.6772767Z     raw = await self._readline()
2025-08-18T15:46:37.6772988Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6773424Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T15:46:37.6773901Z     data = await self._stream.readline()
2025-08-18T15:46:37.6774141Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6774526Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T15:46:37.6774945Z     line = await self.readuntil(sep)
2025-08-18T15:46:37.6775173Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6775562Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T15:46:37.6775975Z     await self._wait_for_data('readuntil')
2025-08-18T15:46:37.6776251Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6776448Z 
2025-08-18T15:46:37.6776629Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=20>>
2025-08-18T15:46:37.6776967Z func_name = 'readuntil'
2025-08-18T15:46:37.6777089Z 
2025-08-18T15:46:37.6777192Z     async def _wait_for_data(self, func_name):
2025-08-18T15:46:37.6777477Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T15:46:37.6777730Z     
2025-08-18T15:46:37.6777926Z         If stream was paused, automatically resume it.
2025-08-18T15:46:37.6778180Z         """
2025-08-18T15:46:37.6778441Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T15:46:37.6778845Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T15:46:37.6779240Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T15:46:37.6779678Z         # which coroutine would get the next data.
2025-08-18T15:46:37.6779943Z         if self._waiter is not None:
2025-08-18T15:46:37.6780176Z             raise RuntimeError(
2025-08-18T15:46:37.6780442Z                 f'{func_name}() called while another coroutine is '
2025-08-18T15:46:37.6780750Z                 f'already waiting for incoming data')
2025-08-18T15:46:37.6780991Z     
2025-08-18T15:46:37.6781188Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T15:46:37.6781439Z     
2025-08-18T15:46:37.6781681Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T15:46:37.6782087Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T15:46:37.6782535Z         if self._paused:
2025-08-18T15:46:37.6782740Z             self._paused = False
2025-08-18T15:46:37.6782982Z             self._transport.resume_reading()
2025-08-18T15:46:37.6783210Z     
2025-08-18T15:46:37.6783393Z         self._waiter = self._loop.create_future()
2025-08-18T15:46:37.6783637Z         try:
2025-08-18T15:46:37.6783807Z >           await self._waiter
2025-08-18T15:46:37.6785233Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T15:46:37.6786587Z 
2025-08-18T15:46:37.6786830Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T15:46:37.6787173Z 
2025-08-18T15:46:37.6787336Z During handling of the above exception, another exception occurred:
2025-08-18T15:46:37.6787695Z 
2025-08-18T15:46:37.6787787Z     def test_health_route() -> None:
2025-08-18T15:46:37.6788019Z         class FakeSession:
2025-08-18T15:46:37.6788239Z             async def execute(self, query):
2025-08-18T15:46:37.6788472Z                 class R:
2025-08-18T15:46:37.6788666Z                     def scalar(self):
2025-08-18T15:46:37.6788900Z                         import datetime
2025-08-18T15:46:37.6789116Z     
2025-08-18T15:46:37.6789304Z                         return datetime.datetime.utcnow()
2025-08-18T15:46:37.6789647Z     
2025-08-18T15:46:37.6789806Z                 return R()
2025-08-18T15:46:37.6789990Z     
2025-08-18T15:46:37.6790149Z         async def fake_get_session():
2025-08-18T15:46:37.6790384Z             yield FakeSession()
2025-08-18T15:46:37.6790585Z     
2025-08-18T15:46:37.6790807Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T15:46:37.6791126Z         client = TestClient(app)
2025-08-18T15:46:37.6791353Z >       resp = client.get("/health")
2025-08-18T15:46:37.6791575Z                ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6791721Z 
2025-08-18T15:46:37.6791814Z services/api/tests/test_health.py:23: 
2025-08-18T15:46:37.6792091Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6792590Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T15:46:37.6793038Z     return super().get(
2025-08-18T15:46:37.6793429Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T15:46:37.6793860Z     return self.request(
2025-08-18T15:46:37.6794283Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T15:46:37.6794749Z     return super().request(
2025-08-18T15:46:37.6795163Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T15:46:37.6795703Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T15:46:37.6796049Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6796487Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T15:46:37.6796930Z     response = self._send_handling_auth(
2025-08-18T15:46:37.6797420Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T15:46:37.6797912Z     response = self._send_handling_redirects(
2025-08-18T15:46:37.6798421Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T15:46:37.6798943Z     response = self._send_single_request(request)
2025-08-18T15:46:37.6799205Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6799904Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T15:46:37.6800428Z     response = transport.handle_request(request)
2025-08-18T15:46:37.6800691Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6801171Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T15:46:37.6801651Z     raise exc
2025-08-18T15:46:37.6802070Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T15:46:37.6802574Z     portal.call(self.app, scope, receive, send)
2025-08-18T15:46:37.6803038Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T15:46:37.6803560Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T15:46:37.6803889Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6804325Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T15:46:37.6804874Z     return self.__get_result()
2025-08-18T15:46:37.6805088Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6805493Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T15:46:37.6805939Z     raise self._exception
2025-08-18T15:46:37.6806365Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T15:46:37.6806840Z     retval = await retval_or_awaitable
2025-08-18T15:46:37.6807070Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6807522Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T15:46:37.6808016Z     await super().__call__(scope, receive, send)
2025-08-18T15:46:37.6808502Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T15:46:37.6809019Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6809709Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T15:46:37.6810249Z     raise exc
2025-08-18T15:46:37.6810670Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T15:46:37.6811180Z     await self.app(scope, receive, _send)
2025-08-18T15:46:37.6811684Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T15:46:37.6812230Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T15:46:37.6812791Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T15:46:37.6813396Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T15:46:37.6814002Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6814487Z     raise exc
2025-08-18T15:46:37.6814918Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6815421Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6815872Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T15:46:37.6816357Z     await self.middleware_stack(scope, receive, send)
2025-08-18T15:46:37.6816829Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T15:46:37.6817289Z     await route.handle(scope, receive, send)
2025-08-18T15:46:37.6817747Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T15:46:37.6818333Z     await self.app(scope, receive, send)
2025-08-18T15:46:37.6818772Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T15:46:37.6819303Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T15:46:37.6819993Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T15:46:37.6820478Z     raise exc
2025-08-18T15:46:37.6820906Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T15:46:37.6821410Z     await app(scope, receive, sender)
2025-08-18T15:46:37.6821837Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T15:46:37.6822275Z     response = await f(request)
2025-08-18T15:46:37.6822491Z                ^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6822897Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T15:46:37.6823360Z     solved_result = await solve_dependencies(
2025-08-18T15:46:37.6824025Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T15:46:37.6824580Z     solved = await call(**solved_result.values)
2025-08-18T15:46:37.6824836Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6825302Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T15:46:37.6825784Z     pexpire = await self._check(key)
2025-08-18T15:46:37.6826009Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6826455Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T15:46:37.6826927Z     pexpire = await redis.evalsha(
2025-08-18T15:46:37.6827411Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:646: in execute_command
2025-08-18T15:46:37.6827923Z     return await conn.retry.call_with_retry(
2025-08-18T15:46:37.6828414Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T15:46:37.6828895Z     return await do()
2025-08-18T15:46:37.6829075Z            ^^^^^^^^^^
2025-08-18T15:46:37.6829663Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:620: in _send_command_parse_response
2025-08-18T15:46:37.6830287Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T15:46:37.6830617Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6831108Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:667: in parse_response
2025-08-18T15:46:37.6831621Z     response = await connection.read_response()
2025-08-18T15:46:37.6831883Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6832374Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:582: in read_response
2025-08-18T15:46:37.6832887Z     await self.disconnect(nowait=True)
2025-08-18T15:46:37.6833372Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:438: in disconnect
2025-08-18T15:46:37.6833896Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T15:46:37.6834156Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6834499Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T15:46:37.6834897Z     return self._transport.close()
2025-08-18T15:46:37.6835123Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T15:46:37.6835512Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T15:46:37.6835923Z     super().close()
2025-08-18T15:46:37.6836284Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T15:46:37.6836871Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T15:46:37.6837333Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T15:46:37.6837748Z     self._check_closed()
2025-08-18T15:46:37.6837980Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T15:46:37.6838180Z 
2025-08-18T15:46:37.6838351Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T15:46:37.6838610Z 
2025-08-18T15:46:37.6838688Z     def _check_closed(self):
2025-08-18T15:46:37.6838899Z         if self._closed:
2025-08-18T15:46:37.6839121Z >           raise RuntimeError('Event loop is closed')
2025-08-18T15:46:37.6839405Z E           RuntimeError: Event loop is closed
2025-08-18T15:46:37.6839686Z 
2025-08-18T15:46:37.6839946Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T15:46:37.6840427Z ------------------------------ Captured log call -------------------------------
2025-08-18T15:46:38.0755134Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "6e844f77968d4ddb9654cb681caaee03", "level": "error", "timestamp": "2025-08-18T15:46:35.883882Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f682cc8af90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f682ca03420>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682ca03b00>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f682c23f800>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f682ca03b00>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "6e844f77968d4ddb9654cb681caaee03", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f682cc8ad50>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f682c23fe60>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "conn": "<starlette.requests.Request object at 0x7f682c23fe60>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "conn": "<starlette.requests.Request object at 0x7f682c23fe60>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f682f25ea20>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f682f360cc0>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682ca03740>", "request": "<starlette.requests.Request object at 0x7f682c23c050>", "f": "<function get_request_handler.<locals>.app at 0x7f682f28ef20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682ca03740>", "conn": "<starlette.requests.Request object at 0x7f682c23c050>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f682ca03740>", "conn": "<starlette.requests.Request object at 0x7f682c23c050>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f682ca02840'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f682f28ef20>", "request": "<starlette.requests.Request object at 0x7f682c23c050>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c23c050>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f682c23c1d0>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c23c200>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25e000>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f682c23c050>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f682c23c230>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f682f25e000>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f682c23c200>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f68\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "request": "<starlette.requests.Request object at 0x7f682c23c050>", "response": "<starlette.responses.Response object at 0x7f682c23c230>", "route_index": "13", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f682f28cc20>", "callback": "<function http_default_callback at 0x7f682fc45b20>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:13:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f682f35d430>", "key": "fastapi-limiter:testclient:13:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 646, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f682ca7eac0>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f682ca03e20>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f682ca03ec0>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 620, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 667, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 582, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 438, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=20> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=20>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f682cab3cb0>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f682cab3cb0>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f682cab3cb0>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=20>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=20>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=20>>", "func_name": "readuntil"}}]}]}
2025-08-18T15:46:38.0808372Z =============================== warnings summary ===============================
2025-08-18T15:46:38.0808821Z services/alert_bot/tests/test_smoke.py:5
2025-08-18T15:46:38.0810062Z   /home/runner/work/AWA-App/AWA-App/services/alert_bot/tests/test_smoke.py:5: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
2025-08-18T15:46:38.0811160Z     import pkg_resources  # noqa: F401
2025-08-18T15:46:38.0811335Z 
2025-08-18T15:46:38.0811446Z tests/api/test_ingest_endpoints.py: 3 warnings
2025-08-18T15:46:38.0811733Z tests/ingest/test_tasks_eager.py: 3 warnings
2025-08-18T15:46:38.0811993Z tests/test_api_fast.py: 1 warning
2025-08-18T15:46:38.0812225Z tests/test_health.py: 5 warnings
2025-08-18T15:46:38.0812456Z tests/test_smoke.py: 5 warnings
2025-08-18T15:46:38.0812694Z services/api/tests/test_cors.py: 1 warning
2025-08-18T15:46:38.0812981Z services/api/tests/test_errors_json.py: 2 warnings
2025-08-18T15:46:38.0813282Z services/api/tests/test_health.py: 1 warning
2025-08-18T15:46:38.0813569Z services/api/tests/test_rate_limit.py: 122 warnings
2025-08-18T15:46:38.0815015Z   /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/extensions/sentry.py:27: DeprecationWarning: sentry_sdk.configure_scope is deprecated and will be removed in the next major version. Please consult our migration guide to learn how to migrate to the new API: https://docs.sentry.io/platforms/python/migration/1.x-to-2.x#scope-configuring
2025-08-18T15:46:38.0816287Z     with configure_scope() as scope:
2025-08-18T15:46:38.0816454Z 
2025-08-18T15:46:38.0816583Z tests/test_health.py::test_health[0]
2025-08-18T15:46:38.0816822Z tests/test_health.py::test_health[1]
2025-08-18T15:46:38.0817052Z tests/test_health.py::test_health[2]
2025-08-18T15:46:38.0817276Z tests/test_health.py::test_health[3]
2025-08-18T15:46:38.0817658Z tests/test_health.py::test_health[4]
2025-08-18T15:46:38.0818610Z   /home/runner/work/AWA-App/AWA-App/tests/test_health.py:22: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:38.0819733Z     return datetime.datetime.utcnow()
2025-08-18T15:46:38.0820017Z 
2025-08-18T15:46:38.0820109Z tests/test_health.py: 5 warnings
2025-08-18T15:46:38.0820348Z tests/test_smoke.py: 5 warnings
2025-08-18T15:46:38.0820590Z services/api/tests/test_cors.py: 1 warning
2025-08-18T15:46:38.0820875Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T15:46:38.0821898Z   /home/runner/work/AWA-App/AWA-App/services/api/routes/health.py:24: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:38.0822932Z     app_now = datetime.utcnow().replace(tzinfo=timezone.utc)
2025-08-18T15:46:38.0823154Z 
2025-08-18T15:46:38.0823251Z tests/test_smoke.py::test_health[0]
2025-08-18T15:46:38.0823490Z tests/test_smoke.py::test_health[1]
2025-08-18T15:46:38.0823728Z tests/test_smoke.py::test_health[2]
2025-08-18T15:46:38.0823958Z tests/test_smoke.py::test_health[3]
2025-08-18T15:46:38.0824180Z tests/test_smoke.py::test_health[4]
2025-08-18T15:46:38.0825089Z   /home/runner/work/AWA-App/AWA-App/tests/test_smoke.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:38.0826022Z     return datetime.datetime.utcnow()
2025-08-18T15:46:38.0826190Z 
2025-08-18T15:46:38.0826349Z services/api/tests/test_cors.py::test_cors_simple_get_allowed
2025-08-18T15:46:38.0827390Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_cors.py:27: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:38.0828540Z     return datetime.datetime.utcnow()
2025-08-18T15:46:38.0828712Z 
2025-08-18T15:46:38.0828825Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T15:46:38.0829954Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_rate_limit.py:33: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T15:46:38.0830954Z     return datetime.datetime.utcnow()
2025-08-18T15:46:38.0831111Z 
2025-08-18T15:46:38.0831290Z -- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
2025-08-18T15:46:38.0831669Z ================================ tests coverage ================================
2025-08-18T15:46:38.0832034Z _______________ coverage: platform linux, python 3.12.11-final-0 _______________
2025-08-18T15:46:38.0832287Z 
2025-08-18T15:46:38.0832388Z Coverage XML written to file coverage.xml
2025-08-18T15:46:38.0832700Z Required test coverage of 45% reached. Total coverage: 62.43%
2025-08-18T15:46:38.0833158Z =========================== short test summary info ============================
2025-08-18T15:46:38.0833753Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_file_upload - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:38.0834589Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_json_uri - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:38.0835420Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_failure - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:38.0836574Z FAILED tests/test_api_fast.py::test_health_endpoint - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T15:46:38.0837304Z FAILED services/api/tests/test_errors_json.py::test_validation_error_json - RuntimeError: Event loop is closed
2025-08-18T15:46:38.0837938Z FAILED services/api/tests/test_health.py::test_health_route - RuntimeError: Event loop is closed
2025-08-18T15:46:38.4723175Z ##[error]Process completed with exit code 1.
