2025-08-18T17:27:35.4958096Z ##[group]Run pytest -q --cov=services
2025-08-18T17:27:35.4958650Z [36;1mpytest -q --cov=services[0m
2025-08-18T17:27:35.5017694Z shell: /usr/bin/bash -e {0}
2025-08-18T17:27:35.5018146Z env:
2025-08-18T17:27:35.5018479Z   REDIS_URL: redis://localhost:6379/0
2025-08-18T17:27:35.5018918Z   RATE_LIMIT_DEFAULT: 100/minute
2025-08-18T17:27:35.5019327Z   TRUST_X_FORWARDED: 1
2025-08-18T17:27:35.5019662Z   PG_USER: postgres
2025-08-18T17:27:35.5019999Z   PG_PASSWORD: pass
2025-08-18T17:27:35.5020329Z   PG_DATABASE: awa
2025-08-18T17:27:35.5020651Z   PG_HOST: localhost
2025-08-18T17:27:35.5020987Z   PG_PORT: 5432
2025-08-18T17:27:35.5021670Z   PG_SYNC_DSN: ***localhost:5432/awa
2025-08-18T17:27:35.5022396Z   PG_ASYNC_DSN: ***localhost:5432/awa
2025-08-18T17:27:35.5023091Z   DATABASE_URL: ***localhost:5432/awa
2025-08-18T17:27:35.5023519Z   DATA_DIR: /tmp/awa-data
2025-08-18T17:27:35.5023854Z   ENABLE_LIVE: 0
2025-08-18T17:27:35.5024146Z   TESTING: 1
2025-08-18T17:27:35.5024546Z   pythonLocation: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:35.5025293Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib/pkgconfig
2025-08-18T17:27:35.5026192Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:35.5026816Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:35.5027436Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.12.11/x64
2025-08-18T17:27:35.5028053Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.12.11/x64/lib
2025-08-18T17:27:35.5028571Z ##[endgroup]
2025-08-18T17:28:07.1401923Z .....FFFs.............................sssssss.....F..................... [ 47%]
2025-08-18T17:28:39.6881393Z ...............................F.F...................................... [ 94%]
2025-08-18T17:28:40.1346224Z ........                                                                 [100%]
2025-08-18T17:28:40.1347008Z =================================== FAILURES ===================================
2025-08-18T17:28:40.1347474Z ___________________________ test_ingest_file_upload ____________________________
2025-08-18T17:28:40.1347813Z 
2025-08-18T17:28:40.1348078Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f962282c920>
2025-08-18T17:28:40.1348685Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_file_upload0')
2025-08-18T17:28:40.1349057Z 
2025-08-18T17:28:40.1349255Z     def test_ingest_file_upload(monkeypatch, tmp_path) -> None:
2025-08-18T17:28:40.1349801Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T17:28:40.1350382Z             return {"rows": 2, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T17:28:40.1350792Z     
2025-08-18T17:28:40.1351119Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T17:28:40.1351555Z         client = _get_client(monkeypatch)
2025-08-18T17:28:40.1351837Z     
2025-08-18T17:28:40.1352157Z >       resp = client.post("/ingest", files={"file": ("test.csv", b"a,b\n1,2\n")})
2025-08-18T17:28:40.1352593Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1352903Z 
2025-08-18T17:28:40.1353070Z tests/api/test_ingest_endpoints.py:33: 
2025-08-18T17:28:40.1353578Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1354417Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T17:28:40.1354973Z     return super().post(
2025-08-18T17:28:40.1355381Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T17:28:40.1355826Z     return self.request(
2025-08-18T17:28:40.1356525Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:40.1357002Z     return super().request(
2025-08-18T17:28:40.1357417Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:40.1358274Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:40.1358785Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1359248Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:40.1359705Z     response = self._send_handling_auth(
2025-08-18T17:28:40.1360197Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:40.1360706Z     response = self._send_handling_redirects(
2025-08-18T17:28:40.1361226Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:40.1362059Z     response = self._send_single_request(request)
2025-08-18T17:28:40.1362330Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1362807Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:40.1363338Z     response = transport.handle_request(request)
2025-08-18T17:28:40.1363611Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1364087Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:40.1364547Z     raise exc
2025-08-18T17:28:40.1364964Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:40.1365471Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:40.1366102Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:40.1366796Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:40.1367325Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1367760Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:40.1368180Z     return self.__get_result()
2025-08-18T17:28:40.1368400Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1368812Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:40.1369260Z     raise self._exception
2025-08-18T17:28:40.1369685Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:40.1370151Z     retval = await retval_or_awaitable
2025-08-18T17:28:40.1370387Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1370830Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:40.1371320Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:40.1371801Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:40.1372310Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1373006Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:40.1373636Z     raise exc
2025-08-18T17:28:40.1374062Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:40.1374558Z     await self.app(scope, receive, _send)
2025-08-18T17:28:40.1375053Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:40.1375591Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:40.1376361Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:40.1377229Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:40.1377825Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1378502Z     raise exc
2025-08-18T17:28:40.1379048Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1379554Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1380005Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:40.1380499Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1380961Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:40.1381418Z     await route.handle(scope, receive, send)
2025-08-18T17:28:40.1381871Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:40.1382347Z     await self.app(scope, receive, send)
2025-08-18T17:28:40.1383064Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:40.1383597Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:40.1384186Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1384661Z     raise exc
2025-08-18T17:28:40.1385080Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1385586Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1386322Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:40.1386885Z     response = await f(request)
2025-08-18T17:28:40.1387105Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1387507Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:40.1387964Z     solved_result = await solve_dependencies(
2025-08-18T17:28:40.1388521Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:40.1389077Z     solved = await call(**solved_result.values)
2025-08-18T17:28:40.1389330Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1389588Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1389784Z 
2025-08-18T17:28:40.1389961Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f96224c9580>
2025-08-18T17:28:40.1390354Z request = <starlette.requests.Request object at 0x7f9620315a00>
2025-08-18T17:28:40.1390750Z response = <starlette.responses.Response object at 0x7f9620316000>
2025-08-18T17:28:40.1390996Z 
2025-08-18T17:28:40.1391140Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:40.1391452Z         if not FastAPILimiter.redis:
2025-08-18T17:28:40.1391816Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:40.1392293Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.1392568Z 
2025-08-18T17:28:40.1392879Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:40.1393420Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:40.1427263Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "662710bd4c59414389763efe144bd1cd", "level": "error", "timestamp": "2025-08-18T17:27:41.145109Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f9620315640>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f96224fc900>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f9622437880>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f96224bad50>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f9622437880>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+226", "header_value": "None", "validation_failed": "False", "id_value": "662710bd4c59414389763efe144bd1cd", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f96223e9f40>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f9620315850>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e50a0>", "conn": "<starlette.requests.Request object at 0x7f9620315850>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e50a0>", "conn": "<starlette.requests.Request object at 0x7f9620315850>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e50a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e50a0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f9622544fe0>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f96202ee520>", "request": "<starlette.requests.Request object at 0x7f9620315a00>", "f": "<function get_request_handler.<locals>.app at 0x7f9622546840>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f96202ee520>", "conn": "<starlette.requests.Request object at 0x7f9620315a00>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f96202ee520>", "conn": "<starlette.requests.Request object at 0x7f9620315a00>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1570", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96224ffe20'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f9622546840>", "request": "<starlette.requests.Request object at 0x7f9620315a00>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f9620315a00>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f9620315b50>", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f96203141a0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f962327aa50>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f9620315a00>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "\"FormData([('file', UploadFile(filename='test.csv', size=8, headers=Headers({'con\"+98", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f9620316000>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f962327aa50>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f96203141a0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96224c9580>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f96\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f96224c9580>", "request": "<starlette.requests.Request object at 0x7f9620315a00>", "response": "<starlette.responses.Response object at 0x7f9620316000>"}}]}]}
2025-08-18T17:28:40.1461233Z _____________________________ test_ingest_json_uri _____________________________
2025-08-18T17:28:40.1461464Z 
2025-08-18T17:28:40.1461653Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f9620317170>
2025-08-18T17:28:40.1462109Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_json_uri0')
2025-08-18T17:28:40.1462396Z 
2025-08-18T17:28:40.1462541Z     def test_ingest_json_uri(monkeypatch, tmp_path) -> None:
2025-08-18T17:28:40.1462957Z         def fake_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T17:28:40.1463564Z             return {"rows": 1, "dialect": "returns_report", "target_table": "returns_raw"}
2025-08-18T17:28:40.1463988Z     
2025-08-18T17:28:40.1464248Z         monkeypatch.setattr("etl.load_csv.import_file", fake_import_file)
2025-08-18T17:28:40.1464595Z         client = _get_client(monkeypatch)
2025-08-18T17:28:40.1464815Z     
2025-08-18T17:28:40.1464982Z         f = tmp_path / "sample.csv"
2025-08-18T17:28:40.1465216Z         f.write_text("a,b\n1,2\n")
2025-08-18T17:28:40.1465422Z     
2025-08-18T17:28:40.1465644Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T17:28:40.1466114Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1466319Z 
2025-08-18T17:28:40.1466421Z tests/api/test_ingest_endpoints.py:55: 
2025-08-18T17:28:40.1466697Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1467191Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T17:28:40.1467656Z     return super().post(
2025-08-18T17:28:40.1468055Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T17:28:40.1468484Z     return self.request(
2025-08-18T17:28:40.1468907Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:40.1469366Z     return super().request(
2025-08-18T17:28:40.1469764Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:40.1470294Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:40.1470636Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1471062Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:40.1471494Z     response = self._send_handling_auth(
2025-08-18T17:28:40.1471975Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:40.1472471Z     response = self._send_handling_redirects(
2025-08-18T17:28:40.1472970Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:40.1473487Z     response = self._send_single_request(request)
2025-08-18T17:28:40.1473761Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1474239Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:40.1474745Z     response = transport.handle_request(request)
2025-08-18T17:28:40.1475009Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1475478Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:40.1476044Z     raise exc
2025-08-18T17:28:40.1476459Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:40.1476969Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:40.1477428Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:40.1477943Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:40.1478263Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1478680Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:449: in result
2025-08-18T17:28:40.1479102Z     return self.__get_result()
2025-08-18T17:28:40.1479315Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1479711Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:40.1480151Z     raise self._exception
2025-08-18T17:28:40.1480571Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:40.1481284Z     retval = await retval_or_awaitable
2025-08-18T17:28:40.1481514Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1481959Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:40.1482449Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:40.1482924Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:40.1483427Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1483946Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:40.1484420Z     raise exc
2025-08-18T17:28:40.1484830Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:40.1485322Z     await self.app(scope, receive, _send)
2025-08-18T17:28:40.1485819Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:40.1486576Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:40.1487126Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:40.1487725Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:40.1488319Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1488791Z     raise exc
2025-08-18T17:28:40.1489212Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1489709Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1490151Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:40.1490635Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1491120Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:40.1491572Z     await route.handle(scope, receive, send)
2025-08-18T17:28:40.1492015Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:40.1492468Z     await self.app(scope, receive, send)
2025-08-18T17:28:40.1492904Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:40.1493422Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:40.1493998Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1494479Z     raise exc
2025-08-18T17:28:40.1494904Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1495406Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1495824Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:40.1496357Z     response = await f(request)
2025-08-18T17:28:40.1496573Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1496962Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:40.1497414Z     solved_result = await solve_dependencies(
2025-08-18T17:28:40.1497963Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:40.1498509Z     solved = await call(**solved_result.values)
2025-08-18T17:28:40.1498760Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1499020Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1499355Z 
2025-08-18T17:28:40.1499530Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f9620261f40>
2025-08-18T17:28:40.1500079Z request = <starlette.requests.Request object at 0x7f961bca4650>
2025-08-18T17:28:40.1500481Z response = <starlette.responses.Response object at 0x7f961bca48f0>
2025-08-18T17:28:40.1500732Z 
2025-08-18T17:28:40.1500877Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:40.1501193Z         if not FastAPILimiter.redis:
2025-08-18T17:28:40.1501563Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:40.1502039Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.1502315Z 
2025-08-18T17:28:40.1502618Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:40.1503156Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:40.1536408Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "402082a9951e493cbfd28b0cb061e73b", "level": "error", "timestamp": "2025-08-18T17:27:41.822451Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f961bca4440>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f9622547ce0>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f96202751c0>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f96203175c0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f96202751c0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "402082a9951e493cbfd28b0cb061e73b", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f961bca4260>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f961bca4500>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96224c8ad0>", "conn": "<starlette.requests.Request object at 0x7f961bca4500>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96224c8ad0>", "conn": "<starlette.requests.Request object at 0x7f961bca4500>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96224c8ad0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96224c8ad0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f96225e1760>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f9620275760>", "request": "<starlette.requests.Request object at 0x7f961bca4650>", "f": "<function get_request_handler.<locals>.app at 0x7f961be5d940>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f9620275760>", "conn": "<starlette.requests.Request object at 0x7f961bca4650>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f9620275760>", "conn": "<starlette.requests.Request object at 0x7f961bca4650>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f962028b880'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f961be5d940>", "request": "<starlette.requests.Request object at 0x7f961bca4650>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961bca4650>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f961bca47a0>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961bca48c0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f9622e5a150>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961bca4650>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f961bca48f0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f9622e5a150>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961bca48c0>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f9620261f40>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f96\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f9620261f40>", "request": "<starlette.requests.Request object at 0x7f961bca4650>", "response": "<starlette.responses.Response object at 0x7f961bca48f0>"}}]}]}
2025-08-18T17:28:40.1570280Z _____________________________ test_ingest_failure ______________________________
2025-08-18T17:28:40.1570515Z 
2025-08-18T17:28:40.1570708Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f961bca66f0>
2025-08-18T17:28:40.1571166Z tmp_path = PosixPath('/tmp/pytest-of-runner/pytest-0/test_ingest_failure0')
2025-08-18T17:28:40.1571454Z 
2025-08-18T17:28:40.1571590Z     def test_ingest_failure(monkeypatch, tmp_path) -> None:
2025-08-18T17:28:40.1572007Z         def bad_import_file(path: str, report_type=None, celery_update=None, force=False):
2025-08-18T17:28:40.1572370Z             raise RuntimeError("boom")
2025-08-18T17:28:40.1572598Z     
2025-08-18T17:28:40.1572847Z         monkeypatch.setattr("etl.load_csv.import_file", bad_import_file)
2025-08-18T17:28:40.1573191Z         client = _get_client(monkeypatch)
2025-08-18T17:28:40.1573478Z         from services.ingest.celery_app import celery_app
2025-08-18T17:28:40.1573742Z     
2025-08-18T17:28:40.1573939Z         celery_app.conf.task_eager_propagates = False
2025-08-18T17:28:40.1574183Z     
2025-08-18T17:28:40.1574347Z         f = tmp_path / "bad.csv"
2025-08-18T17:28:40.1574578Z         f.write_text("a,b\n1,2\n")
2025-08-18T17:28:40.1574791Z     
2025-08-18T17:28:40.1575008Z >       resp = client.post("/ingest", json={"uri": f"file://{f}"})
2025-08-18T17:28:40.1575311Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1575478Z 
2025-08-18T17:28:40.1575579Z tests/api/test_ingest_endpoints.py:77: 
2025-08-18T17:28:40.1575853Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1576447Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:552: in post
2025-08-18T17:28:40.1576913Z     return super().post(
2025-08-18T17:28:40.1577305Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1144: in post
2025-08-18T17:28:40.1577736Z     return self.request(
2025-08-18T17:28:40.1578160Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:40.1578626Z     return super().request(
2025-08-18T17:28:40.1579023Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:40.1579565Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:40.1579906Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1580336Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:40.1580774Z     response = self._send_handling_auth(
2025-08-18T17:28:40.1581254Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:40.1581749Z     response = self._send_handling_redirects(
2025-08-18T17:28:40.1582249Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:40.1582768Z     response = self._send_single_request(request)
2025-08-18T17:28:40.1583171Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1583759Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:40.1584270Z     response = transport.handle_request(request)
2025-08-18T17:28:40.1584532Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1585008Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:40.1585475Z     raise exc
2025-08-18T17:28:40.1585891Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:40.1586596Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:40.1587059Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:40.1587566Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:40.1587897Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1588335Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:40.1588753Z     return self.__get_result()
2025-08-18T17:28:40.1588964Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1589367Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:40.1589809Z     raise self._exception
2025-08-18T17:28:40.1590225Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:40.1590691Z     retval = await retval_or_awaitable
2025-08-18T17:28:40.1590922Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1591364Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:40.1591848Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:40.1592336Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:40.1592846Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1593380Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:40.1593852Z     raise exc
2025-08-18T17:28:40.1594264Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:40.1594760Z     await self.app(scope, receive, _send)
2025-08-18T17:28:40.1595252Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:40.1595789Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:40.1596434Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:40.1597039Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:40.1597638Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1598118Z     raise exc
2025-08-18T17:28:40.1598535Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1599032Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1599481Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:40.1599961Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1600423Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:40.1600875Z     await route.handle(scope, receive, send)
2025-08-18T17:28:40.1601324Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:40.1601917Z     await self.app(scope, receive, send)
2025-08-18T17:28:40.1602453Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:40.1602971Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:40.1603552Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1604025Z     raise exc
2025-08-18T17:28:40.1604444Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1604943Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1605356Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:40.1605791Z     response = await f(request)
2025-08-18T17:28:40.1606191Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1606598Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:40.1607045Z     solved_result = await solve_dependencies(
2025-08-18T17:28:40.1607582Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:40.1608128Z     solved = await call(**solved_result.values)
2025-08-18T17:28:40.1608375Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1608633Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1608834Z 
2025-08-18T17:28:40.1609001Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f961bc74d70>
2025-08-18T17:28:40.1609400Z request = <starlette.requests.Request object at 0x7f961bc871a0>
2025-08-18T17:28:40.1609793Z response = <starlette.responses.Response object at 0x7f961bc87440>
2025-08-18T17:28:40.1610044Z 
2025-08-18T17:28:40.1610190Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:40.1610537Z         if not FastAPILimiter.redis:
2025-08-18T17:28:40.1610908Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:40.1611382Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.1611658Z 
2025-08-18T17:28:40.1611962Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:40.1612493Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:40.1645775Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "3f6a146d8828419f8889659e8f5e9a3a", "level": "error", "timestamp": "2025-08-18T17:27:42.263147Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f961bc86f90>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f962028bb00>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961bcc5080>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f961bc87140>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961bcc5080>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+179", "header_value": "None", "validation_failed": "False", "id_value": "3f6a146d8828419f8889659e8f5e9a3a", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f961bc86c30>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f961bc87050>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f9620261c10>", "conn": "<starlette.requests.Request object at 0x7f961bc87050>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f9620261c10>", "conn": "<starlette.requests.Request object at 0x7f961bc87050>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f9620261c10>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f9620261c10>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function submit_ingest at 0x7f96202763e0>, 'path_params': {}, 'rou\"+70"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/ingest', name='submit_ingest', methods=['POST'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961bcc5620>", "request": "<starlette.requests.Request object at 0x7f961bc871a0>", "f": "<function get_request_handler.<locals>.app at 0x7f9620277420>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961bcc5620>", "conn": "<starlette.requests.Request object at 0x7f961bc871a0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961bcc5620>", "conn": "<starlette.requests.Request object at 0x7f961bc871a0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'POST', 'path': '/ingest', 'ra\"+1523", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f96202759e0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f9620277420>", "request": "<starlette.requests.Request object at 0x7f961bc871a0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961bc871a0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f961bc872f0>", "body": "FormData([])", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961bc87410>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "ModelField(field_info=File(None), name='body', mode='validation')", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96226bd730>", "embed_body_fields": "True", "is_body_form": "True", "is_coroutine": "True", "response_field": "'ModelField(field_info=FieldInfo(annotation=Dict[str, Any], required=True), name='+59", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961bc871a0>", "dependant": "'Dependant(path_params=[], query_params=[ModelField(field_info=Query(None), name='+1227", "body": "FormData([])", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f961bc87440>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96226bd730>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961bc87410>", "embed_body_fields": "True", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f961bc74d70>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f96\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f961bc74d70>", "request": "<starlette.requests.Request object at 0x7f961bc871a0>", "response": "<starlette.responses.Response object at 0x7f961bc87440>"}}]}]}
2025-08-18T17:28:40.1679718Z _____________________________ test_health_endpoint _____________________________
2025-08-18T17:28:40.1679953Z 
2025-08-18T17:28:40.1680150Z monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f961be72ae0>
2025-08-18T17:28:40.1680425Z 
2025-08-18T17:28:40.1680527Z     def test_health_endpoint(monkeypatch):
2025-08-18T17:28:40.1680855Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T17:28:40.1681171Z         client = TestClient(app)
2025-08-18T17:28:40.1681409Z >       r = client.get("/health")
2025-08-18T17:28:40.1681624Z             ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1681769Z 
2025-08-18T17:28:40.1681851Z tests/test_api_fast.py:25: 
2025-08-18T17:28:40.1682100Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1682583Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T17:28:40.1683039Z     return super().get(
2025-08-18T17:28:40.1683439Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T17:28:40.1683868Z     return self.request(
2025-08-18T17:28:40.1684294Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:40.1684755Z     return super().request(
2025-08-18T17:28:40.1685162Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:40.1685692Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:40.1686477Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1686941Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:40.1687392Z     response = self._send_handling_auth(
2025-08-18T17:28:40.1687869Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:40.1688370Z     response = self._send_handling_redirects(
2025-08-18T17:28:40.1688872Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:40.1689385Z     response = self._send_single_request(request)
2025-08-18T17:28:40.1689650Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1690129Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:40.1690645Z     response = transport.handle_request(request)
2025-08-18T17:28:40.1690905Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1691380Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:40.1691848Z     raise exc
2025-08-18T17:28:40.1692254Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:40.1692809Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:40.1693453Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:40.1694110Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:40.1694431Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1694854Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:40.1695281Z     return self.__get_result()
2025-08-18T17:28:40.1695497Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1695897Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:40.1696441Z     raise self._exception
2025-08-18T17:28:40.1696882Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:40.1697363Z     retval = await retval_or_awaitable
2025-08-18T17:28:40.1697599Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1698059Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:40.1698559Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:40.1699040Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:40.1699550Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1700078Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:40.1700557Z     raise exc
2025-08-18T17:28:40.1700973Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:40.1701468Z     await self.app(scope, receive, _send)
2025-08-18T17:28:40.1701962Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:40.1702497Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:40.1703052Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:40.1703652Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:40.1704248Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1704887Z     raise exc
2025-08-18T17:28:40.1705433Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1706105Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1706594Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:40.1707087Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1707555Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:40.1708009Z     await route.handle(scope, receive, send)
2025-08-18T17:28:40.1708456Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:40.1708908Z     await self.app(scope, receive, send)
2025-08-18T17:28:40.1709338Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:40.1709867Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:40.1710486Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1710963Z     raise exc
2025-08-18T17:28:40.1711388Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1711895Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1712330Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:40.1712771Z     response = await f(request)
2025-08-18T17:28:40.1712989Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1713383Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:40.1713839Z     solved_result = await solve_dependencies(
2025-08-18T17:28:40.1714383Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:40.1714930Z     solved = await call(**solved_result.values)
2025-08-18T17:28:40.1715188Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1715451Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1715650Z 
2025-08-18T17:28:40.1715829Z self = <fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>
2025-08-18T17:28:40.1716321Z request = <starlette.requests.Request object at 0x7f961bea42c0>
2025-08-18T17:28:40.1716725Z response = <starlette.responses.Response object at 0x7f961bea6f30>
2025-08-18T17:28:40.1716972Z 
2025-08-18T17:28:40.1717124Z     async def __call__(self, request: Request, response: Response):
2025-08-18T17:28:40.1717440Z         if not FastAPILimiter.redis:
2025-08-18T17:28:40.1717806Z >           raise Exception("You must call FastAPILimiter.init in startup event of fastapi!")
2025-08-18T17:28:40.1718289Z E           Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.1718566Z 
2025-08-18T17:28:40.1718881Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:37: Exception
2025-08-18T17:28:40.1719418Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:40.1752363Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "52848ff1b94a407189af1da007e2a5d6", "level": "error", "timestamp": "2025-08-18T17:27:43.021382Z", "exception": [{"exc_type": "Exception", "exc_value": "You must call FastAPILimiter.init in startup event of fastapi!", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f961bea71d0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f961bec59e0>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961b896a20>", "exc": "Exception('You must call FastAPILimiter.init in startup event of fastapi!')", "request": "<starlette.requests.Request object at 0x7f961bea70b0>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961b896a20>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "52848ff1b94a407189af1da007e2a5d6", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f961bea6c60>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f961bce69c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "conn": "<starlette.requests.Request object at 0x7f961bce69c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "conn": "<starlette.requests.Request object at 0x7f961bce69c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f96229e8cc0>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b8971a0>", "request": "<starlette.requests.Request object at 0x7f961bea42c0>", "f": "<function get_request_handler.<locals>.app at 0x7f9622912f20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b8971a0>", "conn": "<starlette.requests.Request object at 0x7f961bea42c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b8971a0>", "conn": "<starlette.requests.Request object at 0x7f961bea42c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961bf5bc40'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f9622912f20>", "request": "<starlette.requests.Request object at 0x7f961bea42c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961bea42c0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f961bea4d70>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961bea43e0>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96228e5fd0>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961bea42c0>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f961bea6f30>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96228e5fd0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961bea43e0>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f96\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 37, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "request": "<starlette.requests.Request object at 0x7f961bea42c0>", "response": "<starlette.responses.Response object at 0x7f961bea6f30>"}}]}]}
2025-08-18T17:28:40.1788100Z __________________________ test_validation_error_json __________________________
2025-08-18T17:28:40.1788352Z 
2025-08-18T17:28:40.1788559Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T17:28:40.1788940Z disable_decoding = False, timeout = None
2025-08-18T17:28:40.1789151Z 
2025-08-18T17:28:40.1789292Z     async def read_response(
2025-08-18T17:28:40.1789569Z         self,
2025-08-18T17:28:40.1789753Z         disable_decoding: bool = False,
2025-08-18T17:28:40.1790006Z         timeout: Optional[float] = None,
2025-08-18T17:28:40.1790354Z         *,
2025-08-18T17:28:40.1790531Z         disconnect_on_error: bool = True,
2025-08-18T17:28:40.1790786Z         push_request: Optional[bool] = False,
2025-08-18T17:28:40.1791131Z     ):
2025-08-18T17:28:40.1791530Z         """Read the response from a previously sent command"""
2025-08-18T17:28:40.1792159Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T17:28:40.1792671Z         host_error = self._host_error()
2025-08-18T17:28:40.1792957Z         try:
2025-08-18T17:28:40.1793120Z             if (
2025-08-18T17:28:40.1793307Z                 read_timeout is not None
2025-08-18T17:28:40.1793555Z                 and self.protocol in ["3", 3]
2025-08-18T17:28:40.1793805Z                 and not HIREDIS_AVAILABLE
2025-08-18T17:28:40.1794026Z             ):
2025-08-18T17:28:40.1794227Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:40.1794522Z                     response = await self._parser.read_response(
2025-08-18T17:28:40.1794875Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:40.1795186Z                     )
2025-08-18T17:28:40.1795381Z             elif read_timeout is not None:
2025-08-18T17:28:40.1795656Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:40.1796060Z                     response = await self._parser.read_response(
2025-08-18T17:28:40.1796356Z                         disable_decoding=disable_decoding
2025-08-18T17:28:40.1796596Z                     )
2025-08-18T17:28:40.1796846Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T17:28:40.1797176Z                 response = await self._parser.read_response(
2025-08-18T17:28:40.1797512Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:40.1797814Z                 )
2025-08-18T17:28:40.1797983Z             else:
2025-08-18T17:28:40.1798183Z >               response = await self._parser.read_response(
2025-08-18T17:28:40.1798464Z                     disable_decoding=disable_decoding
2025-08-18T17:28:40.1798702Z                 )
2025-08-18T17:28:40.1798800Z 
2025-08-18T17:28:40.1799097Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: 
2025-08-18T17:28:40.1799582Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1800092Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T17:28:40.1800669Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T17:28:40.1801015Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1801499Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T17:28:40.1801986Z     raw = await self._readline()
2025-08-18T17:28:40.1802206Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1802634Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T17:28:40.1803109Z     data = await self._stream.readline()
2025-08-18T17:28:40.1803501Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1803987Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T17:28:40.1804499Z     line = await self.readuntil(sep)
2025-08-18T17:28:40.1805004Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1805482Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T17:28:40.1806220Z     await self._wait_for_data('readuntil')
2025-08-18T17:28:40.1806726Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1807027Z 
2025-08-18T17:28:40.1859744Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=18>>
2025-08-18T17:28:40.1860433Z func_name = 'readuntil'
2025-08-18T17:28:40.1860656Z 
2025-08-18T17:28:40.1860816Z     async def _wait_for_data(self, func_name):
2025-08-18T17:28:40.1861268Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T17:28:40.1861648Z     
2025-08-18T17:28:40.1862380Z         If stream was paused, automatically resume it.
2025-08-18T17:28:40.1863005Z         """
2025-08-18T17:28:40.1863402Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T17:28:40.1864020Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T17:28:40.1864674Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T17:28:40.1865259Z         # which coroutine would get the next data.
2025-08-18T17:28:40.1865699Z         if self._waiter is not None:
2025-08-18T17:28:40.1866320Z             raise RuntimeError(
2025-08-18T17:28:40.1866780Z                 f'{func_name}() called while another coroutine is '
2025-08-18T17:28:40.1867296Z                 f'already waiting for incoming data')
2025-08-18T17:28:40.1867723Z     
2025-08-18T17:28:40.1868070Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T17:28:40.1868518Z     
2025-08-18T17:28:40.1868941Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T17:28:40.1869666Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T17:28:40.1870184Z         if self._paused:
2025-08-18T17:28:40.1870476Z             self._paused = False
2025-08-18T17:28:40.1870735Z             self._transport.resume_reading()
2025-08-18T17:28:40.1870976Z     
2025-08-18T17:28:40.1871155Z         self._waiter = self._loop.create_future()
2025-08-18T17:28:40.1871401Z         try:
2025-08-18T17:28:40.1871576Z >           await self._waiter
2025-08-18T17:28:40.1873005Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T17:28:40.1874394Z 
2025-08-18T17:28:40.1874642Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T17:28:40.1874979Z 
2025-08-18T17:28:40.1875149Z During handling of the above exception, another exception occurred:
2025-08-18T17:28:40.1875406Z 
2025-08-18T17:28:40.1875518Z     def test_validation_error_json() -> None:
2025-08-18T17:28:40.1875809Z         prev_user = os.environ.get("BASIC_USER")
2025-08-18T17:28:40.1876333Z         prev_pass = os.environ.get("BASIC_PASS")
2025-08-18T17:28:40.1876612Z         os.environ["ROI_BASIC_AUTH_USER"] = "u"
2025-08-18T17:28:40.1876900Z         os.environ["ROI_BASIC_AUTH_PASSWORD"] = "p"
2025-08-18T17:28:40.1877176Z         os.environ["BASIC_USER"] = "u"
2025-08-18T17:28:40.1877413Z         os.environ["BASIC_PASS"] = "p"
2025-08-18T17:28:40.1877632Z         try:
2025-08-18T17:28:40.1877809Z             client = TestClient(app)
2025-08-18T17:28:40.1878061Z             auth = base64.b64encode(b"u:p").decode()
2025-08-18T17:28:40.1878326Z >           resp = client.get(
2025-08-18T17:28:40.1878636Z                 "/roi-review?vendor=abc", headers={"Authorization": f"Basic {auth}"}
2025-08-18T17:28:40.1878946Z             )
2025-08-18T17:28:40.1879049Z 
2025-08-18T17:28:40.1879148Z services/api/tests/test_errors_json.py:21: 
2025-08-18T17:28:40.1879426Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1879923Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T17:28:40.1880379Z     return super().get(
2025-08-18T17:28:40.1880764Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T17:28:40.1881184Z     return self.request(
2025-08-18T17:28:40.1881610Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:40.1882073Z     return super().request(
2025-08-18T17:28:40.1882702Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:40.1883341Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:40.1883685Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1884136Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:40.1884571Z     response = self._send_handling_auth(
2025-08-18T17:28:40.1885050Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:40.1885545Z     response = self._send_handling_redirects(
2025-08-18T17:28:40.1886239Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:40.1886782Z     response = self._send_single_request(request)
2025-08-18T17:28:40.1887052Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1887539Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:40.1888051Z     response = transport.handle_request(request)
2025-08-18T17:28:40.1888309Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1888782Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:40.1889253Z     raise exc
2025-08-18T17:28:40.1889663Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:40.1890169Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:40.1890624Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:40.1891132Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:40.1891451Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1891883Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:40.1892306Z     return self.__get_result()
2025-08-18T17:28:40.1892515Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1892916Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:40.1893352Z     raise self._exception
2025-08-18T17:28:40.1893769Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:40.1894243Z     retval = await retval_or_awaitable
2025-08-18T17:28:40.1894477Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1894914Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:40.1895398Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:40.1895877Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:40.1896560Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1897077Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:40.1897551Z     raise exc
2025-08-18T17:28:40.1897967Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:40.1898460Z     await self.app(scope, receive, _send)
2025-08-18T17:28:40.1898952Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:40.1899490Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:40.1900043Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:40.1900631Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:40.1901347Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1901933Z     raise exc
2025-08-18T17:28:40.1902357Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1902848Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1903292Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:40.1903780Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.1904255Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:40.1904702Z     await route.handle(scope, receive, send)
2025-08-18T17:28:40.1905149Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:40.1905607Z     await self.app(scope, receive, send)
2025-08-18T17:28:40.1906212Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:40.1906749Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:40.1907330Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.1907809Z     raise exc
2025-08-18T17:28:40.1908224Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.1908721Z     await app(scope, receive, sender)
2025-08-18T17:28:40.1909153Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:40.1909588Z     response = await f(request)
2025-08-18T17:28:40.1909808Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1910208Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:40.1910709Z     solved_result = await solve_dependencies(
2025-08-18T17:28:40.1911257Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:40.1911807Z     solved = await call(**solved_result.values)
2025-08-18T17:28:40.1912071Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1912526Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T17:28:40.1913004Z     pexpire = await self._check(key)
2025-08-18T17:28:40.1913236Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1913681Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T17:28:40.1914147Z     pexpire = await redis.evalsha(
2025-08-18T17:28:40.1914629Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:646: in execute_command
2025-08-18T17:28:40.1915140Z     return await conn.retry.call_with_retry(
2025-08-18T17:28:40.1915623Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T17:28:40.1916278Z     return await do()
2025-08-18T17:28:40.1916468Z            ^^^^^^^^^^
2025-08-18T17:28:40.1916958Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:620: in _send_command_parse_response
2025-08-18T17:28:40.1917571Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T17:28:40.1917896Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1918394Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:667: in parse_response
2025-08-18T17:28:40.1918904Z     response = await connection.read_response()
2025-08-18T17:28:40.1919159Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1919777Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:582: in read_response
2025-08-18T17:28:40.1920385Z     await self.disconnect(nowait=True)
2025-08-18T17:28:40.1920863Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:438: in disconnect
2025-08-18T17:28:40.1921387Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T17:28:40.1921650Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1921991Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T17:28:40.1922380Z     return self._transport.close()
2025-08-18T17:28:40.1922614Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.1923010Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T17:28:40.1923421Z     super().close()
2025-08-18T17:28:40.1923780Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T17:28:40.1924248Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T17:28:40.1924701Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T17:28:40.1925105Z     self._check_closed()
2025-08-18T17:28:40.1925346Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.1925539Z 
2025-08-18T17:28:40.1925717Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T17:28:40.1926126Z 
2025-08-18T17:28:40.1926212Z     def _check_closed(self):
2025-08-18T17:28:40.1926429Z         if self._closed:
2025-08-18T17:28:40.1926655Z >           raise RuntimeError('Event loop is closed')
2025-08-18T17:28:40.1926939Z E           RuntimeError: Event loop is closed
2025-08-18T17:28:40.1927113Z 
2025-08-18T17:28:40.1927361Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T17:28:40.1927839Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:40.1980895Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "6d70d761d23a4ae5aab0d527e96ac64f", "level": "error", "timestamp": "2025-08-18T17:28:37.689997Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f961bea71d0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f961b807600>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961bab23e0>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f961bca5a60>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961bab23e0>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+150", "header_value": "None", "validation_failed": "False", "id_value": "6d70d761d23a4ae5aab0d527e96ac64f", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f961bea6c60>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f961b91c890>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "conn": "<starlette.requests.Request object at 0x7f961b91c890>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "conn": "<starlette.requests.Request object at 0x7f961b91c890>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function roi_review at 0x7f96229e9940>, 'path_params': {}, 'route'\"+67"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/roi-review', name='roi_review', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b97dbc0>", "request": "<starlette.requests.Request object at 0x7f961b849010>", "f": "<function get_request_handler.<locals>.app at 0x7f9622912340>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b97dbc0>", "conn": "<starlette.requests.Request object at 0x7f961b849010>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b97dbc0>", "conn": "<starlette.requests.Request object at 0x7f961b849010>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/roi-review', \"+1504", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b8044a0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f9622912340>", "request": "<starlette.requests.Request object at 0x7f961b849010>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961b849010>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f961b91c4d0>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961b91c050>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96228e5fd0>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "False", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961b849010>", "dependant": "\"Dependant(path_params=[], query_params=[ModelField(field_info=Query(0), name='ro\"+2305", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f961b91c200>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96228e5fd0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961b91c050>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+462", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "use_path": "/roi-review", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f96\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "request": "<starlette.requests.Request object at 0x7f961b849010>", "response": "<starlette.responses.Response object at 0x7f961b91c200>", "route_index": "8", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f9622910c20>", "callback": "<function http_default_callback at 0x7f96232cdb20>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:8:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "key": "fastapi-limiter:testclient:8:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 646, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f961ba537c0>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f961baa82c0>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f961baa8a40>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 620, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+28", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 667, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 582, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 438, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=18> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=18>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f961badbc40>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f961badbc40>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f961badbc40>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=18>>", "func_name": "readuntil"}}]}]}
2025-08-18T17:28:40.2034570Z ______________________________ test_health_route _______________________________
2025-08-18T17:28:40.2034823Z 
2025-08-18T17:28:40.2035028Z self = <redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>
2025-08-18T17:28:40.2035406Z disable_decoding = False, timeout = None
2025-08-18T17:28:40.2035586Z 
2025-08-18T17:28:40.2035671Z     async def read_response(
2025-08-18T17:28:40.2035880Z         self,
2025-08-18T17:28:40.2036321Z         disable_decoding: bool = False,
2025-08-18T17:28:40.2036584Z         timeout: Optional[float] = None,
2025-08-18T17:28:40.2036814Z         *,
2025-08-18T17:28:40.2036992Z         disconnect_on_error: bool = True,
2025-08-18T17:28:40.2037243Z         push_request: Optional[bool] = False,
2025-08-18T17:28:40.2037480Z     ):
2025-08-18T17:28:40.2037695Z         """Read the response from a previously sent command"""
2025-08-18T17:28:40.2038065Z         read_timeout = timeout if timeout is not None else self.socket_timeout
2025-08-18T17:28:40.2038405Z         host_error = self._host_error()
2025-08-18T17:28:40.2038630Z         try:
2025-08-18T17:28:40.2038794Z             if (
2025-08-18T17:28:40.2038981Z                 read_timeout is not None
2025-08-18T17:28:40.2039236Z                 and self.protocol in ["3", 3]
2025-08-18T17:28:40.2039483Z                 and not HIREDIS_AVAILABLE
2025-08-18T17:28:40.2039701Z             ):
2025-08-18T17:28:40.2039900Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:40.2040201Z                     response = await self._parser.read_response(
2025-08-18T17:28:40.2040547Z                         disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:40.2040857Z                     )
2025-08-18T17:28:40.2041058Z             elif read_timeout is not None:
2025-08-18T17:28:40.2041313Z                 async with async_timeout(read_timeout):
2025-08-18T17:28:40.2041603Z                     response = await self._parser.read_response(
2025-08-18T17:28:40.2041895Z                         disable_decoding=disable_decoding
2025-08-18T17:28:40.2042143Z                     )
2025-08-18T17:28:40.2042393Z             elif self.protocol in ["3", 3] and not HIREDIS_AVAILABLE:
2025-08-18T17:28:40.2042727Z                 response = await self._parser.read_response(
2025-08-18T17:28:40.2043067Z                     disable_decoding=disable_decoding, push_request=push_request
2025-08-18T17:28:40.2043365Z                 )
2025-08-18T17:28:40.2043540Z             else:
2025-08-18T17:28:40.2043750Z >               response = await self._parser.read_response(
2025-08-18T17:28:40.2044030Z                     disable_decoding=disable_decoding
2025-08-18T17:28:40.2044273Z                 )
2025-08-18T17:28:40.2044377Z 
2025-08-18T17:28:40.2044666Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:562: 
2025-08-18T17:28:40.2045151Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.2045655Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:82: in read_response
2025-08-18T17:28:40.2046515Z     response = await self._read_response(disable_decoding=disable_decoding)
2025-08-18T17:28:40.2046973Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2047476Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py:90: in _read_response
2025-08-18T17:28:40.2047963Z     raw = await self._readline()
2025-08-18T17:28:40.2048186Z           ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2048622Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py:219: in _readline
2025-08-18T17:28:40.2049090Z     data = await self._stream.readline()
2025-08-18T17:28:40.2049332Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2049713Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:568: in readline
2025-08-18T17:28:40.2050118Z     line = await self.readuntil(sep)
2025-08-18T17:28:40.2050343Z            ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2050727Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:660: in readuntil
2025-08-18T17:28:40.2051152Z     await self._wait_for_data('readuntil')
2025-08-18T17:28:40.2051427Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.2051627Z 
2025-08-18T17:28:40.2051808Z self = <StreamReader transport=<_SelectorSocketTransport closing fd=20>>
2025-08-18T17:28:40.2052151Z func_name = 'readuntil'
2025-08-18T17:28:40.2052274Z 
2025-08-18T17:28:40.2052379Z     async def _wait_for_data(self, func_name):
2025-08-18T17:28:40.2052664Z         """Wait until feed_data() or feed_eof() is called.
2025-08-18T17:28:40.2052914Z     
2025-08-18T17:28:40.2053111Z         If stream was paused, automatically resume it.
2025-08-18T17:28:40.2053361Z         """
2025-08-18T17:28:40.2053618Z         # StreamReader uses a future to link the protocol feed_data() method
2025-08-18T17:28:40.2054018Z         # to a read coroutine. Running two read coroutines at the same time
2025-08-18T17:28:40.2054407Z         # would have an unexpected behaviour. It would not possible to know
2025-08-18T17:28:40.2054741Z         # which coroutine would get the next data.
2025-08-18T17:28:40.2055003Z         if self._waiter is not None:
2025-08-18T17:28:40.2055237Z             raise RuntimeError(
2025-08-18T17:28:40.2055495Z                 f'{func_name}() called while another coroutine is '
2025-08-18T17:28:40.2055791Z                 f'already waiting for incoming data')
2025-08-18T17:28:40.2056220Z     
2025-08-18T17:28:40.2056425Z         assert not self._eof, '_wait_for_data after EOF'
2025-08-18T17:28:40.2056688Z     
2025-08-18T17:28:40.2056921Z         # Waiting for data while paused will make deadlock, so prevent it.
2025-08-18T17:28:40.2057324Z         # This is essential for readexactly(n) for case when n > self._limit.
2025-08-18T17:28:40.2057638Z         if self._paused:
2025-08-18T17:28:40.2057834Z             self._paused = False
2025-08-18T17:28:40.2058077Z             self._transport.resume_reading()
2025-08-18T17:28:40.2058304Z     
2025-08-18T17:28:40.2058483Z         self._waiter = self._loop.create_future()
2025-08-18T17:28:40.2058726Z         try:
2025-08-18T17:28:40.2058899Z >           await self._waiter
2025-08-18T17:28:40.2060328Z E           RuntimeError: Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop
2025-08-18T17:28:40.2061678Z 
2025-08-18T17:28:40.2061923Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:545: RuntimeError
2025-08-18T17:28:40.2062252Z 
2025-08-18T17:28:40.2062415Z During handling of the above exception, another exception occurred:
2025-08-18T17:28:40.2062804Z 
2025-08-18T17:28:40.2062892Z     def test_health_route() -> None:
2025-08-18T17:28:40.2063263Z         class FakeSession:
2025-08-18T17:28:40.2063475Z             async def execute(self, query):
2025-08-18T17:28:40.2063707Z                 class R:
2025-08-18T17:28:40.2063910Z                     def scalar(self):
2025-08-18T17:28:40.2064142Z                         import datetime
2025-08-18T17:28:40.2064354Z     
2025-08-18T17:28:40.2064543Z                         return datetime.datetime.utcnow()
2025-08-18T17:28:40.2064791Z     
2025-08-18T17:28:40.2064941Z                 return R()
2025-08-18T17:28:40.2065126Z     
2025-08-18T17:28:40.2065289Z         async def fake_get_session():
2025-08-18T17:28:40.2065518Z             yield FakeSession()
2025-08-18T17:28:40.2065722Z     
2025-08-18T17:28:40.2066105Z         app.dependency_overrides[db.get_session] = fake_get_session
2025-08-18T17:28:40.2066453Z         client = TestClient(app)
2025-08-18T17:28:40.2066681Z >       resp = client.get("/health")
2025-08-18T17:28:40.2066907Z                ^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2067051Z 
2025-08-18T17:28:40.2067148Z services/api/tests/test_health.py:23: 
2025-08-18T17:28:40.2067417Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.2067900Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:479: in get
2025-08-18T17:28:40.2068348Z     return super().get(
2025-08-18T17:28:40.2068727Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1053: in get
2025-08-18T17:28:40.2069152Z     return self.request(
2025-08-18T17:28:40.2069590Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:451: in request
2025-08-18T17:28:40.2070053Z     return super().request(
2025-08-18T17:28:40.2070453Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:825: in request
2025-08-18T17:28:40.2070988Z     return self.send(request, auth=auth, follow_redirects=follow_redirects)
2025-08-18T17:28:40.2071345Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2071773Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:914: in send
2025-08-18T17:28:40.2072209Z     response = self._send_handling_auth(
2025-08-18T17:28:40.2072684Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:942: in _send_handling_auth
2025-08-18T17:28:40.2073178Z     response = self._send_handling_redirects(
2025-08-18T17:28:40.2073677Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:979: in _send_handling_redirects
2025-08-18T17:28:40.2074199Z     response = self._send_single_request(request)
2025-08-18T17:28:40.2074465Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2074934Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/httpx/_client.py:1014: in _send_single_request
2025-08-18T17:28:40.2075449Z     response = transport.handle_request(request)
2025-08-18T17:28:40.2075719Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2076388Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:354: in handle_request
2025-08-18T17:28:40.2076862Z     raise exc
2025-08-18T17:28:40.2077275Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/testclient.py:351: in handle_request
2025-08-18T17:28:40.2077776Z     portal.call(self.app, scope, receive, send)
2025-08-18T17:28:40.2078223Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:291: in call
2025-08-18T17:28:40.2078736Z     return cast(T_Retval, self.start_task_soon(func, *args).result())
2025-08-18T17:28:40.2079053Z                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2079475Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:456: in result
2025-08-18T17:28:40.2080048Z     return self.__get_result()
2025-08-18T17:28:40.2080362Z            ^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2080768Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
2025-08-18T17:28:40.2081210Z     raise self._exception
2025-08-18T17:28:40.2081628Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222: in _call_func
2025-08-18T17:28:40.2082098Z     retval = await retval_or_awaitable
2025-08-18T17:28:40.2082331Z              ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2082769Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/applications.py:1054: in __call__
2025-08-18T17:28:40.2083258Z     await super().__call__(scope, receive, send)
2025-08-18T17:28:40.2083742Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/applications.py:113: in __call__
2025-08-18T17:28:40.2084248Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.2084767Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:186: in __call__
2025-08-18T17:28:40.2085246Z     raise exc
2025-08-18T17:28:40.2085666Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py:164: in __call__
2025-08-18T17:28:40.2086268Z     await self.app(scope, receive, _send)
2025-08-18T17:28:40.2086764Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py:90: in __call__
2025-08-18T17:28:40.2087310Z     await self.app(scope, receive, handle_outgoing_request)
2025-08-18T17:28:40.2087858Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py:63: in __call__
2025-08-18T17:28:40.2088456Z     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
2025-08-18T17:28:40.2089050Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.2089534Z     raise exc
2025-08-18T17:28:40.2089963Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.2090457Z     await app(scope, receive, sender)
2025-08-18T17:28:40.2090902Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:716: in __call__
2025-08-18T17:28:40.2091393Z     await self.middleware_stack(scope, receive, send)
2025-08-18T17:28:40.2091856Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:736: in app
2025-08-18T17:28:40.2092308Z     await route.handle(scope, receive, send)
2025-08-18T17:28:40.2092760Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:290: in handle
2025-08-18T17:28:40.2093211Z     await self.app(scope, receive, send)
2025-08-18T17:28:40.2093634Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:78: in app
2025-08-18T17:28:40.2094159Z     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
2025-08-18T17:28:40.2094746Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:53: in wrapped_app
2025-08-18T17:28:40.2095228Z     raise exc
2025-08-18T17:28:40.2095657Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py:42: in wrapped_app
2025-08-18T17:28:40.2096355Z     await app(scope, receive, sender)
2025-08-18T17:28:40.2096791Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py:75: in app
2025-08-18T17:28:40.2097226Z     response = await f(request)
2025-08-18T17:28:40.2097439Z                ^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2097833Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py:292: in app
2025-08-18T17:28:40.2098283Z     solved_result = await solve_dependencies(
2025-08-18T17:28:40.2098962Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py:638: in solve_dependencies
2025-08-18T17:28:40.2099616Z     solved = await call(**solved_result.values)
2025-08-18T17:28:40.2099875Z              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2100330Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:54: in __call__
2025-08-18T17:28:40.2100808Z     pexpire = await self._check(key)
2025-08-18T17:28:40.2101036Z               ^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2101469Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py:30: in _check
2025-08-18T17:28:40.2101938Z     pexpire = await redis.evalsha(
2025-08-18T17:28:40.2102416Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:646: in execute_command
2025-08-18T17:28:40.2102918Z     return await conn.retry.call_with_retry(
2025-08-18T17:28:40.2103400Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py:59: in call_with_retry
2025-08-18T17:28:40.2103882Z     return await do()
2025-08-18T17:28:40.2104067Z            ^^^^^^^^^^
2025-08-18T17:28:40.2104549Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:620: in _send_command_parse_response
2025-08-18T17:28:40.2105165Z     return await self.parse_response(conn, command_name, **options)
2025-08-18T17:28:40.2105486Z            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2106078Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py:667: in parse_response
2025-08-18T17:28:40.2106590Z     response = await connection.read_response()
2025-08-18T17:28:40.2106851Z                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2107338Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:582: in read_response
2025-08-18T17:28:40.2107846Z     await self.disconnect(nowait=True)
2025-08-18T17:28:40.2108319Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py:438: in disconnect
2025-08-18T17:28:40.2108845Z     self._writer.close()  # type: ignore[union-attr]
2025-08-18T17:28:40.2109108Z     ^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2109449Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py:358: in close
2025-08-18T17:28:40.2109842Z     return self._transport.close()
2025-08-18T17:28:40.2110069Z            ^^^^^^^^^^^^^^^^^^^^^^^
2025-08-18T17:28:40.2110490Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:1213: in close
2025-08-18T17:28:40.2110893Z     super().close()
2025-08-18T17:28:40.2111250Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py:875: in close
2025-08-18T17:28:40.2111712Z     self._loop.call_soon(self._call_connection_lost, None)
2025-08-18T17:28:40.2112156Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:799: in call_soon
2025-08-18T17:28:40.2112566Z     self._check_closed()
2025-08-18T17:28:40.2112807Z _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
2025-08-18T17:28:40.2113002Z 
2025-08-18T17:28:40.2113180Z self = <_UnixSelectorEventLoop running=False closed=True debug=False>
2025-08-18T17:28:40.2113431Z 
2025-08-18T17:28:40.2113510Z     def _check_closed(self):
2025-08-18T17:28:40.2113722Z         if self._closed:
2025-08-18T17:28:40.2113952Z >           raise RuntimeError('Event loop is closed')
2025-08-18T17:28:40.2114230Z E           RuntimeError: Event loop is closed
2025-08-18T17:28:40.2114410Z 
2025-08-18T17:28:40.2114658Z /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py:545: RuntimeError
2025-08-18T17:28:40.2115137Z ------------------------------ Captured log call -------------------------------
2025-08-18T17:28:40.5982183Z ERROR    services.api.errors:errors.py:48 {"event": "unhandled_error", "request_id": "f98c73ec97ca49fda8b72a56d66a15e4", "level": "error", "timestamp": "2025-08-18T17:28:38.391506Z", "exception": [{"exc_type": "RuntimeError", "exc_value": "Event loop is closed", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/errors.py", "lineno": 164, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.errors.ServerErrorMiddleware object at 0x7f961bea71d0>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "<function _TestClientTransport.handle_request.<locals>.send at 0x7f961b97f420>", "_send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961b97f560>", "exc": "RuntimeError('Event loop is closed')", "request": "<starlette.requests.Request object at 0x7f961b968560>", "response_started": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/middleware.py", "lineno": 90, "name": "__call__", "line": "", "locals": {"self": "'CorrelationIdMiddleware(app=<starlette.middleware.exceptions.ExceptionMiddleware'+286", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "<function ServerErrorMiddleware.__call__.<locals>._send at 0x7f961b97f560>", "headers": "\"MutableHeaders({'host': 'testserver', 'accept': '*/*', 'accept-encoding': 'gzip,\"+119", "header_value": "None", "validation_failed": "False", "id_value": "f98c73ec97ca49fda8b72a56d66a15e4", "handle_outgoing_request": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/middleware/exceptions.py", "lineno": 63, "name": "__call__", "line": "", "locals": {"self": "<starlette.middleware.exceptions.ExceptionMiddleware object at 0x7f961bea6c60>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "conn": "<starlette.requests.Request object at 0x7f961b9683b0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "conn": "<starlette.requests.Request object at 0x7f961b9683b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function CorrelationIdMiddleware.__call__.<locals>.handle_outgoing_request at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "conn": "<starlette.requests.Request object at 0x7f961b9683b0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 716, "name": "__call__", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 736, "name": "app", "line": "", "locals": {"self": "<fastapi.routing.APIRouter object at 0x7f96228e5f70>", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "partial": "None", "route": "APIRoute(path='/health', name='health', methods=['GET'])", "match": "<Match.FULL: 2>", "child_scope": "\"{'endpoint': <function health at 0x7f96229e8cc0>, 'path_params': {}, 'route': AP\"+55"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 290, "name": "handle", "line": "", "locals": {"self": "APIRoute(path='/health', name='health', methods=['GET'])", "scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 78, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b97f7e0>", "request": "<starlette.requests.Request object at 0x7f961b9685c0>", "f": "<function get_request_handler.<locals>.app at 0x7f9622912f20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 53, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b97f7e0>", "conn": "<starlette.requests.Request object at 0x7f961b9685c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/_exception_handler.py", "lineno": 42, "name": "wrapped_app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "sender": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "handler": "None", "response_started": "False", "app": "<function request_response.<locals>.app.<locals>.app at 0x7f961b97f7e0>", "conn": "<starlette.requests.Request object at 0x7f961b9685c0>", "exception_handlers": "\"{<class 'starlette.exceptions.HTTPException'>: <function install_exception_handl\"+642", "status_handlers": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/starlette/routing.py", "lineno": 75, "name": "app", "line": "", "locals": {"scope": "\"{'type': 'http', 'http_version': '1.1', 'method': 'GET', 'path': '/health', 'raw\"+1439", "receive": "'<function _TestClientTransport.handle_request.<locals>.receive at 0x7f961b97eac0'+1", "send": "'<function wrap_app_handling_exceptions.<locals>.wrapped_app.<locals>.sender at 0'+14", "f": "<function get_request_handler.<locals>.app at 0x7f9622912f20>", "request": "<starlette.requests.Request object at 0x7f961b9685c0>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/routing.py", "lineno": 292, "name": "app", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961b9685c0>", "response": "None", "file_stack": "<contextlib.AsyncExitStack object at 0x7f961b968740>", "body": "None", "errors": "[]", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961b968770>", "actual_response_class": "<class 'starlette.responses.JSONResponse'>", "body_field": "None", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96228e5fd0>", "embed_body_fields": "False", "is_body_form": "None", "is_coroutine": "True", "response_field": "None", "response_model_by_alias": "True", "response_model_exclude": "None", "response_model_exclude_defaults": "False", "response_model_exclude_none": "False", "response_model_exclude_unset": "False", "response_model_include": "None", "status_code": "None"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi/dependencies/utils.py", "lineno": 638, "name": "solve_dependencies", "line": "", "locals": {"request": "<starlette.requests.Request object at 0x7f961b9685c0>", "dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+1423", "body": "None", "background_tasks": "None", "response": "<starlette.responses.Response object at 0x7f961b9687d0>", "dependency_overrides_provider": "<fastapi.applications.FastAPI object at 0x7f96228e5fd0>", "dependency_cache": "{}", "async_exit_stack": "<contextlib.AsyncExitStack object at 0x7f961b968770>", "embed_body_fields": "False", "values": "{}", "errors": "[]", "sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "use_sub_dependant": "'Dependant(path_params=[], query_params=[], header_params=[], cookie_params=[], b'+458", "original_call": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "use_path": "/health", "solved_result": "\"SolvedDependency(values={'request': <starlette.requests.Request object at 0x7f96\"+201"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 54, "name": "__call__", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "request": "<starlette.requests.Request object at 0x7f961b9685c0>", "response": "<starlette.responses.Response object at 0x7f961b9687d0>", "route_index": "13", "dep_index": "0", "i": "14", "route": "APIRoute(path='/score', name='score', methods=['POST'])", "j": "0", "dependency": "Depends(RateLimiter)", "identifier": "<function client_ip_identifier at 0x7f9622910c20>", "callback": "<function http_default_callback at 0x7f96232cdb20>", "rate_key": "testclient", "key": "fastapi-limiter:testclient:13:0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/fastapi_limiter/depends.py", "lineno": 30, "name": "_check", "line": "", "locals": {"self": "<fastapi_limiter.depends.RateLimiter object at 0x7f96229241d0>", "key": "fastapi-limiter:testclient:13:0", "redis": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 646, "name": "execute_command", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}", "pool": "'<redis.asyncio.connection.ConnectionPool(<redis.asyncio.connection.Connection(ho'+31", "command_name": "EVALSHA", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/retry.py", "lineno": 59, "name": "call_with_retry", "line": "", "locals": {"self": "<redis.asyncio.retry.Retry object at 0x7f961ba537c0>", "do": "<function Redis.execute_command.<locals>.<lambda> at 0x7f961b97ff60>", "fail": "<function Redis.execute_command.<locals>.<lambda> at 0x7f961bab3920>", "failures": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 620, "name": "_send_command_parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "conn": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "args": "\"('EVALSHA', 'a3f9e982197e9e887f6b5dcb7ec273863bb83aad', 1, 'fastapi-limiter:test\"+29", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/client.py", "lineno": 667, "name": "parse_response", "line": "", "locals": {"self": "'<redis.asyncio.client.Redis(<redis.asyncio.connection.ConnectionPool(<redis.asyn'+61", "connection": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "command_name": "EVALSHA", "options": "{}"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 582, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 438, "name": "disconnect", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "nowait": "True"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 358, "name": "close", "line": "", "locals": {"self": "'<StreamWriter transport=<_SelectorSocketTransport closing fd=20> reader=<StreamR'+58"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 1213, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=20>", "__class__": "<class 'asyncio.selector_events._SelectorSocketTransport'>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/selector_events.py", "lineno": 875, "name": "close", "line": "", "locals": {"self": "<_SelectorSocketTransport closing fd=20>"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 799, "name": "call_soon", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>", "callback": "'<bound method _SelectorSocketTransport._call_connection_lost of <_SelectorSocket'+25", "context": "None", "args": "(None,)"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/base_events.py", "lineno": 545, "name": "_check_closed", "line": "", "locals": {"self": "<_UnixSelectorEventLoop running=False closed=True debug=False>"}}]}, {"exc_type": "RuntimeError", "exc_value": "Task <Task pending name='anyio.from_thread.BlockingPortal._call_func' coro=<BlockingPortal._call_func() running at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/from_thread.py:222> cb=[TaskGroup._spawn.<locals>.task_done() at /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/anyio/_backends/_asyncio.py:794]> got Future <Future pending> attached to a different loop", "syntax_error": null, "is_cause": false, "frames": [{"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/asyncio/connection.py", "lineno": 562, "name": "read_response", "line": "", "locals": {"self": "<redis.asyncio.connection.Connection(host=localhost,port=6379,db=0)>", "disable_decoding": "False", "timeout": "None", "disconnect_on_error": "True", "push_request": "False", "read_timeout": "None", "host_error": "localhost:6379"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 82, "name": "read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f961badbc40>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/resp2.py", "lineno": 90, "name": "_read_response", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f961badbc40>", "disable_decoding": "False"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/redis/_parsers/base.py", "lineno": 219, "name": "_readline", "line": "", "locals": {"self": "<redis._parsers.resp2._AsyncRESP2Parser object at 0x7f961badbc40>", "found": "-1", "tail": "b''"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 568, "name": "readline", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=20>>", "sep": "b'\\n'", "seplen": "1"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 660, "name": "readuntil", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=20>>", "separator": "b'\\n'", "seplen": "1", "offset": "0", "buflen": "0"}}, {"filename": "/opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/asyncio/streams.py", "lineno": 545, "name": "_wait_for_data", "line": "", "locals": {"self": "<StreamReader transport=<_SelectorSocketTransport closing fd=20>>", "func_name": "readuntil"}}]}]}
2025-08-18T17:28:40.6035734Z =============================== warnings summary ===============================
2025-08-18T17:28:40.6036135Z services/alert_bot/tests/test_smoke.py:5
2025-08-18T17:28:40.6037276Z   /home/runner/work/AWA-App/AWA-App/services/alert_bot/tests/test_smoke.py:5: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
2025-08-18T17:28:40.6038388Z     import pkg_resources  # noqa: F401
2025-08-18T17:28:40.6038562Z 
2025-08-18T17:28:40.6038674Z tests/api/test_ingest_endpoints.py: 3 warnings
2025-08-18T17:28:40.6038960Z tests/ingest/test_tasks_eager.py: 3 warnings
2025-08-18T17:28:40.6039216Z tests/test_api_fast.py: 1 warning
2025-08-18T17:28:40.6039449Z tests/test_health.py: 5 warnings
2025-08-18T17:28:40.6039676Z tests/test_smoke.py: 5 warnings
2025-08-18T17:28:40.6039911Z services/api/tests/test_cors.py: 1 warning
2025-08-18T17:28:40.6040198Z services/api/tests/test_errors_json.py: 2 warnings
2025-08-18T17:28:40.6040498Z services/api/tests/test_health.py: 1 warning
2025-08-18T17:28:40.6040788Z services/api/tests/test_rate_limit.py: 122 warnings
2025-08-18T17:28:40.6042277Z   /opt/hostedtoolcache/Python/3.12.11/x64/lib/python3.12/site-packages/asgi_correlation_id/extensions/sentry.py:27: DeprecationWarning: sentry_sdk.configure_scope is deprecated and will be removed in the next major version. Please consult our migration guide to learn how to migrate to the new API: https://docs.sentry.io/platforms/python/migration/1.x-to-2.x#scope-configuring
2025-08-18T17:28:40.6043667Z     with configure_scope() as scope:
2025-08-18T17:28:40.6043838Z 
2025-08-18T17:28:40.6043973Z tests/test_health.py::test_health[0]
2025-08-18T17:28:40.6044217Z tests/test_health.py::test_health[1]
2025-08-18T17:28:40.6044453Z tests/test_health.py::test_health[2]
2025-08-18T17:28:40.6044693Z tests/test_health.py::test_health[3]
2025-08-18T17:28:40.6044987Z tests/test_health.py::test_health[4]
2025-08-18T17:28:40.6046059Z   /home/runner/work/AWA-App/AWA-App/tests/test_health.py:22: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:40.6047087Z     return datetime.datetime.utcnow()
2025-08-18T17:28:40.6047262Z 
2025-08-18T17:28:40.6047347Z tests/test_health.py: 5 warnings
2025-08-18T17:28:40.6047578Z tests/test_smoke.py: 5 warnings
2025-08-18T17:28:40.6047810Z services/api/tests/test_cors.py: 1 warning
2025-08-18T17:28:40.6048097Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T17:28:40.6049097Z   /home/runner/work/AWA-App/AWA-App/services/api/routes/health.py:24: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:40.6050124Z     app_now = datetime.utcnow().replace(tzinfo=timezone.utc)
2025-08-18T17:28:40.6050341Z 
2025-08-18T17:28:40.6050439Z tests/test_smoke.py::test_health[0]
2025-08-18T17:28:40.6050681Z tests/test_smoke.py::test_health[1]
2025-08-18T17:28:40.6050918Z tests/test_smoke.py::test_health[2]
2025-08-18T17:28:40.6051144Z tests/test_smoke.py::test_health[3]
2025-08-18T17:28:40.6051370Z tests/test_smoke.py::test_health[4]
2025-08-18T17:28:40.6052291Z   /home/runner/work/AWA-App/AWA-App/tests/test_smoke.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:40.6053223Z     return datetime.datetime.utcnow()
2025-08-18T17:28:40.6053390Z 
2025-08-18T17:28:40.6053552Z services/api/tests/test_cors.py::test_cors_simple_get_allowed
2025-08-18T17:28:40.6054585Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_cors.py:27: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:40.6055563Z     return datetime.datetime.utcnow()
2025-08-18T17:28:40.6055735Z 
2025-08-18T17:28:40.6055848Z services/api/tests/test_rate_limit.py: 102 warnings
2025-08-18T17:28:40.6056972Z   /home/runner/work/AWA-App/AWA-App/services/api/tests/test_rate_limit.py:33: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
2025-08-18T17:28:40.6057961Z     return datetime.datetime.utcnow()
2025-08-18T17:28:40.6058125Z 
2025-08-18T17:28:40.6058302Z -- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
2025-08-18T17:28:40.6058693Z ================================ tests coverage ================================
2025-08-18T17:28:40.6059057Z _______________ coverage: platform linux, python 3.12.11-final-0 _______________
2025-08-18T17:28:40.6059306Z 
2025-08-18T17:28:40.6059403Z Coverage XML written to file coverage.xml
2025-08-18T17:28:40.6059721Z Required test coverage of 45% reached. Total coverage: 62.43%
2025-08-18T17:28:40.6060211Z =========================== short test summary info ============================
2025-08-18T17:28:40.6060941Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_file_upload - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.6061783Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_json_uri - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.6062612Z FAILED tests/api/test_ingest_endpoints.py::test_ingest_failure - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.6063396Z FAILED tests/test_api_fast.py::test_health_endpoint - Exception: You must call FastAPILimiter.init in startup event of fastapi!
2025-08-18T17:28:40.6064108Z FAILED services/api/tests/test_errors_json.py::test_validation_error_json - RuntimeError: Event loop is closed
2025-08-18T17:28:40.6064729Z FAILED services/api/tests/test_health.py::test_health_route - RuntimeError: Event loop is closed
2025-08-18T17:28:40.9930050Z ##[error]Process completed with exit code 1.
