services:
  postgres:
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pass # pragma: allowlist secret
      TZ: UTC
    command: ["postgres", "-c", "timezone=UTC"]
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
      args:
        TZ_CACHE_BUST: ${GITHUB_SHA:-dev}
    environment:
      TZ: UTC
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-pass}
      POSTGRES_DB: ${POSTGRES_DB:-awa}
      PORT: ${PORT:-8000}
  web:
    build: ./web
    ports: ["3000:80"]
    depends_on: [api]
  webapp:
    profiles: ["webapp"]
    build:
      context: .
      dockerfile: webapp/Dockerfile
    command: npm run dev
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_APP_ENV: ${APP_ENV:-local}
    env_file:
      - webapp/.env.local
    depends_on:
      - api
